/*!
* xRTML JavaScript Library 1.5
* http://xrtml.org/
*
* Copyright 2011-2012, IBT, SA
*
* xRTML is part of our framework and it's powered by the world's first Real-Time Web Platform by IBT
*
* Join our movement to transform the World Wide Web into the Real-Time Web!
*
* Interested in Real-Time technology? See what we can do for your business today.
* 
* Transform your old website into an exciting Real-Time experience!
* 
* Improve the interaction with your visitor to a level never seen before
* and increase visitor recurrency and loyalty.
*
* Visit us at www.ibt.co and learn more.
*/
var Events={};Events.Listener=function(target,event,callback){this.target=target;this.callback=callback;this.event=event};Events.Listener.prototype={callback:function(evt,data){},event:null,target:null,constructor:Events.Listener};Events.Provider=function(target){this.listeners={};if(!target.listeners){}target.listeners=this.listeners;target.addEventListener=this.addEventListener;target.removeEventListener=this.removeEventListener;target.resetEventListener=this.resetEventListener;target.dispatchEvent=this.dispatchEvent};Events.Provider.prototype={constructor:Events.Provider,addEventListener:function(type,listener){if(!this.listeners[type]){this.listeners[type]=[]}this.listeners[type].push(listener)},removeEventListener:function(type,listener){if(this.listeners[type] instanceof Array){var listeners=this.listeners[type];for(var i=0,len=listeners.length;i<len;i++){if(listeners[i]===listener){listeners.splice(i,1);break}}}},resetEventListener:function(type){if(this.listeners[type] instanceof Array){this.listeners[type]=[]}},dispatchEvent:function(type,data){if(!type){throw new Error("Event object missing 'type' property.")}var event={type:type,target:this};for(var key in data){var obj=data[key];event[key]=obj}if(this.listeners[event.type] instanceof Array){var listeners=this.listeners[event.type];var result;for(var i=0,len=listeners.length;i<len;i++){var listener=listeners[i];listeners[i].call(this,event);if(typeof(result)!=="undefined"&&result!==null){this.result=result}}}}};Events.Manager={addEventListener:function(element,type,callback){if(element.addEventListener){element.addEventListener(type,callback,false)}else{if(element.attachEvent){element.attachEvent("on"+type,callback)}else{element[type]=callback}}},removeEventListener:function(element,type,listener,useCapture){if(element.removeEventListener){if(!useCapture){useCapture=false}element.removeEventListener(type,listener,useCapture)}else{if(element.detachEvent){element.detachEvent("on"+type,listener);listener.delegate=null}}return this}};window.xRTML=(function(){var ConnectionManager=(function(){var xmlns="xrtml";var instance=(function(){var connections={},self=this,clientFactory=(function(){var factories={};var BaseFactory=function(factoryName){new Events.Provider(this);var name=factoryName,factory=null,self=this,pendingRequests=[],isLoaded=function(){return null!=factory},onLoadOrtcFactory=function(ortcFactory,error){if(error!=null){var errorMessage=name+" factory load error: "+error.code+" : "+error.message;xRTML.Console.error(errorMessage)}else{xRTML.Console.debug(name+" factory load successful.");factory=ortcFactory;if(pendingRequests.length!=0){for(var i=0;i<pendingRequests.length;++i){self.createClient(pendingRequests[i])}pendingRequests=[]}}};this.createClient=function(request){if(isLoaded()){var ortcClient=factory.createClient();request.callback({client:ortcClient});return ortcClient}else{loadOrtcFactory(name,onLoadOrtcFactory);pendingRequests.push(request)}}};factories.IbtRealTimeS=new BaseFactory("IbtRealTimeS");factories.IbtRealTimeK=new BaseFactory("IbtRealTimeK");factories.IbtRealTimeSJ=new BaseFactory("IbtRealTimeSJ");var create=function(clientType,request){var gateway=factories[clientType];gateway.createClient(request)};return{create:create}})();var createConnection=function(connectionJSON){var connection=new xRTML.Tags.Connection(connectionJSON);this.dispatchEvent("onConnectionCreated",{connection:connection});connections[connection.internalId]=connection;connection.addEventListener("onXrtmlMessage",function(e){instance.dispatchEvent("onXrtmlMessage",e)});if((typeof connection.authenticate=="undefined")||connection.authenticate){xRTML.Console.debug("Connection "+(connection.id||connection.internalId)+" authenticating...");connection.addEventListener("onAuthenticated",function(e){if(e.isAuthenticated){var c=e.connection;clientFactory.create(c.serverType,{id:c.internalId,callback:c.onClientCreated})}});connection.authenticateConnection()}else{clientFactory.create(connection.serverType,{id:connection.internalId,callback:connection.onClientCreated})}};var sendMessage=function(channelName,message){for(var name in connections){connections[name].send(channelName,message)}};var loadConnections=function(){var connectionTags=xRTML.Common.DOM.getElementsByTagName(document.documentElement,"xrtml:connection");for(var i=0;i<connectionTags.length;i++){var connectionElem=connectionTags[i],connectionJSON={name:"Connection",id:connectionElem.getAttribute("id"),active:connectionElem.getAttribute("active"),authenticate:connectionElem.getAttribute("authenticate"),sendretries:connectionElem.getAttribute("sendretries"),sendinterval:connectionElem.getAttribute("sendinterval"),url:connectionElem.getAttribute("url"),authenticationurl:connectionElem.getAttribute("authenticationurl"),servertype:connectionElem.getAttribute("servertype"),timeout:connectionElem.getAttribute("timeout"),connectattempts:connectionElem.getAttribute("connectattempts"),metadata:connectionElem.getAttribute("metadata"),appkey:connectionElem.getAttribute("appkey"),authtoken:connectionElem.getAttribute("authtoken"),channels:(function(){var channelTags=xRTML.Common.DOM.getElementsByTagName(connectionElem,"xrtml:channels")[0].children,channels=[];for(var i=0;i<channelTags.length;++i){var channelTag=channelTags[i];channels.push({name:channelTag.getAttribute("name"),permission:channelTag.getAttribute("permission")||"w",subscribeonreconnect:channelTag.getAttribute("subscribeonreconnect")?xRTML.Common.Converter.toBoolean(channelTag.getAttribute("subscribeonreconnect")):true,subscribe:channelTag.getAttribute("subscribe")?xRTML.Common.Converter.toBoolean(channelTag.getAttribute("subscribe")):true,onmessage:channelTag.getAttribute("onmessage")?new Function("event","return "+channelTag.getAttribute("onmessage")+"(event);"):null,messageadapter:channelTag.getAttribute("messageadapter")?new Function("message","return "+channelTag.getAttribute("messageadapter")+"(message);"):null})}return channels})(),oncreated:connectionElem.getAttribute("oncreated")?new Function("event","return "+connectionElem.getAttribute("oncreated")+"(event);"):null,onconnected:connectionElem.getAttribute("onconnected")?new Function("event","return "+connectionElem.getAttribute("onconnected")+"(event);"):null,ondisconnected:connectionElem.getAttribute("ondisconnected")?new Function("event","return "+connectionElem.getAttribute("ondisconnected")+"(event);"):null,onsubscribed:connectionElem.getAttribute("onsubscribed")?new Function("event","channel","return "+connectionElem.getAttribute("onsubscribed")+"(event);"):null,onunsubscribed:connectionElem.getAttribute("onunsubscribed")?new Function("event","channel","return "+connectionElem.getAttribute("onunsubscribed")+"(event);"):null,onexception:connectionElem.getAttribute("onexception")?new Function("event","event","return "+connectionElem.getAttribute("onexception")+"(event);"):null,onreconnected:connectionElem.getAttribute("onreconnected")?new Function("event","return "+connectionElem.getAttribute("onreconnected")+"(event);"):null,onreconnecting:connectionElem.getAttribute("onreconnecting")?new Function("event","return "+connectionElem.getAttribute("onreconnecting")+"(event);"):null,onmessage:connectionElem.getAttribute("onmessage")?new Function("event","return "+connectionElem.getAttribute("onmessage")+"(event);"):null,messageadapter:connectionElem.getAttribute("messageadapter")?new Function("message","return "+connectionElem.getAttribute("messageadapter")+"(message);"):null};this.createConnection(connectionJSON)}};var getConnectionByInternalId=function(internalId){return connections[internalId]};var getConnectionById=function(id){for(var key in connections){if(connections[key].id===id){return connections[key]}}return null};var addConnectionChannel=function(connectionId,channel){var connection=getConnectionByInternalId(connectionId);if(connection===null){connection=getConnectionById(connectionId);if(connection===null){throw xRTML.Console.error("Connection with "+connectionId+" not found")}}connection.addChannel(channel)};return{createConnection:createConnection,sendMessage:sendMessage,loadConnections:loadConnections,getConnectionByInternalId:getConnectionByInternalId,getConnectionById:getConnectionById,addConnectionChannel:addConnectionChannel}})();new Events.Provider(instance);ConnectionManager=function(){return instance};return ConnectionManager()})();var TagManager=(function(){var instance=(function(){var tags=[],xmlns="xrtml",tagInstances={},instantiate=function(tagObject){return new xRTML.Tags[tagObject.name](tagObject)},xrtmlElementToObject=function(node){var tagObject={};for(var i=0,len=node.attributes.length;i<len;i++){var att=node.attributes[i];tagObject[att.name.toLowerCase()]=node.getAttribute(att.name)}var childTags=xRTML.Common.DOM.getDirectXRTMLChildrenElements(node);if(childTags.length>0){for(var i=0,len=childTags.length;i<len;i++){var firstLevelNode=childTags[i],firstLevelNodeName=firstLevelNode.nodeName.toLowerCase().replace("xrtml:",""),secondLevelNodes=xRTML.Common.DOM.getXRTMLCollectionTagChildren(firstLevelNode);if(secondLevelNodes.length>0){if(!tagObject[firstLevelNodeName]){tagObject[firstLevelNodeName]=[]}for(var it=0,leng=secondLevelNodes.length;it<leng;it++){var secondLevelNode=secondLevelNodes[it],secondLevelNodeName=secondLevelNode.nodeName.toLowerCase().replace("xrtml:","");tagObject[firstLevelNodeName].push(xrtmlElementToObject(secondLevelNode))}}else{tagObject[firstLevelNodeName]=xrtmlElementToObject(firstLevelNode)}}}else{if(node.innerHTML&&node.innerHTML.trim()!=""){tagObject.content=node.innerHTML}}return tagObject},loadTags=function(){if(tags.length!=0){xRTML.Console.debug("Loading tags... ");var domTags=[],i,j,tagObject;for(i=0;i<tags.length;++i){var tagName=tags[i];domTags=xRTML.Common.DOM.getElementsByTagName(document.body,xmlns+":"+tagName.toLowerCase());for(j=0;j<domTags.length;++j){tagObject=xrtmlElementToObject(domTags[j]);tagObject.name=tagName;this.createTag(tagObject)}}xRTML.Console.debug("Loading tags finished.")}else{xRTML.Console.debug("No tags registered.")}},registerTag=function(tagName){tags.push(tagName)},createTag=function(tagObject){try{for(var prop in tagObject){if(prop.match(/[A-Z]/)){tagObject[prop.toLowerCase()]=tagObject[prop];delete tagObject[prop]}}var xrtmlTag=instantiate(tagObject);xrtmlTag.addEventListener("dispose",function(e){var tagInternalId=e.tag.internalId,disposedTag=tagInstances[tagInternalId];tagInstances[tagInternalId]=null;delete tagInstances[tagInternalId];TagManager.dispatchEvent("onTagDisposed",{tag:e.tag})});tagInstances[xrtmlTag.internalId]=xrtmlTag;this.dispatchEvent("onTagCreated",{name:tagObject.name,tag:xrtmlTag});return xrtmlTag}catch(err){xRTML.ErrorHandler().tagError(err)}},getTagByInternalId=function(id){return tagInstances[id]},getTagById=function(id){for(var internalId in tagInstances){var tag=tagInstances[internalId];if(tag.id&&tag.id===id){return tag}}xRTML.Console.error("Tag instance with id: "+tagId+" not found.")};return{loadTags:loadTags,createTag:createTag,getTagById:getTagById,getTagByInternalId:getTagByInternalId,registerTag:registerTag}})();new Events.Provider(instance);TagManager=function(){return instance};return TagManager()})();var MessageBroker={triggers:{},registerTrigger:function(trigger){if(!this.triggers[trigger.name]){this.triggers[trigger.name]={}}this.triggers[trigger.name][trigger.tagInternalId]={callback:trigger.callback,mappings:trigger.mappings};this.dispatchEvent("onTriggerRegistered",{trigger:trigger})},unregisterTrigger:function(trigger){var mbTrigger=this.triggers[trigger.name];if(mbTrigger&&mbTrigger[trigger.tagInternalId]){var mbTriggerEntry=mbTrigger[trigger.tagInternalId];trigger.callback=mbTriggerEntry.callback;trigger.mappings=mbTriggerEntry.mappings;delete this.triggers[trigger.name][trigger.tagInternalId];var hasProperties=false;for(var prop in mbTrigger){if(mbTrigger.hasOwnProperty(prop)){hasProperties=true}}if(!hasProperties){delete this.triggers[trigger.name]}this.dispatchEvent("onTriggerUnregistered",{trigger:trigger})}},registerTriggers:function(e){var tag=e.tag;for(var i=0;i<tag.triggers.length;++i){var trigger=tag.triggers[i];MessageBroker.registerTrigger({tagInternalId:tag.internalId,name:trigger.name,callback:tag.callProcess,mappings:trigger.mappings})}},unregisterTriggers:function(e){var tag=e.tag;for(var i=0;i<tag.triggers.length;++i){var trigger=tag.triggers[i];MessageBroker.unregisterTrigger({tagInternalId:tag.internalId,name:trigger.name})}},triggerTags:function(e){var triggerName=e.message.trigger;if(triggerName){if(MessageBroker.triggers[triggerName]){for(var tagInternalId in MessageBroker.triggers[triggerName]){var tag=TagManager.getTagByInternalId(tagInternalId);tag.callProcess(e.message)}}else{xRTML.Console.debug("Trigger "+triggerName+" is not registered with xRTML. Message "+e.message.stringify()+" not received by any tag.")}}},init:function(){new Events.Provider(this);TagManager.addEventListener("onTagCreated",this.registerTriggers);TagManager.addEventListener("onTagDisposed",this.unregisterTriggers);ConnectionManager.addEventListener("onXrtmlMessage",this.triggerTags);return this}}.init();var MessageManager={parse:function(message){},isValid:function(message){try{if((typeof message==="string")&&message.toLowerCase().indexOf("xrtml")!=-1){return true}if((typeof message==="object")&&message.xrtml){return true}MessageManager.parse(message);return false}catch(err){xRTML.getInstance().Console.error("Invalid xRTML message:"+MessageManager.toJSON(message))}},toJson:function(message){if(typeof message==="string"){var xrtmlMessage={xrtml:{senderId:message.s,trigger:message.t,action:message.a,data:typeof message.d==="object"?message.d:JSON.parse(message.d)}};return JSON.parse(xrtmlMessage)}return message},stringify:function(message){var xrtmlMessage={xrtml:{s:message.senderId,t:message.trigger,a:message.action,d:typeof message.data==="object"?message.data:JSON.parse(message.data)}};return JSON.stringify(xrtmlMessage)},createMessage:function(senderId,trigger,action,data){var message={senderId:senderId,trigger:trigger,action:action,data:typeof data==="object"?data:JSON.parse(data),stringify:function(){return MessageManager.stringify(this)}};return message}};var TraceMonitor={init:function(remote){var sendTrace=function(message,obj){if(remote){var data=null;try{data=JSON.stringify(obj)}catch(e){}var xrtmlMessage=createMessage("","",{message:message,content:data});sendMessage("trace",xrtmlMessage)}};if(remote){xRTML.Console.addEventListener("onError",function(e){sendTrace("Error",e.error)})}ConnectionManager.addEventListener("onConnectionCreated",function(evt){var connection=evt.connection;sendTrace("Connection found: \n AppKey: "+connection.appKey+" \n AuthToken: "+connection.authToken+" \n Url: "+connection.url,connection);connection.addEventListener("onAuthenticated",function(e){var statement="Connection "+(e.connection.id||e.connection.internalId)+": authentication "+(e.isAuthenticated?"successful.":("failed: "+e.error));xRTML.Console.debug(statement);sendTrace(statement,e.connection)});connection.addEventListener("onCreated",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" created. "+(e.client.autoConnect?"Connecting...":"Waiting for explicit connect...");xRTML.Console.debug(statement);sendTrace(statement,e.client)});connection.addEventListener("onConnected",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" established. Subscribing channels...";xRTML.Console.debug(statement);sendTrace(statement,e.client)});connection.addEventListener("onDisconnected",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" closed.";xRTML.Console.debug(statement);sendTrace(statement,e.client)});connection.addEventListener("onSubscribed",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+": Channel "+e.channel+" subscribed.";xRTML.Console.debug(statement);sendTrace(statement,e.client)});connection.addEventListener("onUnsubscribed",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+": Channel "+e.channel+" unsubscribed.";xRTML.Console.debug(statement);sendTrace(statement,e.client)});connection.addEventListener("onException",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" threw an exception: "+e.event;xRTML.Console.debug(statement);sendTrace(statement,e.client)});connection.addEventListener("onReconnected",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" has been restored.";xRTML.Console.debug(statement);sendTrace(statement,e.client)});connection.addEventListener("onReconnecting",function(e){var statement="Connection "+(e.client.id||e.client.internalId)+" was lost. ";if(e.client.connectionAttemptsCounter>=e.client.connectAttempts){statement+="Maximum number of attempts reached: "+e.client.connectAttempts+" Stop trying to reconnect."}else{statement+="Trying to reconnect. Attempt "+e.client.connectionAttemptsCounter+" out of "+e.client.connectAttempts}xRTML.Console.debug(statement);sendTrace(statement,e.client)});connection.addEventListener("onMessage",function(e){var statement=typeof e.message==="String"?e.message:JSON.stringify(e.message);xRTML.Console.debug("Connection "+(e.target.id||e.target.internalId)+": Message "+statement+" received from channel "+e.channel);sendTrace(statement,e.target)})});TagManager.addEventListener("onTagCreated",function(e){var tag=e.tag;xRTML.Console.debug("Tag of type "+e.name+" created with id "+(tag.id||tag.internalId));xRTML.Console.debug(tag);tag.addEventListener("onInit",function(e){xRTML.Console.debug("")});tag.addEventListener("onLoad",function(e){xRTML.Console.debug("")});tag.addEventListener("active",function(e){xRTML.Console.debug("")});tag.addEventListener("onprocess",function(e){var statement="Tag "+(e.target.id||e.target.internalId)+": Process message ";xRTML.Console.debug(statement);xRTML.Console.debug(e.data);sendTrace(statement,e.target)});tag.addEventListener("preprocessed",function(e){var statement="Tag "+(e.target.id||e.target.internalId)+": Preprocess message ";xRTML.Console.debug(statement);xRTML.Console.debug(e.data);sendTrace(statement,e.target)});tag.addEventListener("postprocessed",function(e){var statement="Tag "+(e.target.id||e.target.internalId)+": Postprocess message ";xRTML.Console.debug(statement);xRTML.Console.debug(e.data);sendTrace(statement,e.target)})});TagManager.addEventListener("onTagDisposed",function(e){var tag=e.tag,statement="Tag of type "+e.name+" with id "+(tag.id||tag.internalId)+" disposed.";xRTML.Console.debug(statement);sendTrace(statement,e.tag)});return this}};var init=function(){try{if(arguments.callee.done){return}arguments.callee.done=true;xRTML.Config.loadConfiguration();TraceMonitor.init(xRTML.Config.remoteTrace);var start=function(){if(xRTML.Config.xrtmlActive){ConnectionManager.loadConnections();TagManager.loadTags()}xRTML.ready=true;window.xRTML.dispatchEvent("ready")};if(xRTML.Config.loadORTCScript){xRTML.Common.DOM.loadScript(xRTML.Config.ortcLibrary,function(){start()})}else{start()}}catch(err){xRTML.ErrorHandler().generalError(err)}};var isXrtmlMessage=function(message){try{return MessageManager.isValid(message)}catch(err){xRTML.ErrorHandler().generalError(err)}};var createMessage=function(trigger,action,data,senderId){try{return MessageManager.createMessage(senderId,trigger,action,data)}catch(err){xRTML.ErrorHandler().generalError(err)}};var registerTag=function(tagName){try{return TagManager.registerTag(tagName)}catch(err){xRTML.ErrorHandler().generalError(err)}};var createTag=function(tagObject){try{return TagManager.createTag(tagObject)}catch(err){xRTML.ErrorHandler().generalError(err)}};var getTag=function(id){try{return TagManager.getTagById(id)}catch(err){xRTML.ErrorHandler().generalError(err)}};var getTagByInternalId=function(internalId){try{return TagManager.getTagByInternalId(internalId)}catch(err){xRTML.ErrorHandler().generalError(err)}};var sendMessage=function(channel,message){try{var tag=getTagByInternalId(message.senderId);if(typeof tag=="undefined"||tag.active){ConnectionManager.sendMessage(channel,message)}}catch(err){xRTML.ErrorHandler().generalError(err)}};var createConnection=function(connectionJSON){try{ConnectionManager.createConnection(connectionJSON)}catch(err){xRTML.ErrorHandler().connectionError(err)}};var getConnectionByInternalId=function(internalId){return ConnectionManager.getConnectionByInternalId(internalId)};var getConnectionById=function(id){return ConnectionManager.getConnectionById(id)};var addConnectionChannel=function(connectionId,channel){ConnectionManager.addConnectionChannel(connectionId,channel)};return{Tags:{},ready:false,init:init,createTag:createTag,registerTag:registerTag,getTag:getTag,getTagByInternalId:getTagByInternalId,sendMessage:sendMessage,createMessage:createMessage,isXrtmlMessage:isXrtmlMessage,createConnection:createConnection,getConnectionByInternalId:getConnectionByInternalId,getConnectionById:getConnectionById,addConnectionChannel:addConnectionChannel}})();new Events.Provider(window.xRTML);if(navigator.appName=="Microsoft Internet Explorer"){if(new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})").exec(navigator.userAgent)!=null){if(parseFloat(RegExp.$1)<9||document.compatMode=="BackCompat"){document.write("<?xml:namespace prefix = xrtml />")}}}if(document.readyState=="loaded"||document.readyState=="complete"){xRTML.init()}else{Events.Manager.addEventListener(window,"load",xRTML.init)}xRTML.Common=(function(){return{Array:(function(){return{forEach:function(items,fn){if(!items){return}for(var i=0,len=items.length;i<len;i++){fn(items[i],i)}},indexOf:function(items,obj,start){if(!Array.prototype.indexOf){for(var i=(start||0),j=items.length;i<j;i++){if(items[i]===obj){return i}}return -1}else{return items.indexOf(obj)}},remove:function(array,from,to){var rest=array.slice((to||from)+1||array.length);array.length=from<0?array.length+from:from;return array.push.apply(array,rest)}}})(),DOM:(function(){return{browser:function(){var userAgent=window.navigator.userAgent.toLowerCase();var browserNames=["msie","firefox","safari","gecko"],browserTypes=["ie","mozilla","safari","mozilla"],browserType;for(var i=0;i<browserNames.length;i++){if(userAgent.indexOf(browserNames[i])>=0){browserType=browserTypes[i];break}}return browserType},getInternetExplorerVersion:function(){var rv=-1;if(navigator.appName=="Microsoft Internet Explorer"){var ua=navigator.userAgent;var re=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})");if(re.exec(ua)!=null){rv=parseFloat(RegExp.$1)}}return rv},isQuirksMode:function(){return document.compatMode=="BackCompat"},getElementsByTagName:function(parent,tagName){if(typeof parent.canHaveChildren==="undefined"||parent.canHaveChildren){var ieVersion=this.getInternetExplorerVersion();if(ieVersion==7||ieVersion==8||(this.isQuirksMode()&&this.browser()=="ie")){var tags=[];var tagsFound=parent.getElementsByTagName(tagName.replace("xrtml:",""));for(var i=0,len=tagsFound.length;i<len;i++){var tagFound=tagsFound[i];if(tagFound.scopeName&&tagFound.scopeName=="xrtml"){tags.push(tagsFound[i])}}return tags}return parent.getElementsByTagName(tagName)}var elements=[];var cursor=parent.nextSibling;if(cursor){while(cursor.nextSibling&&cursor.nextSibling.tagName!==("/"+parent.tagName)){if(cursor.tagName===tagName.toUpperCase()){elements.push(cursor)}cursor=cursor.nextSibling}}return elements},getDirectXRTMLChildrenElements:function(parent){Sizzle.selectors.filters.xrtml=function(elem,i,match){return((elem.nodeName.toLowerCase().indexOf("xrtml")!=-1)||(elem.scopeName&&elem.scopeName=="xrtml"))&&(elem.nodeName.indexOf("/")==-1)};var result=Sizzle(">:xrtml",parent);return result},getXRTMLCollectionTagChildren:function(parent){Sizzle.selectors.filters.xrtmltagname=function(elem,i,match){return((elem.nodeName.toLowerCase().indexOf("xrtml")!=-1)||(elem.scopeName&&elem.scopeName=="xrtml"))&&(elem.nodeName.toLowerCase().indexOf(match[3].toLowerCase())!=-1)&&(elem.nodeName.indexOf("/")==-1)};var firstChildName;var firstChild=Sizzle(":first",parent);if(firstChild&&firstChild.length>0){firstChildName=firstChild[0].nodeName;if(firstChildName==parent.nodeName){return[]}}else{return[]}return Sizzle("*:xrtmltagname("+firstChildName+")",parent)},getElementsByClassName:function(parent,className){var elements=[];var walkTheDOM=function(node,func){func(node);node=node.firstChild;while(node){walkTheDOM(node,func);node=node.nextSibling}};if(parent.getElementsByClassName){elements=parent.getElementsByClassName(className)}else{walkTheDOM(parent,function(node){var a,c=node.className,i;if(c){a=c.split(" ");for(i=0;i<a.length;i++){if(a[i]===className){elements.push(node);break}}}})}return elements},getText:function(element){if(element&&element.innerText){return element.innerText}if(element&&element.innerHTML){return element.innerHTML}if(element&&element.nextSibling){return element.nextSibling.data}},setText:function(element,text){if(element){element.innerHTML=text;element.innerText=text}},outerHTML:function(node){return node.outerHTML||(function(n){var div=document.createElement("div"),h;div.appendChild(n.cloneNode(true));h=div.innerHTML;div=null;return h})(node)},getAttribute:function(value){if(parseInt(value)){return parseInt(value)}switch(value.toLowerCase()){case"true":return true;case"false":return false;default:return value}},toDOMElement:function(source){var div=document.createElement("div");div.innerHTML=content;return div.childNodes},getNextSibling:function(node){var next=node.nextSibling;while(next.nodeType!==1){next=next.nextSibling}return next},loadScript:function(url,callback){var script=document.createElement("script");script.type="text/javascript";if(script.readyState){script.onreadystatechange=function(){if(script.readyState=="loaded"||script.readyState=="complete"){script.onreadystatechange=null;callback()}}}else{script.onload=function(){callback()}}script.src=url;document.getElementsByTagName("head")[0].appendChild(script)}}})(),Cookie:(function(){return{setCookie:function(cookieName,cookieValue,expires,path,domain,secure){var cookieString=cookieName+"="+escape(cookieValue);if(expires){cookieString+="; expires="+expires.toGMTString()}if(path){cookieString+="; path="+escape(path)}else{cookieString+="; path=/"}if(domain){cookieString+="; domain="+escape(domain)}if(secure){cookieString+="; secure"}document.cookie=cookieString},getCookie:function(cookieName){var results=document.cookie.match("(^|;) ?"+cookieName+"=([^;]*)(;|$)");if(results){return(unescape(results[2]))}return null},deleteCookie:function(cookieName){var cookieDate=new Date();cookieDate.setTime(cookieDate.getTime()-1);document.cookie=cookieName+="=; expires="+cookieDate.toGMTString()}}})(),Validator:(function(){return{validateRequired:function(value,throwError,appendToErrorMessage){if((typeof value=="undefined")||value==undefined||value==null||value===""||value==NaN){if(throwError){xRTML.ErrorHandler().generalError(new Error("Value cannot be empty. "+appendToErrorMessage))}return false}else{return true}},validateBoolean:function(value,throwError,appendToErrorMessage){if(value&&(value.toLowerCase()==="true"||value.toLowerCase()==="false")){return true}else{if(throwError){xRTML.ErrorHandler().generalError(new Error('Value is neither "true" or "false". '+appendToErrorMessage))}return false}},validateAlfaNumeric:function(value,throwError,appendToErrorMessage){var alphanum=/^[0-9a-bA-B]+$/;if(!value.match(alphanum)){if(throwError){xRTML.ErrorHandler().generalError(new Error("Value is not alphanumeric. "+appendToErrorMessage))}return false}else{return true}},validateNumeric:function(value,throwError,appendToErrorMessage){var num=/^[0-9]+[.]*[0-9]*$/;if((typeof value=="number")||((typeof value=="string")&&value.match(num))){return true}else{if(throwError){xRTML.ErrorHandler().generalError(new Error("Value is not a number. "+appendToErrorMessage))}return false}},validateJSON:function(value,throwError,appendToErrorMessage){if(value.isJSON()){return true}else{if(throwError){xRTML.ErrorHandler().generalError(new Error("Value is not valid JSON notation. "+appendToErrorMessage))}return false}}}})(),Converter:(function(){var bool={"true":true,yes:true,"1":true,"false":false,no:false,"0":false};return{toBoolean:function(value,throwError,appendToErrorMessage){return typeof value==="boolean"?value:typeof value==="string"?bool[value.toLowerCase()]:value},toNumber:function(value,throwError,appendToErrorMessage){if(typeof value=="number"){return value}if((typeof value=="string")&&(value.trim()=="")){return 0}else{if((typeof value!="undefined")&&xRTML.Common.Validator.validateNumeric(value,throwError,appendToErrorMessage)){return Number(value)}}},toJSON:function(value,throwError,appendToErrorMessage){if((typeof value!="undefined"&&value!="")&&xRTML.Common.Validator.validateJSON(value,throwError,appendToErrorMessage)){return JSON.parse(value)}}}})(),Util:(function(){var S4=function(){return(((1+Math.random())*65536)|0).toString(16).substring(1)};return{regexIndexOf:function(string,regex,startpos){var indexOf=string.substring(startpos||0).search(regex);return(indexOf>=0)?(indexOf+(startpos||0)):indexOf},replaceAll:function(string,token,newtoken){while((typeof string=="string")&&(string.indexOf(token)!=-1)){string=string.replace(token,newtoken)}return string},regexReplaceAll:function(string,regex,newtoken){while((typeof string=="string")&&(this.regexIndexOf(string,regex)!=-1)){string=string.replace(regex,newtoken)}return string},convertAttributeValueToJSON:function(attributeValue){var parsedValue;if(attributeValue){attributeValue=this.replaceAll(attributeValue,"'",'"');if(typeof attributeValue=="string"){parsedValue=JSON.parse(attributeValue)}else{parsedValue=attributeValue}}else{xRTML.ErrorHandler().generalError(new Error("attributeValue is undefined."))}return parsedValue},guidGenerator:function(){return(S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4())},idGenerator:function(){return(S4()+S4())},printStackTrace:function(error){var ex=error||null;var p={run:function(ex){ex=ex||this.createException();var mode=this.mode(ex);if(mode==="other"){return this.other(arguments.callee)}else{return this[mode](ex)}},createException:function(){try{this.undef();return null}catch(e){return e}},mode:function(e){if(e["arguments"]&&e.stack){return(this._mode="chrome")}else{if(e.message&&typeof window!=="undefined"&&window.opera){return(this._mode=e.stacktrace?"opera10":"opera")}else{if(e.stack){return(this._mode="firefox")}}}return(this._mode="other")},chrome:function(e){var stack=(e.stack+"\n").replace(/^\S[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^([^\(]+?)([\n$])/gm,"{anonymous}()@$1$2").replace(/^Object.<anonymous>\s*\(([^\)]+)\)/gm,"{anonymous}()@$1").split("\n");stack.pop();return stack},firefox:function(e){return e.stack.replace(/(?:\n@:0)?\s+$/m,"").replace(/^\(/gm,"{anonymous}(").split("\n")},opera10:function(e){var stack=e.stacktrace;var lines=stack.split("\n"),ANON="{anonymous}",lineRE=/.*line (\d+), column (\d+) in ((<anonymous function\:?\s*(\S+))|([^\(]+)\([^\)]*\))(?: in )?(.*)\s*$/i,i,j,len;for(i=2,j=0,len=lines.length;i<len-2;i++){if(lineRE.test(lines[i])){var location=RegExp.$6+":"+RegExp.$1+":"+RegExp.$2;var fnName=RegExp.$3;fnName=fnName.replace(/<anonymous function\:?\s?(\S+)?>/g,ANON);lines[j++]=fnName+"@"+location}}lines.splice(j,lines.length-j);return lines},opera:function(e){var lines=e.message.split("\n"),ANON="{anonymous}",lineRE=/Line\s+(\d+).*script\s+(http\S+)(?:.*in\s+function\s+(\S+))?/i,i,j,len;for(i=4,j=0,len=lines.length;i<len;i+=2){if(lineRE.test(lines[i])){lines[j++]=(RegExp.$3?RegExp.$3+"()@"+RegExp.$2+RegExp.$1:ANON+"()@"+RegExp.$2+":"+RegExp.$1)+" -- "+lines[i+1].replace(/^\s+/,"")}}lines.splice(j,lines.length-j);return lines},other:function(curr){var ANON="{anonymous}",fnRE=/function\s*([\w\-$]+)?\s*\(/i,stack=[],fn,args,maxStackSize=10;while(curr&&stack.length<maxStackSize){fn=fnRE.test(curr.toString())?RegExp.$1||ANON:ANON;args=Array.prototype.slice.call(curr["arguments"]||[]);stack[stack.length]=fn+"("+this.stringifyArguments(args)+")";try{curr=curr.caller}catch(err){curr=null}}return stack},stringifyArguments:function(args){var slice=Array.prototype.slice;for(var i=0;i<args.length;++i){var arg=args[i];if(arg===undefined){args[i]="undefined"}else{if(arg===null){args[i]="null"}else{if(arg.constructor){if(arg.constructor===Array){if(arg.length<3){args[i]="["+this.stringifyArguments(arg)+"]"}else{args[i]="["+this.stringifyArguments(slice.call(arg,0,1))+"..."+this.stringifyArguments(slice.call(arg,-1))+"]"}}else{if(arg.constructor===Object){args[i]="#object"}else{if(arg.constructor===Function){args[i]="#function"}else{if(arg.constructor===String){args[i]='"'+arg+'"'}}}}}}}}return args.join(",")}};return p.run(ex)}}})(),Function:(function(){var invoke=function(ctx,func,params){if(func===null){return}switch(typeof func){case"function":try{var args=Array.prototype.slice.call(arguments);args.shift();args.shift();return func.apply(ctx,args)}catch(e){xRTML.ErrorHandler().generalError(e)}break;case"undefined":break;default:xRTML.Console.error("Invoke of function not possible. "+(func===null?"null":func.toString())+" is not a function.");break}};return{invoke:invoke}})()}})();xRTML.Config=(function(){var instance=(function(){var protocol=("https:"==document.location.protocol?"https://":"http://"),logLevels={error:0,warn:1,info:2},loadConfiguration=function(){var tag=xRTML.Common.DOM.getElementsByTagName(document.documentElement,"xrtml:config");if(tag.length>1){throw"xRTML only allows for one config tag per page."}tag=tag[0];if(tag===undefined){return}if(typeof tag.attributes.debug!=="undefined"){this.debug=xRTML.Common.Converter.toBoolean(tag.getAttribute("debug"))}if(typeof tag.attributes.loglevel!=="undefined"){this.logLevel=logLevels[tag.getAttribute("loglevel")]}if(typeof tag.attributes.xrtmlactive!=="undefined"){this.xrtmlActive=xRTML.Common.Converter.toBoolean(tag.getAttribute("xrtmlactive"))}if(typeof tag.attributes.throwerrors!=="undefined"){this.throwErrors=xRTML.Common.Converter.toBoolean(tag.getAttribute("throwerrors"))}if(typeof tag.attributes.connectionattempts!=="undefined"){this.connectionAttempts=xRTML.Common.Converter.toNumber(tag.getAttribute("connectionattempts"))}if(typeof tag.attributes.connectiontimeout!=="undefined"){this.connectionTimeout=xRTML.Common.Converter.toNumber(tag.getAttribute("connectiontimeout"))}if(typeof tag.attributes.loadortcscript!=="undefined"){this.loadORTCScript=xRTML.Common.Converter.toBoolean(tag.getAttribute("loadortcscript"))}if(typeof tag.attributes.remoteTrace!=="undefined"){this.remoteTrace=xRTML.Common.Converter.toBoolean(tag.getAttribute("remoteTrace"))}};return{logLevels:logLevels,debug:false,logLevel:logLevels.info,xrtmlActive:true,throwErrors:false,connectionAttempts:5,connectionTimeout:10000,loadORTCScript:true,ortcLibrary:protocol+"ortc.realtime.livehtml.net/js/2.0.0/ortc.js",loadConfiguration:loadConfiguration,remoteTrace:false}})();var Config=function(){return instance};return Config()})();xRTML.ErrorHandler=function(){var constructor=function(){handleError=function(name,err){if(!xRTML.Config.throwErrors){var xrtmlError={name:name,message:err.message,cause:err,stackTrace:xRTML.Common.Util.printStackTrace(err)};if((typeof window.console!=="undefined")&&window.console.debug){xRTML.Console.error(xrtmlError)}else{xRTML.Console.error(err.message)}}else{err.stackTrace=xRTML.Common.Util.printStackTrace(err);throw err}};return{handleError:handleError,tagError:function(err){handleError("TagError",err)},connectionError:function(err){handleError("ConnectionError",err)},generalError:function(err){handleError("GeneralError",err)}}};ErrorHandler=function(){if(!xRTML.ErrorHandler.instance){xRTML.ErrorHandler.instance=new constructor()}return xRTML.ErrorHandler.instance};return ErrorHandler()};xRTML.Error={type:{General:0,Tag:1,Connection:2}};xRTML.Console=(function(){var instance=(function(){var fallback={id:null,buffer:[],style:"width: 100%; height: 40%; position: absolute; bottom:5px; left:5px; background: silver; padding: 5px; overflow: scroll;display:none;font-family:consolas,monospace;font-size:12px; ",printObject:function(obj){var output="";for(property in obj){output+=property+": "+obj[property]+"; \n"}return obj},newLine:function(statement,style){var pStatement=document.createElement("p");pStatement.style.color=style;pStatement.innerHTML=typeof statement==="String"?statement:this.printObject(statement);if(fallback.id){document.getElementById(fallback.id).appendChild(pStatement)}else{fallback.buffer.push(pStatement)}},log:function(statement){fallback.newLine(statement,"black")},warn:function(statement){fallback.newLine(statement,"orange")},error:function(statement){fallback.newLine(statement,"red")},debug:function(statement){fallback.newLine(statement,"green")},init:function(){fallback.id="xRTML_Console_"+xRTML.Common.Util.idGenerator();var consoleDiv=document.createElement("div");consoleDiv.id=fallback.id;consoleDiv.style.cssText=fallback.style;for(var i=0,len=fallback.length;i<len;i++){consoleDiv.appendChild(fallback.buffer[i])}buffer=[];if(xRTML.Config.debug){document.body.appendChild(consoleDiv)}return fallback}};var debugConsole=null;if(typeof console==="undefined"){debugConsole=fallback;if(document.readyState=="loaded"||document.readyState=="complete"){fallback.init()}else{Events.Manager.addEventListener(window,"load",fallback.init)}}else{debugConsole=console}return{log:function(info){debugConsole.log(info)},warn:function(info){debugConsole.warn(info)},error:function(info){debugConsole.error(info);if(xRTML.Config.remoteTrace===true){this.dispatchEvent("onError",{error:info})}},debug:function(info){if(xRTML.Config.debug===true){debugConsole.log(info)}}}})();new Events.Provider(instance);xRTML.Console=function(){return instance};return xRTML.Console()})();xRTML.Common.xhr=function(method,url,callback,async){this.init(method,url,callback,async)};xRTML.Common.xhr.prototype={readyStateCode:{UNSENT:0,OPENED:1,HEADERS_RECEIVED:2,LOADING:3,DONE:4},init:function(method,url,callback,async){if(method&&url&&callback){this.create(method,url,callback,async)}},getXHR:function(){if(window.XMLHttpRequest){return new XMLHttpRequest()}else{if(window.ActiveXObject){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(e){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(e){}try{return ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}}xRTML.Console.error("This browser does not support XMLHttpRequest.")},create:function(method,url,callback,async){var self=this;self.xhr=this.getXHR();self.callback=callback;method=method.toUpperCase();self.xhr.onreadystatechange=function(){try{self.callback.apply(self.xhr,[self])}catch(e){xRTML.Console.error(e)}};self.xhr.open(method,url,(async===true));self.xhr.setRequestHeader("Content-Type","application/json; charset=utf-8");if(method=="POST"){self.xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");self.xhr.setRequestHeader("Method","POST "+url+" HTTP/1.1")}return self.xhr},send:function(data){if(typeof(data)!="string"){data=JSON.stringify(data)}xRTML.Console.debug("sending:"+data);this.xhr.send(data)}};xRTML.JQueryEffectManager=(function(){var uiEffects={blind:true,bounce:true,clip:true,drop:true,explode:true,fade:true,fold:true,highlight:true,puff:true,pulsate:true,scale:true,shake:true,size:true,slide:true,transfer:true};function checkIfEffectFunctionAvailable(effectName){var effectAvailable=(jQuery.fn&&((typeof jQuery.fn[effectName]).toLowerCase()=="function"))||(jQuery.effects&&((typeof jQuery.effects[effectName]).toLowerCase()=="function"));if(!effectAvailable){xRTML.ErrorHandler().generalError(new Error("Effect function "+effectName+" not available. Please import the necessary jQuery libraries for this function."))}}function callJQueryEffect(argumentsObject){if(!argumentsObject.element||!argumentsObject.effectName){xRTML.ErrorHandler().generalError(new Error("Required arguments not found. This function takes an Object containing at least the following properties: element, effectName"))}xRTML.Console.debug("jQuery effect: Running "+argumentsObject.effectName+" on element "+argumentsObject.element.id+" with options "+JSON.stringify(argumentsObject.effectOptions)+" and properties: "+JSON.stringify(argumentsObject.effectProperties));checkIfEffectFunctionAvailable(argumentsObject.effectName);try{if(uiEffects[argumentsObject.effectName]){jQuery.fn.effect.call(jQuery(argumentsObject.element),argumentsObject.effectName,argumentsObject.effectOptions,argumentsObject.effectSpeed,argumentsObject.effectCallback)}else{jQuery.fn[argumentsObject.effectName].call(jQuery(argumentsObject.element),argumentsObject.effectProperties,argumentsObject.effectOptions)}}catch(err){xRTML.Console.warn(err)}}function buildReverseEffectProperties(argumentsObject){var elementCSSProperties={};for(prop in argumentsObject.effectProperties){if(jQuery(argumentsObject.element).css(prop)){elementCSSProperties[prop]=jQuery(argumentsObject.element).css(prop)}}return elementCSSProperties}function callJQueryEffectNow(argumentsObject){argumentsObject.effectOptions.queue=false;callJQueryEffect(argumentsObject)}function buildArgumentsObject(element,effect){var argumentsObject={};argumentsObject.element=element;argumentsObject.effectName=effect.name;argumentsObject.effectOptions=cloneJQueryOptions(effect.options);argumentsObject.effectProperties=effect.cssProperties;argumentsObject.effectSpeed=effect.speed;argumentsObject.effectCallback=effect.callback?(typeof effect.callback=="function"?effect.callback:new Function("","return "+effect.callback+"();")):null;argumentsObject.revert=effect.revert;return argumentsObject}var cloneJQueryOptions=function(options){var newOptions={};for(prop in options){newOptions[prop]=options[prop]}return newOptions};return{effectsQueue:[],effectsMap:{},init:function(xrtmlEffectElements){for(var i=0;i<xrtmlEffectElements.length;i++){var effect=xrtmlEffectElements[i];var effectId=effect.id;if(this.effectsMap[effectId]){xRTML.ErrorHandler().generalError(new Error("All jqueryeffect id attributes should be unique."))}this.effectsMap[effectId]={};this.effectsMap[effectId].name=effect.name;this.effectsMap[effectId].options=effect.options?xRTML.Common.Util.convertAttributeValueToJSON(effect.options):undefined;this.effectsMap[effectId].cssProperties=effect.properties?xRTML.Common.Util.convertAttributeValueToJSON(effect.properties):undefined;this.effectsMap[effectId].speed=effect.speed;this.effectsMap[effectId].callback=effect.callback;var revertAttribute=effect.revert;if(revertAttribute){if(revertAttribute==="true"){this.effectsMap[effectId].revert=true}else{this.effectsMap[effectId].revert=false}}}},addEffectToQueue:function(argumentsObject){if(!this.effectsQueue){this.effectsQueue=[]}this.effectsQueue.push({element:argumentsObject.element,effectId:argumentsObject.effectId});if(this.effectsMap[argumentsObject.effectId].revert){var revertEffect=jQuery.extend(true,{},this.effectsMap[argumentsObject.effectId]);revertEffect.cssProperties=buildReverseEffectProperties({effectProperties:this.effectsMap[argumentsObject.effectId].cssProperties,element:argumentsObject.element});this.effectsMap[argumentsObject.effectId+"_revert"]=revertEffect;this.effectsQueue.push({element:argumentsObject.element,effectId:argumentsObject.effectId+"_revert"})}},removeEffectFromQueue:function(element,effectId){},runAllEffects:function(){var currentElement;for(var i=0;i<this.effectsQueue.length;i++){var argumentsObject=buildArgumentsObject(this.effectsQueue[i].element,this.effectsMap[this.effectsQueue[i].effectId]);callJQueryEffect(argumentsObject)}},runAllEffectsNow:function(){for(var i=0;i<this.effectsQueue.length;i++){var argumentsObject=buildArgumentsObject(this.effectsQueue[i].element,this.effectsMap[this.effectsQueue[i].effectId]);callJQueryEffectNow(argumentsObject)}},runElementEffects:function(element){},runElementEffectsNow:function(element){},runEffect:function(element,effectId){},runEffectNow:function(element,effectId){},stopAllEffects:function(){},stopAllEffectsAndClearQueue:function(){for(var i=0;i<this.effectsQueue.length;i++){jQuery(this.effectsQueue[i].element).stop(false,true)}this.effectsQueue=[]},stopElementEffects:function(element){},stopElementEffectsAndClearQueue:function(element){},stopEffect:function(element,effectId){},getInstance:function(context){if(!context.jQueryEffectManagerInstance){function F(){}F.prototype=xRTML.JQueryEffectManager;return new F()}return context.jQueryEffectManagerInstance}}})();if(typeof Function.prototype.makeSubclass!=="function"){Function.prototype.makeSubclass=function(){function Class(){if(!(this instanceof Class)){throw ('Constructor called without "new"')}if("init" in this){this.init.apply(this,arguments)}}Function.prototype.makeSubclass.nonconstructor.prototype=this.prototype;Class.prototype=new Function.prototype.makeSubclass.nonconstructor();return Class}}Function.prototype.makeSubclass.nonconstructor=function(){};if(typeof String.prototype.parseTemplate!=="function"){String.prototype.parseTemplate=function(o){return this.replace(/\[xRTML:([^\[\]]*)\]/g,function(a,b){var r=o[b];return typeof r==="string"?r:a})}}if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s*/,"").replace(/\s*$/,"")}}if(typeof String.prototype.isJSON!=="function"){String.prototype.isJSON=function(){return !(/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(this.replace(/"(\\.|[^"\\])*"/g,"")))}}xRTML.Tag=Object.makeSubclass();xRTML.Tag.prototype.init=function(tagObject){new Events.Provider(this);var self=this;this.onInit=function(){var e={target:self};tagObject.oninit?new Function("e","return "+tagObject.oninit+"(e);")(e):null;self.dispatchEvent("onInit")}();this.onLoad=function(){var e={target:self};tagObject.onload?new Function("e","return "+tagObject.onload+"(e);")(e):null;self.dispatchEvent("onLoad")};this.onActive=function(active){var e={target:self,active:active};tagObject.onactive?new Function("e","return "+tagObject.onactive+"(e);")(e):null;self.dispatchEvent("active",e)};this.onActivated=function(active){var e={target:self,active:active};tagObject.onactivated?new Function("e","return "+tagObject.onactivated+"(e);")(e):null;self.dispatchEvent("activated",e)};this.id=tagObject.id;this.internalId=xRTML.Common.Util.guidGenerator();this.channelId=tagObject.channelid;var targetId=tagObject.target;if(targetId){var pattern=/\.|\#|\:|\>|\-|\+|\~| /;var isTargetId=targetId.match(pattern);if(isTargetId==null){targetId="#"+targetId}this.target=Sizzle(targetId);if(!this.target){xRTML.Console.error("Target element(s) not found.")}}this.triggers=[];var triggers=tagObject.triggers;if(triggers){for(var i=0;i<triggers.length;i++){this.triggers.push({name:triggers[i].name,mappings:triggers[i].mappings})}}this.receiveOwnMessages=typeof tagObject.receiveownmessages==="undefined"?false:xRTML.Common.Converter.toBoolean(tagObject.receiveownmessages);this.activate=function(active){this.active=(typeof active=="undefined"||active==null)?true:xRTML.Common.Converter.toBoolean(active);this.onActive(this.active,self)};this.active=tagObject.active;this.activate(this.active);var preProcessUDF=tagObject.preprocess?new Function("data","return "+tagObject.preprocess+"(data);"):null;var preProcess=function(data){if(typeof preProcessUDF=="function"){preProcessUDF(data)}self.dispatchEvent("preprocessed",{data:data})};var postProcessUDF=tagObject.postprocess?new Function("data","return "+tagObject.postprocess+"(data);"):null;var postProcess=function(data){if(typeof postProcessUDF=="function"){postProcessUDF(data)}self.dispatchEvent("postprocessed",{data:data})};var process=function(objContext,data){if(objContext.active){preProcess(data);objContext.process(data)}else{xRTML.Console.debug("Tag "+(objContext.id||objContext.internalId)+" is not active. No actions will be processed.")}var action=data.action;if(action&&action=="activate"){if(data.data){objContext.activate(data.data.active)}else{xRTML.Console.error("Activating a tag requires the message data to have the attribute 'active' set to 'true' or 'false' ")}}if(objContext.active){postProcess(data)}};this.process=function(data){var action=data.action;if(action){var mappings=[];for(var trig in this.triggers){if(data.trigger==this.triggers[trig].name&&this.triggers[trig].mappings){mappings=this.triggers[trig].mappings;for(var map in mappings){if(data.action==mappings[map].action){action=mappings[map].to;break}}break}}this[action]?this[action].call(this,data):xRTML.Console.debug("Action "+action+" is not supported by this Tag")}else{xRTML.Console.error("Action was not specified. A Tag instance should either override process or handle actions so if process was not overriden an action is required.")}if(this.processUDF){this.processUDF(data)}};this.callProcess=function(data){if(!data.senderId||this.internalId!=data.senderId){process(this,data);self.dispatchEvent("onprocess",{data:data})}else{if(this.internalId===data.senderId&&this.receiveOwnMessages){process(this,data);self.dispatchEvent("onprocess",{data:data})}}};var disposeUDF=tagObject.dispose?new Function("return "+tagObject.dispose+"();"):null;this.dispose=function(){if(typeof disposeUDF=="function"){disposeUDF()}this.target=null;self.dispatchEvent("dispose",{tag:this})}};xRTML.Tags.Connection=xRTML.Tag.makeSubclass();xRTML.Tags.Connection.prototype.init=function(xrtmlObj){xRTML.Tag.prototype.init.call(this,xrtmlObj);var self=this,ortcClient=null,bool={"true":true,"false":false};this.authenticate=typeof xrtmlObj.authenticate==="boolean"?xrtmlObj.authenticate:bool[xrtmlObj.authenticate||"true"];this.authenticationUrl=xrtmlObj.authenticationurl||"handler/AuthenticationHandler.ashx";this.appKey=xrtmlObj.appkey;this.authToken=xrtmlObj.authtoken;this.sendRetries=parseInt(xrtmlObj.sendretries)||5;this.sendInterval=parseInt(xrtmlObj.sendinterval)||1000;this.timeout=xrtmlObj.timeout||xRTML.Config.connectionTimeout;this.connectAttempts=xrtmlObj.connectattempts||xRTML.Config.connectionAttempts;this.connectionAttemptsCounter=0;this.autoConnect=typeof xrtmlObj.autoconnect!="boolean"?(bool[xrtmlObj.autoconnect]||true):xrtmlObj.autoconnect;this.metadata=xrtmlObj.metadata;this.serverType=xrtmlObj.servertype||"IbtRealTimeSJ";var protocol=("https:"==document.location.protocol?"https://":"http://");this.url=xrtmlObj.url||(protocol+"developers2.realtime.livehtml.net/server/2.0");this.isCluster=typeof bool[xrtmlObj.iscluster]!="undefined"?bool[xrtmlObj.iscluster]:true;var Channel=function(name,permission,subscribeOnReconnect,subscribe,onMessage,messageAdapter){new Events.Provider(this);this.name=name;this.permission=(typeof permission=="undefined")?"r":permission;this.subscribeOnReconnect=(typeof subscribeOnReconnect=="undefined")?true:subscribeOnReconnect;this.subscribe=(typeof subscribe=="undefined")?true:subscribe;this.onMessage=onMessage;this.messageAdapter=messageAdapter};var addChannel=function(channel){self.channels[channel.name]=new Channel(channel.name,channel.permission,channel.subscribeonreconnect,channel.subscribe,channel.onmessage,channel.messageadapter);xRTML.Console.debug("Channel "+channel.name+" added to channels with "+channel.permission+" permission and subscribeOnReconnect = "+channel.subscribeonreconnect);self.dispatchEvent("onChannelAdded",{client:self,channel:channel})};this.addChannel=function(channel){addChannel(channel)};this.channels={};for(var i=0;i<xrtmlObj.channels.length;++i){var channel=xrtmlObj.channels[i];addChannel(channel)}this.messageAdapter=xrtmlObj.messageadapter;this.onAuthenticated=xrtmlObj.onauthenticated;this.onCreated=xrtmlObj.oncreated;this.onConnected=xrtmlObj.onconnected;this.onDisconnected=xrtmlObj.ondisconnected;this.onSubscribed=xrtmlObj.onsubscribed;this.onUnsubscribed=xrtmlObj.onunsubscribed;this.onException=xrtmlObj.onexception;this.onReconnected=xrtmlObj.onreconnected;this.onReconnecting=xrtmlObj.onreconnecting;this.onMessage=xrtmlObj.onmessage;var onAuthenticated=function(result){var xhr=result.xhr;if(xhr.readyState==4){if(xhr.status==200){var result=JSON.parse(xhr.responseText);self.appKey=result.applicationKey;self.authToken=result.authenticationToken;var e={connection:self,isAuthenticated:result.isAuthenticated,error:result.error,target:self};xRTML.Common.Function.invoke(self,self.onAuthenticated,e);self.dispatchEvent("onAuthenticated",e)}}};var onCreated=function(ortcClient){var e={client:self,target:self};xRTML.Common.Function.invoke(self,self.onCreated,e);self.dispatchEvent("onCreated",e);if(self.autoConnect){ortcClient.connect(self.appKey,self.authToken)}};var onConnected=function(ortcClient){var e={client:self,target:self};xRTML.Common.Function.invoke(self,self.onConnected,e);self.dispatchEvent("onConnected",e);for(var name in self.channels){var channel=self.channels[name];if(channel.subscribe){ortcClient.subscribe(channel.name,channel.subscribeOnReconnect,self.process)}}};var onDisconnected=function(ortcClient){var e={client:self,target:self};xRTML.Common.Function.invoke(self,self.onDisconnected,e);self.dispatchEvent("onDisconnected",e)};var onSubscribed=function(ortcClient,channel){var e={client:self,channel:channel,target:self};xRTML.Common.Function.invoke(self,self.onSubscribed,e);self.dispatchEvent("onSubscribed",e)};var onUnsubscribed=function(ortcClient,channel){var e={client:self,channel:channel,target:self};xRTML.Common.Function.invoke(self,self.onUnsubscribed,e);self.dispatchEvent("onUnsubscribed",e)};var onException=function(ortcClient,evt){var e={client:self,event:evt,target:self};xRTML.Common.Function.invoke(self,self.onException,e);self.dispatchEvent("onException",e)};var onReconnected=function(ortcClient){self.connectionAttemptsCounter=0;var e={client:self,target:self};xRTML.Common.Function.invoke(self,self.onReconnected,e);self.dispatchEvent("onReconnected",e)};var onReconnecting=function(ortcClient){if(self.connectionAttemptsCounter>=self.connectAttempts){ortcClient.disconnect()}else{self.connectionAttemptsCounter++;var e={client:self,target:self};xRTML.Common.Function.invoke(self,self.onReconnecting,e);self.dispatchEvent("onReconnecting",e)}};var onMessage=function(channel,message){var e={id:self.internalId,channel:channel,message:message,target:self};if(self.channels[channel].onMessage){self.channels[channel].onMessage(e)}self.channels[channel].dispatchEvent("onMessage",e);if(self.onMessage){xRTML.Common.Function.invoke(self,self.onMessage,e)}self.dispatchEvent("onMessage",e)};var messageAdapter=function(message){var adaptedMessage=message;if(self.messageAdapter){adaptedMessage=self.messageAdapter(message)}if(self.channels[channel]&&self.channels[channel].messageAdapter){adaptedMessage=self.channels[channel].messageAdapter(message);adaptedMessage=typeof adaptedMessage==="string"?adaptedMessage:adaptedMessage.stringify()}return adaptedMessage};this.authenticateConnection=function(){var jsonChannels=[];for(var channelName in this.channels){if(this.channels[channelName].subscribe){jsonChannels.push({name:channelName,permission:this.channels[channelName].permission})}}var xhr=new xRTML.Common.xhr("post",this.authenticationUrl,onAuthenticated);xhr.send(JSON.stringify({id:this.internalId,channels:jsonChannels,serverType:this.serverType}))};this.onClientCreated=function(e){ortcClient=e.client;ortcClient.setId(self.internalId);!self.isCluster?ortcClient.setUrl(self.url):ortcClient.setClusterUrl(self.url);ortcClient.onConnected=onConnected;ortcClient.onDisconnected=onDisconnected;ortcClient.onSubscribed=onSubscribed;ortcClient.onUnsubscribed=onUnsubscribed;ortcClient.onException=onException;ortcClient.onReconnected=onReconnected;ortcClient.onReconnecting=onReconnecting;ortcClient.setConnectionTimeout(self.timeout);ortcClient.setConnectionMetadata(self.metadata);onCreated(ortcClient)};this.process=function(ortcClient,channel,message){if(self.active){if(typeof self.preProcess=="function"){self.preProcess(ortcClient,channel,message)}onMessage(channel,message);message=messageAdapter(message);try{if(xRTML.isXrtmlMessage(message)){var messageJSON=JSON.parse(message).xrtml,xrtmlMessage=xRTML.createMessage(messageJSON.t,messageJSON.a,messageJSON.d,messageJSON.s);self.dispatchEvent("onXrtmlMessage",{message:xrtmlMessage})}}catch(err){xRTML.Console.error("Connection "+(self.id||self.internalId)+" error processing xRTML Message: "+message+". Error Description: "+err.name)}}else{xRTML.Console.debug("Message received wasn't processed. Connection is not active.")}};var retrySend=function(channel,message,retries){if(typeof message==="object"){message=message.stringify()}if(self.isCreated()&&self.isConnected()){ortcClient.send(channel,message)}else{if(++retries<=self.sendRetries){xRTML.Console.debug("Message "+message+" not sent to channel "+channel+". Retry "+retries+"/"+self.sendRetries+" in "+self.sendInterval/1000+" seconds.");setTimeout(function(){retrySend(channel,message,retries)},self.sendInterval)}else{xRTML.Console.debug("Message "+message+" not sent to channel "+channel+". Discarding message.")}}};this.send=function(channel,message){if(this.isCreated()){if(this.isConnected()){if(this.active){if(typeof message==="object"){message=message.stringify()}ortcClient.send(channel,message);xRTML.Console.debug("Message "+message+" sent to channel "+channel)}else{xRTML.Console.debug("Message "+message+" not sent to channel "+channel+". Discarding message. Connection is not active.")}}else{xRTML.Console.debug("Message "+message+" not sent to channel "+channel+". Connection not established yet. Retrying in "+this.sendInterval/1000+" seconds.");setTimeout(function(){retrySend(channel,message,0)},self.sendInterval)}}else{xRTML.Console.debug("Message "+message+" not sent to channel "+channel+". Connection not created yet. Retrying in "+this.sendInterval/1000+" seconds.");setTimeout(function(){retrySend(channel,message,0)},self.sendInterval)}};this.connect=function(appKey,authToken){if(this.isCreated()){ortcClient.connect(appKey||this.appKey,authToken||this.authToken)}else{xRTML.Console.error("Connect not possible. ORTC client not created.")}};this.disconnect=function(){if(this.isConnected()){ortcClient.disconnect()}else{xRTML.Console.error("Disconnect not possible. No connection established.")}};this.subscribe=function(name,subscribeOnReconnected,permission,onMessage,messageAdapter){addChannel({name:name,permission:permission,subscribeOnReconnect:subscribeOnReconnected,subscribe:true,onMessage:onMessage,messageAdapter:messageAdapter});var channel=this.channels[name];ortcClient.subscribe(channel.name,channel.subscribeOnReconnected,this.process)};this.unsubscribe=function(name){ortcClient.unsubscribe(name)};this.isCreated=function(){return ortcClient!=null};this.isConnected=function(){return ortcClient==null?false:ortcClient.getIsConnected()};this.isSubscribed=function(channelName){return ortcClient.isSubscribed(channelName)};this.getMetadata=function(){if(this.isCreated()){return ortcClient.getConnectionMetadata()}xRTML.Console.error("ORTC client is undefined.")};this.setMetadata=function(metadata){if(this.isCreated()){ortcClient.setConnectionMetadata(metadata)}else{xRTML.Console.error("ORTC client is undefined.")}}};var JSON;if(!JSON){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){k=rep[i];if(typeof k==="string"){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());(function(){var chunker=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,done=0,toString=Object.prototype.toString,hasDuplicate=false,baseHasDuplicate=true,rBackslash=/\\/g,rNonWord=/\W/;[0,0].sort(function(){baseHasDuplicate=false;return 0});var Sizzle=function(selector,context,results,seed){results=results||[];context=context||document;var origContext=context;if(context.nodeType!==1&&context.nodeType!==9){return[]}if(!selector||typeof selector!=="string"){return results}var m,set,checkSet,extra,ret,cur,pop,i,prune=true,contextXML=Sizzle.isXML(context),parts=[],soFar=selector;do{chunker.exec("");m=chunker.exec(soFar);if(m){soFar=m[3];parts.push(m[1]);if(m[2]){extra=m[3];break}}}while(m);if(parts.length>1&&origPOS.exec(selector)){if(parts.length===2&&Expr.relative[parts[0]]){set=posProcess(parts[0]+parts[1],context)}else{set=Expr.relative[parts[0]]?[context]:Sizzle(parts.shift(),context);while(parts.length){selector=parts.shift();if(Expr.relative[selector]){selector+=parts.shift()}set=posProcess(selector,set)}}}else{if(!seed&&parts.length>1&&context.nodeType===9&&!contextXML&&Expr.match.ID.test(parts[0])&&!Expr.match.ID.test(parts[parts.length-1])){ret=Sizzle.find(parts.shift(),context,contextXML);context=ret.expr?Sizzle.filter(ret.expr,ret.set)[0]:ret.set[0]}if(context){ret=seed?{expr:parts.pop(),set:makeArray(seed)}:Sizzle.find(parts.pop(),parts.length===1&&(parts[0]==="~"||parts[0]==="+")&&context.parentNode?context.parentNode:context,contextXML);set=ret.expr?Sizzle.filter(ret.expr,ret.set):ret.set;if(parts.length>0){checkSet=makeArray(set)}else{prune=false}while(parts.length){cur=parts.pop();pop=cur;if(!Expr.relative[cur]){cur=""}else{pop=parts.pop()}if(pop==null){pop=context}Expr.relative[cur](checkSet,pop,contextXML)}}else{checkSet=parts=[]}}if(!checkSet){checkSet=set}if(!checkSet){Sizzle.error(cur||selector)}if(toString.call(checkSet)==="[object Array]"){if(!prune){results.push.apply(results,checkSet)}else{if(context&&context.nodeType===1){for(i=0;checkSet[i]!=null;i++){if(checkSet[i]&&(checkSet[i]===true||checkSet[i].nodeType===1&&Sizzle.contains(context,checkSet[i]))){results.push(set[i])}}}else{for(i=0;checkSet[i]!=null;i++){if(checkSet[i]&&checkSet[i].nodeType===1){results.push(set[i])}}}}}else{makeArray(checkSet,results)}if(extra){Sizzle(extra,origContext,results,seed);Sizzle.uniqueSort(results)}return results};Sizzle.uniqueSort=function(results){if(sortOrder){hasDuplicate=baseHasDuplicate;results.sort(sortOrder);if(hasDuplicate){for(var i=1;i<results.length;i++){if(results[i]===results[i-1]){results.splice(i--,1)}}}}return results};Sizzle.matches=function(expr,set){return Sizzle(expr,null,null,set)};Sizzle.matchesSelector=function(node,expr){return Sizzle(expr,null,null,[node]).length>0};Sizzle.find=function(expr,context,isXML){var set;if(!expr){return[]}for(var i=0,l=Expr.order.length;i<l;i++){var match,type=Expr.order[i];if((match=Expr.leftMatch[type].exec(expr))){var left=match[1];match.splice(1,1);if(left.substr(left.length-1)!=="\\"){match[1]=(match[1]||"").replace(rBackslash,"");set=Expr.find[type](match,context,isXML);if(set!=null){expr=expr.replace(Expr.match[type],"");break}}}}if(!set){set=typeof context.getElementsByTagName!=="undefined"?context.getElementsByTagName("*"):[]}return{set:set,expr:expr}};Sizzle.filter=function(expr,set,inplace,not){var match,anyFound,old=expr,result=[],curLoop=set,isXMLFilter=set&&set[0]&&Sizzle.isXML(set[0]);while(expr&&set.length){for(var type in Expr.filter){if((match=Expr.leftMatch[type].exec(expr))!=null&&match[2]){var found,item,filter=Expr.filter[type],left=match[1];anyFound=false;match.splice(1,1);if(left.substr(left.length-1)==="\\"){continue}if(curLoop===result){result=[]}if(Expr.preFilter[type]){match=Expr.preFilter[type](match,curLoop,inplace,result,not,isXMLFilter);if(!match){anyFound=found=true}else{if(match===true){continue}}}if(match){for(var i=0;(item=curLoop[i])!=null;i++){if(item){found=filter(item,match,i,curLoop);var pass=not^!!found;if(inplace&&found!=null){if(pass){anyFound=true}else{curLoop[i]=false}}else{if(pass){result.push(item);anyFound=true}}}}}if(found!==undefined){if(!inplace){curLoop=result}expr=expr.replace(Expr.match[type],"");if(!anyFound){return[]}break}}}if(expr===old){if(anyFound==null){Sizzle.error(expr)}else{break}}old=expr}return curLoop};Sizzle.error=function(msg){throw"Syntax error, unrecognized expression: "+msg};var Expr=Sizzle.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(elem){return elem.getAttribute("href")},type:function(elem){return elem.getAttribute("type")}},relative:{"+":function(checkSet,part){var isPartStr=typeof part==="string",isTag=isPartStr&&!rNonWord.test(part),isPartStrNotTag=isPartStr&&!isTag;if(isTag){part=part.toLowerCase()}for(var i=0,l=checkSet.length,elem;i<l;i++){if((elem=checkSet[i])){while((elem=elem.previousSibling)&&elem.nodeType!==1){}checkSet[i]=isPartStrNotTag||elem&&elem.nodeName.toLowerCase()===part?elem||false:elem===part}}if(isPartStrNotTag){Sizzle.filter(part,checkSet,true)}},">":function(checkSet,part){var elem,isPartStr=typeof part==="string",i=0,l=checkSet.length;if(isPartStr&&!rNonWord.test(part)){part=part.toLowerCase();for(;i<l;i++){elem=checkSet[i];if(elem){var parent=elem.parentNode;checkSet[i]=parent.nodeName.toLowerCase()===part?parent:false}}}else{for(;i<l;i++){elem=checkSet[i];if(elem){checkSet[i]=isPartStr?elem.parentNode:elem.parentNode===part}}if(isPartStr){Sizzle.filter(part,checkSet,true)}}},"":function(checkSet,part,isXML){var nodeCheck,doneName=done++,checkFn=dirCheck;if(typeof part==="string"&&!rNonWord.test(part)){part=part.toLowerCase();nodeCheck=part;checkFn=dirNodeCheck}checkFn("parentNode",part,doneName,checkSet,nodeCheck,isXML)},"~":function(checkSet,part,isXML){var nodeCheck,doneName=done++,checkFn=dirCheck;if(typeof part==="string"&&!rNonWord.test(part)){part=part.toLowerCase();nodeCheck=part;checkFn=dirNodeCheck}checkFn("previousSibling",part,doneName,checkSet,nodeCheck,isXML)}},find:{ID:function(match,context,isXML){if(typeof context.getElementById!=="undefined"&&!isXML){var m=context.getElementById(match[1]);return m&&m.parentNode?[m]:[]}},NAME:function(match,context){if(typeof context.getElementsByName!=="undefined"){var ret=[],results=context.getElementsByName(match[1]);for(var i=0,l=results.length;i<l;i++){if(results[i].getAttribute("name")===match[1]){ret.push(results[i])}}return ret.length===0?null:ret}},TAG:function(match,context){if(typeof context.getElementsByTagName!=="undefined"){return context.getElementsByTagName(match[1])}}},preFilter:{CLASS:function(match,curLoop,inplace,result,not,isXML){match=" "+match[1].replace(rBackslash,"")+" ";if(isXML){return match}for(var i=0,elem;(elem=curLoop[i])!=null;i++){if(elem){if(not^(elem.className&&(" "+elem.className+" ").replace(/[\t\n\r]/g," ").indexOf(match)>=0)){if(!inplace){result.push(elem)}}else{if(inplace){curLoop[i]=false}}}}return false},ID:function(match){return match[1].replace(rBackslash,"")},TAG:function(match,curLoop){return match[1].replace(rBackslash,"").toLowerCase()},CHILD:function(match){if(match[1]==="nth"){if(!match[2]){Sizzle.error(match[0])}match[2]=match[2].replace(/^\+|\s*/g,"");var test=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(match[2]==="even"&&"2n"||match[2]==="odd"&&"2n+1"||!/\D/.test(match[2])&&"0n+"+match[2]||match[2]);match[2]=(test[1]+(test[2]||1))-0;match[3]=test[3]-0}else{if(match[2]){Sizzle.error(match[0])}}match[0]=done++;return match},ATTR:function(match,curLoop,inplace,result,not,isXML){var name=match[1]=match[1].replace(rBackslash,"");if(!isXML&&Expr.attrMap[name]){match[1]=Expr.attrMap[name]}match[4]=(match[4]||match[5]||"").replace(rBackslash,"");if(match[2]==="~="){match[4]=" "+match[4]+" "}return match},PSEUDO:function(match,curLoop,inplace,result,not){if(match[1]==="not"){if((chunker.exec(match[3])||"").length>1||/^\w/.test(match[3])){match[3]=Sizzle(match[3],null,null,curLoop)}else{var ret=Sizzle.filter(match[3],curLoop,inplace,true^not);if(!inplace){result.push.apply(result,ret)}return false}}else{if(Expr.match.POS.test(match[0])||Expr.match.CHILD.test(match[0])){return true}}return match},POS:function(match){match.unshift(true);return match}},filters:{enabled:function(elem){return elem.disabled===false&&elem.type!=="hidden"},disabled:function(elem){return elem.disabled===true},checked:function(elem){return elem.checked===true},selected:function(elem){if(elem.parentNode){elem.parentNode.selectedIndex}return elem.selected===true},parent:function(elem){return !!elem.firstChild},empty:function(elem){return !elem.firstChild},has:function(elem,i,match){return !!Sizzle(match[3],elem).length},header:function(elem){return(/h\d/i).test(elem.nodeName)},text:function(elem){var attr=elem.getAttribute("type"),type=elem.type;return elem.nodeName.toLowerCase()==="input"&&"text"===type&&(attr===type||attr===null)},radio:function(elem){return elem.nodeName.toLowerCase()==="input"&&"radio"===elem.type},checkbox:function(elem){return elem.nodeName.toLowerCase()==="input"&&"checkbox"===elem.type},file:function(elem){return elem.nodeName.toLowerCase()==="input"&&"file"===elem.type},password:function(elem){return elem.nodeName.toLowerCase()==="input"&&"password"===elem.type},submit:function(elem){var name=elem.nodeName.toLowerCase();return(name==="input"||name==="button")&&"submit"===elem.type},image:function(elem){return elem.nodeName.toLowerCase()==="input"&&"image"===elem.type},reset:function(elem){var name=elem.nodeName.toLowerCase();return(name==="input"||name==="button")&&"reset"===elem.type},button:function(elem){var name=elem.nodeName.toLowerCase();return name==="input"&&"button"===elem.type||name==="button"},input:function(elem){return(/input|select|textarea|button/i).test(elem.nodeName)},focus:function(elem){return elem===elem.ownerDocument.activeElement}},setFilters:{first:function(elem,i){return i===0},last:function(elem,i,match,array){return i===array.length-1},even:function(elem,i){return i%2===0},odd:function(elem,i){return i%2===1},lt:function(elem,i,match){return i<match[3]-0},gt:function(elem,i,match){return i>match[3]-0},nth:function(elem,i,match){return match[3]-0===i},eq:function(elem,i,match){return match[3]-0===i}},filter:{PSEUDO:function(elem,match,i,array){var name=match[1],filter=Expr.filters[name];if(filter){return filter(elem,i,match,array)}else{if(name==="contains"){return(elem.textContent||elem.innerText||Sizzle.getText([elem])||"").indexOf(match[3])>=0}else{if(name==="not"){var not=match[3];for(var j=0,l=not.length;j<l;j++){if(not[j]===elem){return false}}return true}else{Sizzle.error(name)}}}},CHILD:function(elem,match){var type=match[1],node=elem;switch(type){case"only":case"first":while((node=node.previousSibling)){if(node.nodeType===1){return false}}if(type==="first"){return true}node=elem;case"last":while((node=node.nextSibling)){if(node.nodeType===1){return false}}return true;case"nth":var first=match[2],last=match[3];if(first===1&&last===0){return true}var doneName=match[0],parent=elem.parentNode;if(parent&&(parent.sizcache!==doneName||!elem.nodeIndex)){var count=0;for(node=parent.firstChild;node;node=node.nextSibling){if(node.nodeType===1){node.nodeIndex=++count}}parent.sizcache=doneName}var diff=elem.nodeIndex-last;if(first===0){return diff===0}else{return(diff%first===0&&diff/first>=0)}}},ID:function(elem,match){return elem.nodeType===1&&elem.getAttribute("id")===match},TAG:function(elem,match){return(match==="*"&&elem.nodeType===1)||elem.nodeName.toLowerCase()===match},CLASS:function(elem,match){return(" "+(elem.className||elem.getAttribute("class"))+" ").indexOf(match)>-1},ATTR:function(elem,match){var name=match[1],result=Expr.attrHandle[name]?Expr.attrHandle[name](elem):elem[name]!=null?elem[name]:elem.getAttribute(name),value=result+"",type=match[2],check=match[4];return result==null?type==="!=":type==="="?value===check:type==="*="?value.indexOf(check)>=0:type==="~="?(" "+value+" ").indexOf(check)>=0:!check?value&&result!==false:type==="!="?value!==check:type==="^="?value.indexOf(check)===0:type==="$="?value.substr(value.length-check.length)===check:type==="|="?value===check||value.substr(0,check.length+1)===check+"-":false},POS:function(elem,match,i,array){var name=match[2],filter=Expr.setFilters[name];if(filter){return filter(elem,i,match,array)}}}};var origPOS=Expr.match.POS,fescape=function(all,num){return"\\"+(num-0+1)};for(var type in Expr.match){Expr.match[type]=new RegExp(Expr.match[type].source+(/(?![^\[]*\])(?![^\(]*\))/.source));Expr.leftMatch[type]=new RegExp(/(^(?:.|\r|\n)*?)/.source+Expr.match[type].source.replace(/\\(\d+)/g,fescape))}var makeArray=function(array,results){array=Array.prototype.slice.call(array,0);if(results){results.push.apply(results,array);return results}return array};try{Array.prototype.slice.call(document.documentElement.childNodes,0)[0].nodeType}catch(e){makeArray=function(array,results){var i=0,ret=results||[];if(toString.call(array)==="[object Array]"){Array.prototype.push.apply(ret,array)}else{if(typeof array.length==="number"){for(var l=array.length;i<l;i++){ret.push(array[i])}}else{for(;array[i];i++){ret.push(array[i])}}}return ret}}var sortOrder,siblingCheck;if(document.documentElement.compareDocumentPosition){sortOrder=function(a,b){if(a===b){hasDuplicate=true;return 0}if(!a.compareDocumentPosition||!b.compareDocumentPosition){return a.compareDocumentPosition?-1:1}return a.compareDocumentPosition(b)&4?-1:1}}else{sortOrder=function(a,b){if(a===b){hasDuplicate=true;return 0}else{if(a.sourceIndex&&b.sourceIndex){return a.sourceIndex-b.sourceIndex}}var al,bl,ap=[],bp=[],aup=a.parentNode,bup=b.parentNode,cur=aup;if(aup===bup){return siblingCheck(a,b)}else{if(!aup){return -1}else{if(!bup){return 1}}}while(cur){ap.unshift(cur);cur=cur.parentNode}cur=bup;while(cur){bp.unshift(cur);cur=cur.parentNode}al=ap.length;bl=bp.length;for(var i=0;i<al&&i<bl;i++){if(ap[i]!==bp[i]){return siblingCheck(ap[i],bp[i])}}return i===al?siblingCheck(a,bp[i],-1):siblingCheck(ap[i],b,1)};siblingCheck=function(a,b,ret){if(a===b){return ret}var cur=a.nextSibling;while(cur){if(cur===b){return -1}cur=cur.nextSibling}return 1}}Sizzle.getText=function(elems){var ret="",elem;for(var i=0;elems[i];i++){elem=elems[i];if(elem.nodeType===3||elem.nodeType===4){ret+=elem.nodeValue}else{if(elem.nodeType!==8){ret+=Sizzle.getText(elem.childNodes)}}}return ret};(function(){var form=document.createElement("div"),id="script"+(new Date()).getTime(),root=document.documentElement;form.innerHTML="<a name='"+id+"'/>";root.insertBefore(form,root.firstChild);if(document.getElementById(id)){Expr.find.ID=function(match,context,isXML){if(typeof context.getElementById!=="undefined"&&!isXML){var m=context.getElementById(match[1]);return m?m.id===match[1]||typeof m.getAttributeNode!=="undefined"&&m.getAttributeNode("id").nodeValue===match[1]?[m]:undefined:[]}};Expr.filter.ID=function(elem,match){var node=typeof elem.getAttributeNode!=="undefined"&&elem.getAttributeNode("id");return elem.nodeType===1&&node&&node.nodeValue===match}}root.removeChild(form);root=form=null})();(function(){var div=document.createElement("div");div.appendChild(document.createComment(""));if(div.getElementsByTagName("*").length>0){Expr.find.TAG=function(match,context){var results=context.getElementsByTagName(match[1]);if(match[1]==="*"){var tmp=[];for(var i=0;results[i];i++){if(results[i].nodeType===1){tmp.push(results[i])}}results=tmp}return results}}div.innerHTML="<a href='#'></a>";if(div.firstChild&&typeof div.firstChild.getAttribute!=="undefined"&&div.firstChild.getAttribute("href")!=="#"){Expr.attrHandle.href=function(elem){return elem.getAttribute("href",2)}}div=null})();if(document.querySelectorAll){(function(){var oldSizzle=Sizzle,div=document.createElement("div"),id="__sizzle__";div.innerHTML="<p class='TEST'></p>";if(div.querySelectorAll&&div.querySelectorAll(".TEST").length===0){return}Sizzle=function(query,context,extra,seed){context=context||document;if(!seed&&!Sizzle.isXML(context)){var match=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(query);if(match&&(context.nodeType===1||context.nodeType===9)){if(match[1]){return makeArray(context.getElementsByTagName(query),extra)}else{if(match[2]&&Expr.find.CLASS&&context.getElementsByClassName){return makeArray(context.getElementsByClassName(match[2]),extra)}}}if(context.nodeType===9){if(query==="body"&&context.body){return makeArray([context.body],extra)}else{if(match&&match[3]){var elem=context.getElementById(match[3]);if(elem&&elem.parentNode){if(elem.id===match[3]){return makeArray([elem],extra)}}else{return makeArray([],extra)}}}try{return makeArray(context.querySelectorAll(query),extra)}catch(qsaError){}}else{if(context.nodeType===1&&context.nodeName.toLowerCase()!=="object"){var oldContext=context,old=context.getAttribute("id"),nid=old||id,hasParent=context.parentNode,relativeHierarchySelector=/^\s*[+~]/.test(query);if(!old){context.setAttribute("id",nid)}else{nid=nid.replace(/'/g,"\\$&")}if(relativeHierarchySelector&&hasParent){context=context.parentNode}try{if(!relativeHierarchySelector||hasParent){return makeArray(context.querySelectorAll("[id='"+nid+"'] "+query),extra)}}catch(pseudoError){}finally{if(!old){oldContext.removeAttribute("id")}}}}}return oldSizzle(query,context,extra,seed)};for(var prop in oldSizzle){Sizzle[prop]=oldSizzle[prop]}div=null})()}(function(){var html=document.documentElement,matches=html.matchesSelector||html.mozMatchesSelector||html.webkitMatchesSelector||html.msMatchesSelector;if(matches){var disconnectedMatch=!matches.call(document.createElement("div"),"div"),pseudoWorks=false;try{matches.call(document.documentElement,"[test!='']:sizzle")}catch(pseudoError){pseudoWorks=true}Sizzle.matchesSelector=function(node,expr){expr=expr.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!Sizzle.isXML(node)){try{if(pseudoWorks||!Expr.match.PSEUDO.test(expr)&&!/!=/.test(expr)){var ret=matches.call(node,expr);if(ret||!disconnectedMatch||node.document&&node.document.nodeType!==11){return ret}}}catch(e){}}return Sizzle(expr,null,null,[node]).length>0}}})();(function(){var div=document.createElement("div");div.innerHTML="<div class='test e'></div><div class='test'></div>";if(!div.getElementsByClassName||div.getElementsByClassName("e").length===0){return}div.lastChild.className="e";if(div.getElementsByClassName("e").length===1){return}Expr.order.splice(1,0,"CLASS");Expr.find.CLASS=function(match,context,isXML){if(typeof context.getElementsByClassName!=="undefined"&&!isXML){return context.getElementsByClassName(match[1])}};div=null})();function dirNodeCheck(dir,cur,doneName,checkSet,nodeCheck,isXML){for(var i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];if(elem){var match=false;elem=elem[dir];while(elem){if(elem.sizcache===doneName){match=checkSet[elem.sizset];break}if(elem.nodeType===1&&!isXML){elem.sizcache=doneName;elem.sizset=i}if(elem.nodeName.toLowerCase()===cur){match=elem;break}elem=elem[dir]}checkSet[i]=match}}}function dirCheck(dir,cur,doneName,checkSet,nodeCheck,isXML){for(var i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];if(elem){var match=false;elem=elem[dir];while(elem){if(elem.sizcache===doneName){match=checkSet[elem.sizset];break}if(elem.nodeType===1){if(!isXML){elem.sizcache=doneName;elem.sizset=i}if(typeof cur!=="string"){if(elem===cur){match=true;break}}else{if(Sizzle.filter(cur,[elem]).length>0){match=elem;break}}}elem=elem[dir]}checkSet[i]=match}}}if(document.documentElement.contains){Sizzle.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):true)}}else{if(document.documentElement.compareDocumentPosition){Sizzle.contains=function(a,b){return !!(a.compareDocumentPosition(b)&16)}}else{Sizzle.contains=function(){return false}}}Sizzle.isXML=function(elem){var documentElement=(elem?elem.ownerDocument||elem:0).documentElement;return documentElement?documentElement.nodeName!=="HTML":false};var posProcess=function(selector,context){var match,tmpSet=[],later="",root=context.nodeType?[context]:context;while((match=Expr.match.PSEUDO.exec(selector))){later+=match[0];selector=selector.replace(Expr.match.PSEUDO,"")}selector=Expr.relative[selector]?selector+"*":selector;for(var i=0,l=root.length;i<l;i++){Sizzle(selector,root[i],tmpSet)}return Sizzle.filter(later,tmpSet)};window.Sizzle=Sizzle})();xRTML.Tags.AbstractMouseTag=xRTML.Tag.makeSubclass();xRTML.Tags.AbstractMouseTag.prototype.init=function(tagObject){var self=this;xRTML.Tag.prototype.init.call(this,tagObject);var periodicity=xRTML.Common.Converter.toNumber(tagObject.periodicity);if(periodicity&&periodicity>10){this.periodicity=periodicity}else{this.periodicity=10}if(this.target){this.targetElements=this.target;if(this.targetElements.length>0){this.currentTargetElement=this.targetElements[0]}else{xRTML.ErrorHandler().tagError(new Error("The selector chosen as target is not found."))}}else{this.currentTargetElement=document.body}this.centerWidth=xRTML.Common.Converter.toBoolean(tagObject.centerwidth);if(typeof this.centerWidth=="undefined"){this.centerWidth=false}this.centerHeight=xRTML.Common.Converter.toBoolean(tagObject.centerheight);if(typeof this.centerHeight=="undefined"){this.centerHeight=false}else{this.offSetXUDF=tagObject.offsetx}this.offSetYUDF=tagObject.offsety;this.setOffSetValues=function(){var self=this;var modelbox={margin:{top:(self.currentTargetElement.style.marginTop=="")?0:parseInt(self.currentTargetElement.style.marginTop.replace("px","")),right:(self.currentTargetElement.style.marginRight=="")?0:parseInt(self.currentTargetElement.style.marginRight.replace("px","")),bottom:(self.currentTargetElement.style.marginBottom=="")?0:parseInt(self.currentTargetElement.style.marginBottom.replace("px","")),left:(self.currentTargetElement.style.marginLeft=="")?0:parseInt(self.currentTargetElement.style.marginLeft.replace("px",""))},padding:{top:(self.currentTargetElement.style.paddingTop=="")?0:parseInt(self.currentTargetElement.style.paddingTop.replace("px","")),right:(self.currentTargetElement.style.paddingRight=="")?0:parseInt(self.currentTargetElement.style.paddingRight.replace("px","")),bottom:(self.currentTargetElement.style.paddingBottom=="")?0:parseInt(self.currentTargetElement.style.paddingBottom.replace("px","")),left:(self.currentTargetElement.style.paddingLeft=="")?0:parseInt(self.currentTargetElement.style.paddingLeft.replace("px",""))}};self.offSetX=(typeof self.offSetXUDF=="undefined")?((modelbox.margin.right+modelbox.padding.right)-(modelbox.margin.left+modelbox.padding.left)):parseInt(self.offSetXUDF);self.offSetY=(typeof self.offSetYUDF=="undefined")?((modelbox.margin.bottom+modelbox.padding.bottom)-(modelbox.margin.top+modelbox.padding.top)):parseInt(self.offSetYUDF)};this.xCoordinate=1;this.yCoordinate=1;this.storedXCoordinate=0;this.storedYCoordinate=0;this.windowHeight=document.documentElement.clientHeight;this.windowWidth=document.documentElement.clientWidth;this.centerXCoordinate=document.documentElement.scrollWidth/2;this.centerYCoordinate=document.documentElement.scrollHeight/2;Events.Manager.addEventListener(window,"resize",function(e){self.windowHeight=document.documentElement.clientHeight;self.windowWidth=document.documentElement.clientWidth;self.centerXCoordinate=document.documentElement.scrollWidth/2;self.centerYCoordinate=document.documentElement.scrollHeight/2});this.responseProcessed=true};xRTML.Tags.AbstractMouseTag.prototype.updateMouseCoordinates=function(e){var that=this;var IE=document.all?true:false;if(that.previousMouseMoveListener){that.previousMouseMoveListener()}that.setOffSetValues();if(that.currentTargetElement.tagName.toLowerCase()=="body"){if(IE){that.xCoordinate=event.clientX+document.body.scrollLeft+document.documentElement.scrollLeft+that.offSetX;that.yCoordinate=event.clientY+document.body.scrollTop+document.documentElement.scrollTop+that.offSetY}else{that.xCoordinate=e.pageX+that.offSetX;that.yCoordinate=e.pageY+that.offSetY}}else{if(IE){that.xCoordinate=(event.clientX+document.body.scrollLeft+document.documentElement.scrollLeft)-event.srcElement.offsetLeft+that.offSetX;that.yCoordinate=(event.clientY+document.body.scrollTop+document.documentElement.scrollTop)-event.srcElement.offsetTop+that.offSetY}else{that.xCoordinate=e.pageX-e.target.offsetLeft+that.offSetX;that.yCoordinate=e.pageY-e.target.offsetTop+that.offSetY}}};xRTML.Tags.AbstractMouseTag.prototype.activateSendCoordinates=function(message){var that=this;var checkCoordinates=setInterval(function(){if(that.active){if((that.xCoordinate!=that.storedXCoordinate)&&(that.yCoordinate!=that.storedYCoordinate)&&that.responseProcessed){var xPosition=that.centerWidth?(that.centerXCoordinate-that.xCoordinate):that.xCoordinate;var yPosition=that.centerHeight?(that.centerYCoordinate-that.yCoordinate):that.yCoordinate;var data={};data.targetSelector=that.targetSelector;data.event="mousemove";data.xCoordinate=xPosition;data.yCoordinate=yPosition;for(var iter=0;iter<that.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(that.triggers[iter].name,"",data,that.internalId);xRTML.sendMessage(that.channelId,xrtmlMessage)}that.storedXCoordinate=that.xCoordinate;that.storedYCoordinate=that.yCoordinate;that.responseProcessed=false}}else{clearInterval(checkCoordinates)}},this.periodicity)};xRTML.Tags.BroadCast=xRTML.Tag.makeSubclass();xRTML.registerTag("BroadCast");xRTML.Tags.BroadCast.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);var self=this;var dispatcherElements=tagObject.dispatchers;for(var i=0;i<dispatcherElements.length;++i){xRTML.Console.debug("Create dispatcher["+i+"]");var dispatcher=new xRTML.Tags.BroadCast.Dispatcher(dispatcherElements[i],this)}this.process=function(){}};xRTML.Tags.BroadCast.prototype.relayMessage=function(message){xRTML.sendMessage(this.channelId,message)};xRTML.Tags.BroadCast.Dispatcher=function(dispatcherElement,parent){this.target=dispatcherElement.target;this.event=dispatcherElement.event;this.message=dispatcherElement.message;this.callback=dispatcherElement.callback;this.timeout=dispatcherElement.timeout||0;this.interval=dispatcherElement.interval;this.limit=dispatcherElement.limit||0;var self=this;var messageDispatcher=function(){var messages=[];if(self.callback){messages.push(new Function("return "+self.callback+"();")())}if(self.message){messages.push(self.message)}for(var i=0;i<messages.length;++i){parent.relayMessage(messages[i])}};if(self.timeout>0||self.interval){window.onSubscribed=function(channel){if(channel==parent.channelId){var cont=0;var recurse=function(){if(self.limit>0&&cont>=self.limit){return}setTimeout(function(){messageDispatcher();cont++;recurse()},self.interval)};recurse()}}}else{if(this.target&&this.event){var targetElement=Sizzle(this.target)[0];Events.Manager.addEventListener(targetElement,this.event,function(){messageDispatcher()})}else{messageDispatcher()}}};xRTML.Tags.BroadCast.Dispatcher.prototype={constructor:xRTML.Tags.BroadCast.Dispatcher};xRTML.Tags.Execute=xRTML.Tag.makeSubclass();xRTML.registerTag("Execute");xRTML.Tags.Execute.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);this.callback=tagObject.callback;this.process=function(message){this.delegate(message)}};xRTML.Tags.Execute.prototype.delegate=function(message){var callbackMethod=message.callback?message.callback:this.callback;var fn=new Function("message","return "+callbackMethod+"(message);");return fn(message)};xRTML.Tags.KeyTracker=xRTML.Tag.makeSubclass();xRTML.registerTag("KeyTracker");xRTML.Tags.KeyTracker.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);xRTML.Common.Validator.validateRequired(tagObject.channelid,true,"A channelid attribute is required for keytracker.");this.sendAll=xRTML.Common.Converter.toBoolean(tagObject.sendall);if((typeof this.sendAll=="undefined")){this.sendAll=false}xRTML.Common.Validator.validateRequired(this.target,true,"Attribute target on a keytracker tag is undefined");if(this.target.length>0){this.targetElement=this.target[0]}xRTML.Common.Validator.validateRequired(this.targetElement,true,"The attribute target on a keytracker tag contains an invalid selector.");var self=this;this.process=function(){};this.addEventListener("active",function(active){if(active){self.activateTracker()}});if(this.active){this.activate(true)}};xRTML.Tags.KeyTracker.prototype.activateTracker=function(){var self=this;Events.Manager.addEventListener(this.targetElement,"keypress",function(event){var message=xRTML.createMessage("","delegate",{},self.internalId);var unicode=event.keyCode?event.keyCode:event.charCode;var key=String.fromCharCode(unicode);if(self.sendAll){if((typeof self.targetElement.value)=="undefined"){var text=self.targetElement.innerHTML;var re=new RegExp("(&nbsp;)","g");message.data.value=xRTML.Common.Util.regexReplaceAll(text,re,"")+key}else{var text=self.targetElement.value;message.data.value=text+key}}else{message.data.value=key}for(var iter=0;iter<self.triggers.length;iter++){message.trigger=self.triggers[iter].name;xRTML.sendMessage(self.channelId,message)}})};xRTML.Tags.MouseLive=xRTML.Tags.AbstractMouseTag.makeSubclass();xRTML.registerTag("MouseLive");xRTML.Tags.MouseLive.prototype.init=function(tagObject){xRTML.Tags.AbstractMouseTag.prototype.init.call(this,tagObject);xRTML.Common.Validator.validateRequired(tagObject.role,true," Tag mouselive requires the property role to function properly.");this.role=tagObject.role;if(this.role=="sender"){xRTML.Common.Validator.validateRequired(tagObject.channelid,true," Tag mouselive requires the property channelid to function properly.")}var self=this;this.addEventListener("active",function(e){if(e.active){self.activateMouseTag()}else{self.deactivateMouseTag()}});if(this.active){this.activate(this.active)}this.process=function(message){var data=message.data;if(this.role=="receiver"&&this.receiverDiv){var x=data.xCoordinate;var windowWidth,windowHeight;if(this.windowWidth!=0){windowWidth=this.windowWidth;windowHeight=this.windowHeight}else{windowWidth=document.documentElement.scrollWidth;windowHeight=document.documentElement.scrollHeight}if(this.centerWidth&&(x<(0-(windowWidth/2)))){x=(0-(windowWidth/2))+this.receiverDiv.width}if(this.centerWidth&&(x>(windowWidth/2))){x=windowWidth/2}var moveXTo=this.centerWidth?(this.centerXCoordinate-x):data.xCoordinate;var moveYTo=this.centerHeight?(this.centerYCoordinate-data.yCoordinate):data.yCoordinate;var scrollXTo=0;var scrollYTo=0;scrollXTo=moveXTo-(windowWidth-(windowWidth/2));if(scrollXTo<0){scrollXTo=0}scrollYTo=moveYTo-(windowHeight-(windowHeight/2));if(scrollYTo<0){scrollYTo=0}window.scrollTo(scrollXTo,scrollYTo);this.setOffSetValues();this.receiverDiv.style.left=(moveXTo-this.offSetX)+"px";this.receiverDiv.style.top=(moveYTo-this.offSetY)+"px"}this.responseProcessed=true}};xRTML.Tags.MouseLive.prototype.activateMouseTag=function(){var that=this;if(that.role=="sender"){var updateMouseCoordinatesCall=function(e){that.updateMouseCoordinates.call(that,e)};Events.Manager.addEventListener(that.currentTargetElement,"mousemove",updateMouseCoordinatesCall);that.activateSendCoordinates.call(that)}else{if(that.role=="receiver"){that.activateReceiveCoordinates()}}var updateCenterCoordinates=function(e){that.centerXCoordinate=document.documentElement.scrollWidth/2;that.centerYCoordinate=document.documentElement.scrollHeight/2};Events.Manager.addEventListener(window,"resize",updateCenterCoordinates)};xRTML.Tags.MouseLive.prototype.deactivateMouseTag=function(){if(document.getElementById("xRTMLReceiverPointer")){this.currentTargetElement.removeChild(this.receiverDiv)}};xRTML.Tags.MouseLive.prototype.activateReceiveCoordinates=function(){this.receiverDiv=document.getElementById("xRTMLReceiverPointer");if(!this.receiverDiv){this.receiverDiv=document.createElement("div");this.receiverDiv.id="xRTMLReceiverPointer";this.receiverDiv.style.position="absolute";this.currentTargetElement.appendChild(this.receiverDiv)}};xRTML.Tags.MouseTracker=xRTML.Tags.AbstractMouseTag.makeSubclass();xRTML.registerTag("MouseTracker");xRTML.Tags.MouseTracker.prototype.init=function(tagObject){xRTML.Tags.AbstractMouseTag.prototype.init.call(this,tagObject);this.mouseMoveRegisteredOnce;this.sendMouseMoveCoordinatesAlways=true;var self=this;this.targetSelector=tagObject.target;this.addEventListener("active",function(active){if(active){self.activateMouseTag()}});if(this.active){this.activate(true)}this.process=function(message){this.responseProcessed=true}};xRTML.Tags.MouseTracker.prototype.activateMouseTag=function(){this.attachAllListeners()};xRTML.Tags.MouseTracker.prototype.deactivateMouseTag=function(){this.detachAllListeners()};xRTML.Tags.MouseTracker.prototype.attachAllListeners=function(){var that=this;var callOnEvent=function(event){var IE=document.all?true:false;var eventType=IE?window.event.type:event.type;eventType=eventType.replace("on","");var data={};data.targetSelector=that.targetSelector;data.event=eventType;data.xCoordinate=that.xCoordinate;data.yCoordinate=that.yCoordinate;for(var iter=0;iter<that.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(that.triggers[iter].name,"",data);xRTML.sendMessage(that.channelId,xrtmlMessage)}};var mouseMoveCallOnEvent=function(e){that.updateMouseCoordinates.call(that,e);var data={};data.targetSelector=that.targetSelector;data.event="mousemove";data.xCoordinate=that.xCoordinate;data.yCoordinate=that.yCoordinate;if(!that.mouseMoveRegisteredOnce){for(var iter=0;iter<that.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(that.triggers[iter].name,"",data);xRTML.sendMessage(that.channelId,xrtmlMessage)}that.mouseMoveRegisteredOnce=true}if(that.sendMouseMoveCoordinatesAlways){that.activateSendCoordinates.call(that)}};Events.Manager.addEventListener(that.currentTargetElement,"mousemove",mouseMoveCallOnEvent);Events.Manager.addEventListener(that.currentTargetElement,"mouseover",callOnEvent);Events.Manager.addEventListener(that.currentTargetElement,"click",callOnEvent);Events.Manager.addEventListener(that.currentTargetElement,"mouseout",callOnEvent);Events.Manager.addEventListener(that.currentTargetElement,"mouseup",callOnEvent);Events.Manager.addEventListener(that.currentTargetElement,"mousedown",callOnEvent)};xRTML.Tags.Placeholder=xRTML.Tag.makeSubclass();xRTML.registerTag("Placeholder");xRTML.Tags.Placeholder.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);if(tagObject.template){var templateTag=tagObject.template}else{xRTML.ErrorHandler().tagError(new Error("xrtml:placeholder tag requires one and only one xrtml:template tag."))}this.template=templateTag.content.trim().replace("<!--","").replace("-->","")};xRTML.Tags.Placeholder.prototype.insert=function(data){var message,content;message=data.data;content=this.template;for(var key in message){var reTag=new RegExp("\\[xrtml:"+key+"\\]","gi");var text=message[key];content=content.replace(reTag,text);var reProp=new RegExp("\\[xrtml:"+key+"\\]","gi");content=content.replace(reProp,message[key])}var div=document.createElement("div");div.innerHTML=content;var elements=div.childNodes;xRTML.Common.Array.forEach(this.target,function(item,index){item.innerHTML=content})};xRTML.Tags.Placeholder.prototype.remove=function(data){};xRTML.Tags.Chart=xRTML.Tag.makeSubclass();xRTML.registerTag("Chart");xRTML.Tags.Chart.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);var self=this;xRTML.Common.Validator.validateRequired(tagObject.chartingplatform,true," chartingplatform is required for a chart tag.");this.getDataUrl=tagObject.getdataurl;this.chartingPlatform=tagObject.chartingplatform;this.configFunction=tagObject.configfunction?(typeof tagObject.configfunction=="function"?tagObject.configfunction:new Function("","return "+tagObject.configfunction+"();")):null;if(this.configFunction){this.configObject=this.configFunction.call(window)}else{this.configObject=this.buildDefaultConfigObject(tagObject.dataitems)}if(this.target){this.targetElement=this.target[0]}else{this.targetElement=document.getElementById(this.configObject.chart.renderTo)}var configureJQueryEffects=function(){if(tagObject.jqueryeffects&&tagObject.jqueryeffects.length>0){self.jQueryEffectManagerInstance=xRTML.JQueryEffectManager.getInstance(self);self.jQueryEffectManagerInstance.init(tagObject.jqueryeffects);self.jQueryEffectsConfig={};for(var i=0;i<tagObject.jqueryeffects.length;i++){var effect=tagObject.jqueryeffects[i];var effectId=effect.id;var targetSelector;if(effect.target){targetSelector=effect.target}else{targetSelector=".xRTMLDataItemValue"}if(self.targetElement){var targetElements=Sizzle(targetSelector,self.targetElement)}if(!self.jQueryEffectsConfig[effectId]){self.jQueryEffectsConfig[effectId]=[]}for(var it=0;it<targetElements.length;it++){self.jQueryEffectsConfig[effectId].push(targetElements[it])}}}};var getDataPriv=function(){var xhr=new xRTML.Common.xhr("get",self.getDataUrl,function(result){if(this.readyState==4){if(this.status==200){self.updateSeriesData({data:{v:result.xhr.responseText}})}else{xRTML.ErrorHandler().tagError(new Error(this.responseText))}}});xhr.send(null)};this.addEventListener("active",function(active){if(active){self.chart=xRTML.Tags.Chart.ChartFactory.createChart(self.chartingPlatform,self.configObject);var highstockEls=Sizzle('svg text tspan:contains("Highcharts") , svg text tspan:contains("Highstock")');for(var i=0,len=highstockEls.length;i<len;i++){highstockEls[i].style.display="none"}if(self.chart.addEventListener){self.chart.addEventListener("chartRendered",function(){configureJQueryEffects();if(self.getDataUrl){getDataPriv()}self.chart.addEventListener("valueUpdate",function(data){self.runJQueryEffects(data.index)});self.onActivated(self.active)})}else{if(self.getDataUrl){getDataPriv()}self.onActivated(this.active)}}},false);if(this.active){this.activate()}};xRTML.Tags.Chart.ChartFactory=(function(){return{createChart:function(chartType,chartConfig){switch(chartType){case"highcharts":return new Highcharts.Chart(chartConfig);break;case"htmlchart":return new xRTML.Tags.Chart.HTMLChart(chartConfig);break}}}})();xRTML.Tags.Chart.HTMLChart=function(chartConfig){new Events.Provider(this);var self=this;var Point=function(value){this.config=value;this.update=function(newValue){this.config=newValue;self.redraw()}};var convertConfigObjectSeriesToChartSeries=function(series){var newSeries=[];for(var i=0,len=series.length;i<len;i++){var serie={};serie.name=series[i].name;serie.data=[];serie.data.push(new Point(series[i].data[0]));newSeries.push(serie)}return newSeries};this.configObject=chartConfig;this.series=convertConfigObjectSeriesToChartSeries(self.configObject.series);this.render=function(){self.chartElement=document.createElement("div");var target;if((typeof self.configObject.chart.renderTo!="undefined")&&self.configObject.chart.renderTo!=""){target=document.getElementById(self.configObject.chart.renderTo)}else{target=document.body}target.appendChild(self.chartElement);self.chartElement.setAttribute("id","xRTML"+target.id+"Chart");self.chartElement.setAttribute("class","xRTMLChart");var title=self.configObject.title.text;if((typeof title!="undefined")&&(title!="")){var titleElement=document.createElement("h1");xRTML.Common.DOM.setText(titleElement,title);self.chartElement.appendChild(titleElement)}var subTitle=self.configObject.subtitle.text;if((typeof subTitle!="undefined")&&(subTitle!="")){var subtTitleElement=document.createElement("h2");xRTML.Common.DOM.setText(subtTitleElement,subTitle);self.chartElement.appendChild(subtTitleElement)}var valuesContainerElement=document.createElement("div");valuesContainerElement.setAttribute("class","values");self.chartElement.appendChild(valuesContainerElement);var legendElement=document.createElement("ul");legendElement.setAttribute("class","legend");valuesContainerElement.appendChild(legendElement);var legendName=self.configObject.yAxis.title.text;if((typeof legendName!="undefined")&&(legendName!="")){var legendNameContainerElement=document.createElement("li");legendElement.appendChild(legendNameContainerElement);var legendNameElement=document.createElement("span");xRTML.Common.DOM.setText(legendNameElement,legendName);legendNameContainerElement.appendChild(legendNameElement)}for(var i=10;i>=0;i--){var scaleElement=document.createElement("li");scaleElement.setAttribute("class","xRTMLScaleNumber");xRTML.Common.DOM.setText(scaleElement,i);legendElement.appendChild(scaleElement)}var graphElement=document.createElement("ul");graphElement.setAttribute("class","graph");valuesContainerElement.appendChild(graphElement);var itemsContainerElement=document.createElement("div");itemsContainerElement.setAttribute("class","items");self.chartElement.appendChild(itemsContainerElement);if(self.configObject.xAxis&&self.configObject.xAxis.categories&&self.configObject.xAxis.categories.length>0){var itemsTitle=self.configObject.xAxis.categories[0];var itemsTitleElement=document.createElement("strong");xRTML.Common.DOM.setText(itemsTitleElement,itemsTitle);itemsContainerElement.appendChild(itemsTitleElement)}var itemsListElement=document.createElement("ul");itemsContainerElement.appendChild(itemsListElement);var percentagesListElement=document.createElement("ul");itemsContainerElement.appendChild(percentagesListElement);var series=self.configObject.series;if((typeof series!="undefined")&&(series.length>0)){for(var i=0,len=series.length;i<len;i++){var valueContainerElement=document.createElement("li");valuesContainerElement.appendChild(valueContainerElement);var valueElement=document.createElement("span");valueContainerElement.appendChild(valueElement);valueElement.setAttribute("class","xRTMLDataItemValue");graphElement.appendChild(valueContainerElement);var itemContainerElement=document.createElement("li");itemsListElement.appendChild(itemContainerElement);var itemElement=document.createElement("span");itemContainerElement.appendChild(itemElement);itemElement.setAttribute("class","xRTMLDataItem");xRTML.Common.DOM.setText(itemElement,series[i].name);var percentageContainerElement=document.createElement("li");percentagesListElement.appendChild(percentageContainerElement);var percentageElement=document.createElement("span");percentageContainerElement.appendChild(percentageElement);var percentageElementHelper=document.createElement("em");percentageElement.appendChild(percentageElementHelper);percentageElementHelper.setAttribute("class","xRTMLDataItemPercentage")}}this.redraw();setTimeout(function(){self.dispatchEvent("chartRendered")},50)};this.redraw=function(){var dataTotalValue=0;var highestDataValue=0;var decimalPlaces=1;var dataItemElements=xRTML.Common.DOM.getElementsByClassName(self.chartElement,"xRTMLDataItemValue");var dataItemPercentageElements=xRTML.Common.DOM.getElementsByClassName(self.chartElement,"xRTMLDataItemPercentage");var scaleListItems=xRTML.Common.DOM.getElementsByClassName(self.chartElement,"xRTMLScaleNumber");for(var i=0,len=self.series.length;i<len;i++){var serie=self.series[i];var value=serie.data[0].config;dataTotalValue+=value;if(highestDataValue<value){highestDataValue=value}}var highestDataValueNearestTenth=Math.ceil(highestDataValue/10)*10;for(var i=0,len=self.series.length;i<len;i++){var serie=self.series[i];var value=serie.data[0].config;if(value&&dataTotalValue){var realPercentage=Math.round(((value/dataTotalValue)*100)*Math.pow(10,decimalPlaces))/Math.pow(10,decimalPlaces)}if(value&&highestDataValueNearestTenth){var percentageForBarHeight=Math.round((value/highestDataValueNearestTenth)*100)}var currentValue;try{currentValue=xRTML.Common.DOM.getText(dataItemElements[i]);currentValueAsNumber=xRTML.Common.Converter.toNumber(currentValue)}catch(err){}xRTML.Common.DOM.setText(dataItemElements[i],value);if(!realPercentage){realPercentage=0}xRTML.Common.DOM.setText(dataItemPercentageElements[i],realPercentage+" %");var increaseBy=200*(percentageForBarHeight/100);if(increaseBy){dataItemElements[i].style.paddingTop=increaseBy+"px"}if(currentValue&&currentValueAsNumber&&(currentValueAsNumber<value)){this.dispatchEvent("valueUpdate",{index:i})}}var firstScaleNumber=highestDataValueNearestTenth/(scaleListItems.length-1);if(highestDataValueNearestTenth>=10){for(var i=0;i<scaleListItems.length;i++){var scaleListItem=scaleListItems[i];var scaleNumber=firstScaleNumber*((scaleListItems.length-1)-i);xRTML.Common.DOM.setText(scaleListItem,Math.round(scaleNumber))}}};this.render()};xRTML.Tags.Chart.prototype.buildDefaultConfigObject=function(dataItems){var series=[];for(var i=0,len=dataItems.length;i<len;i++){var serie={};serie.name=dataItems[i].name;serie.data=[];var dataValue=xRTML.Common.Converter.toNumber(dataItems[i].value);serie.data.push(dataValue);series.push(serie)}var configObject={chart:{renderTo:"container",defaultSeriesType:"column"},title:{text:""},subtitle:{text:""},xAxis:{categories:[""]},yAxis:{min:0,title:{text:""}},legend:{layout:"vertical",backgroundColor:"#FFFFFF",align:"left",verticalAlign:"top",x:100,y:70,floating:true,shadow:true},tooltip:{formatter:function(){return""+this.x+": "+this.y+""}},plotOptions:{column:{pointPadding:0.2,borderWidth:0}},series:series};configObject.series=series;return configObject};xRTML.Tags.Chart.prototype.getChart=function(){return this.chart};xRTML.Tags.Chart.prototype.incrementSingleDataItem=function(message){var seriesIndex=message.data.i;var dataIndex=message.data.d;var incrementBy=message.data.v;var point=this.getChart().series[seriesIndex].data[dataIndex];if(xRTML.Common.Validator.validateNumeric(incrementBy)){incrementBy=xRTML.Common.Converter.toNumber(incrementBy);var currentValue=xRTML.Common.Converter.toNumber(point.config);point.update(currentValue+incrementBy)}else{if(typeof incrementBy=="object"){for(var i=0,len=incrementBy.length;i<len;i++){if(xRTML.Common.Validator.validateNumeric(incrementBy[i])){var currentValue=xRTML.Common.Converter.toNumber(point.config[i])||point.config.y;incrementBy.splice(i,1,xRTML.Common.Converter.toNumber(incrementBy[i])+currentValue);point.update(incrementBy)}}}else{xRTML.ErrorHandler().tagError("incrementSingleDataItem can only be used to increment numbers.")}}};xRTML.Tags.Chart.prototype.addDataItem=function(message){var seriesIndex=message.data.i;var dataItem=message.data.v;var newPointConfig=[];var data=this.getChart().series[seriesIndex].data;var lastPoint=data[data.length-1];var lastPointConfig=lastPoint.config;if(typeof lastPointConfig=="number"){newPointConfig=xRTML.Common.Converter.toNumber(dataItem)}else{for(var i=0,len=lastPointConfig.length;i<len;i++){var pointConfigValue=lastPointConfig[i];if(typeof pointConfigValue=="number"){newPointConfig.push(xRTML.Common.Converter.toNumber(dataItem[i]))}else{newPointConfig.push(dataItem[i])}}}this.getChart().series[seriesIndex].addPoint(newPointConfig)};xRTML.Tags.Chart.prototype.updateDataItemValue=function(message){var seriesIndex=message.data.i;var dataIndex=message.data.d;var value=message.data.v;try{var point=this.getChart().series[seriesIndex].data[dataIndex];if(typeof point.config=="number"){point.update(xRTML.Common.Converter.toNumber(value))}else{point.update(value)}}catch(err){xRTML.ErrorHandler().tagError(err)}};xRTML.Tags.Chart.prototype.updateDataItem=function(message){var seriesIndex=message.data.i;var dataItem=message.data.v;try{var data=this.getChart().series[seriesIndex].data;for(var it=0,leng=data.length;it<leng;it++){var point=data[it];var pointConfig=point.config;var newPointConfig=[];for(var iter=0,len=pointConfig.length;iter<len;iter++){try{var pointConfigValue=pointConfig[iter];if(typeof pointConfigValue=="number"){newPointConfig.push(xRTML.Common.Converter.toNumber(dataItem[it][iter]))}else{newPointConfig.push(dataItem[it][iter])}}catch(err){xRTML.ErrorHandler().tagError(err)}}point.update(newPointConfig)}}catch(err){xRTML.ErrorHandler().tagError(err)}};xRTML.Tags.Chart.prototype.updateSeriesData=function(message){var dataArray=typeof message.data.v=="string"?JSON.parse(message.data.v):message.data.v;for(var i=0,len=this.getChart().series.length;i<len;i++){var data=this.getChart().series[i].data;for(var it=0,leng=data.length;it<leng;it++){try{var point=data[it];if(typeof point.config=="number"){var newPoint=xRTML.Common.Converter.toNumber(dataArray[i][it])}else{if(typeof point.config=="object"){for(var iter=0,lng=dataArray[i][it].length;iter<lng;iter++){if(xRTML.Common.Validator.validateNumeric(dataArray[i][it][iter])){dataArray[i][it].splice(iter,1,xRTML.Common.Converter.toNumber(dataArray[i][it][iter]));var newPoint=dataArray[i][it]}}}}point.update(newPoint)}catch(err){xRTML.ErrorHandler().tagError(err)}}}};xRTML.Tags.Chart.prototype.runJQueryEffects=function(position){this.jQueryEffectManagerInstance.stopAllEffectsAndClearQueue();if((typeof position!="undefined")&&this.jQueryEffectsConfig){for(effectId in this.jQueryEffectsConfig){this.jQueryEffectManagerInstance.addEffectToQueue({element:this.jQueryEffectsConfig[effectId][position],effectId:effectId})}}this.jQueryEffectManagerInstance.runAllEffects()};xRTML.Tags.Poll=xRTML.Tag.makeSubclass();xRTML.registerTag("Poll");xRTML.Tags.Poll.prototype.init=function(tagObject){var self=this;xRTML.Tag.prototype.init.call(this,tagObject);xRTML.Common.Validator.validateRequired(tagObject.channelid,true," channelid is necessary for a poll tag.");this.getDataUrl=tagObject.getdataurl;this.voteUrl=tagObject.voteurl;if(this.target&&this.target.length>0){this.targetElement=this.target[0]}xRTML.Common.Validator.validateRequired(this.targetElement,true,"The attribute target on a poll tag contains an invalid selector.");this.useChartTag=tagObject.usecharttag?xRTML.Common.Converter.toBoolean(tagObject.usecharttag):false;this.chartTagId=tagObject.charttagid?tagObject.charttagid:null;this.valuesTarget=null;this.buttonsTarget=this.useChartTag?".xRTMLVotingButton":null;this.percentagesTarget=null;this.scaleTarget=null;var userId=tagObject.userId;this.scaleTarget=null;if(!this.useChartTag){if(tagObject.elements){for(var i=0,len=tagObject.elements.length;i<len;i++){var el=tagObject.elements[i];self[el.key+"Target"]=el.target}}else{xRTML.ErrorHandler().tagError(new Error("When the chart tag is not being used to support the poll the target elements should be configured."))}}this.votesAllowed=tagObject.votesallowed?xRTML.Common.Converter.toNumber(tagObject.votesallowed):1;this.saveVoteFunction=tagObject.savevotefunction?(typeof tagObject.savevotefunction=="function"?tagObject.savevotefunction:new Function("index, tag, userId","return "+tagObject.savevotefunction+"(index, tag, userId);")):null;this.getDataFunction=tagObject.getdatafunction?(typeof tagObject.getdatafunction=="function"?tagObject.getdatafunction:new Function("tag","return "+tagObject.getdatafunction+"(tag);")):null;this.buttons=tagObject.buttons;this.pollData={values:[]};this.onVote=function(index){var e={target:self,index:index,userId:userId};tagObject.onvote?new Function("e","return "+tagObject.onvote+"(e);")(e):null;self.dispatchEvent("onVote",e)};this.onData=function(data){var e={target:self,data:data};tagObject.ondata?new Function("e","return "+tagObject.ondata+"(e);")(e):null;self.dispatchEvent("onData",e)};this.onVotesLimitReached=function(){var e={target:self};tagObject.onvoteslimitreached?new Function("e","return "+tagObject.onvoteslimitreached+"(e);")(e):null;self.dispatchEvent("onVotesLimitReached",e)};var configureJQueryEffects=function(){if(tagObject.jqueryeffects&&tagObject.jqueryeffects.length>0){self.jQueryEffectManagerInstance=xRTML.JQueryEffectManager.getInstance(self);self.jQueryEffectManagerInstance.init(tagObject.jqueryeffects);self.jQueryEffectsConfig={};for(var i=0;i<tagObject.jqueryeffects.length;i++){var effect=tagObject.jqueryeffects[i];var effectId=effect.id;var targetSelector;if(effect.target){targetSelector=effect.target}else{targetSelector=self.valuesTarget}if(self.target[0]){var targetElements=Sizzle(targetSelector,self.target[0])}if(!self.jQueryEffectsConfig[effectId]){self.jQueryEffectsConfig[effectId]=[]}for(var it=0;it<targetElements.length;it++){self.jQueryEffectsConfig[effectId].push(targetElements[it])}}}};if(self.useChartTag){xRTML.addEventListener("ready",function(){var chartTag=xRTML.getTag(self.chartTagId);chartTag.addEventListener("activated",function(){self.activate(true)});chartTag.activate(true)})}this.addEventListener("active",function(data){if(data.active){if(!self.useChartTag){self.activatePoll();configureJQueryEffects()}else{if(self.useChartTag&&xRTML.ready){self.activatePoll()}}}});function updateDataPrivate(data){var parsedResult=(typeof data=="string")?JSON.parse(data):data;var votingItems=parsedResult.votingItems;for(var i=0;i<votingItems.length;i++){var votingItem=votingItems[i];self.pollData.values[i]=votingItem.numberOfVotes}if(self.useChartTag){var dataArray=[];for(var i=0,len=self.pollData.values.length;i<len;i++){dataArray[i]=[self.pollData.values[i]]}xRTML.getTag(self.chartTagId).updateSeriesData({data:{v:dataArray}})}else{updateChart()}self.onData(data)}this.updateData=function(data){updateDataPrivate(data)};this.activatePoll=function(){var votingHandler=function(evt){if(evt.preventDefault){evt.preventDefault()}var targetElement;if(typeof evt.target!="undefined"){targetElement=evt.target}else{targetElement=evt.srcElement}vote({data:{i:targetElement.getAttribute("votingIndex")}})};var updatePollData=function(){if(self.getDataFunction){self.getDataFunction(self)}else{var xhr=new xRTML.Common.xhr("get",self.getDataUrl,function(result){if(this.readyState==4){if(this.status==200){self.updateData(result.xhr.responseText)}else{xRTML.ErrorHandler().tagError(new Error(this.responseText))}}});xhr.send(null)}};if(self.useChartTag){var chartSeries=xRTML.getTag(self.chartTagId).getChart().series;var existingContainer=Sizzle("#xRTMLVotingButtonsContainer",self.target[0])[0];if(existingContainer){self.target[0].removeChild(existingContainer)}var votingButtonsContainer=document.createElement("div");votingButtonsContainer.setAttribute("id","xRTMLVotingButtonsContainer");var itemsContainer=self.target[0];itemsContainer.appendChild(votingButtonsContainer);var votingButtonListElement=document.createElement("ul");votingButtonsContainer.appendChild(votingButtonListElement);var appendButton=function(text,position){var votingButtonElement=document.createElement("li");votingButtonListElement.appendChild(votingButtonElement);votingButtonElement.setAttribute("class","xRTMLVotingButton");var votingButtonSpan=document.createElement("span");votingButtonElement.appendChild(votingButtonSpan);var votingButtonAnchor=document.createElement("a");votingButtonSpan.appendChild(votingButtonAnchor);votingButtonAnchor.setAttribute("href","javascript:;");votingButtonAnchor.innerHTML=text;votingButtonAnchor.setAttribute("votingIndex",position);Events.Manager.addEventListener(votingButtonAnchor,"click",votingHandler)};if(self.buttons&&self.buttons.length>0){for(var it=0;it<self.buttons.length;it++){var buttonConfig=self.buttons[it];var position;if(buttonConfig.position){position=xRTML.Common.Converter.toNumber(buttonConfig.position)-1}else{if(buttonConfig.item){for(var itr=0;itr<chartSeries.length;itr++){var itemName=chartSeries[itr].name;if(itemName==buttonConfig.item){position=itr;break}}}else{position=it}}appendButton(buttonConfig.text,position)}}else{for(var it=0;it<chartSeries.length;it++){appendButton("vote",it)}}updatePollData()}else{var votingButtons=Sizzle(self.buttonsTarget,self.target[0]);for(var i=0,len=votingButtons.length;i<len;i++){var votingButton=votingButtons[i];votingButton.setAttribute("votingIndex",i);Events.Manager.addEventListener(votingButton,"click",votingHandler)}updatePollData()}if(typeof getNumberOfVotes()=="undefined"){saveNumberOfVotes(0)}checkVote()};function checkVote(){var numberOfVotes=getNumberOfVotes();if(typeof numberOfVotes=="undefined"||(numberOfVotes>=self.votesAllowed)){xRTML.Console.warn("User as already voted "+self.votesAllowed+" times.");self.onVotesLimitReached();return false}else{return true}}function getNumberOfVotes(){var numberOfVotes;if(localStorage){numberOfVotes=localStorage.getItem("d734h89n_"+(self.id||self.internalId))}else{numberOfVotes=xRTML.Common.Cookie.getCookie("d734h89n_"+(self.id||self.internalId))}if(typeof numberOfVotes!="undefined"){numberOfVotes=xRTML.Common.Converter.toNumber(numberOfVotes)}return numberOfVotes}function incrementNumberOfVotes(){saveNumberOfVotes(getNumberOfVotes()+1)}function saveNumberOfVotes(numberOfVotes){if(localStorage){localStorage.setItem("d734h89n_"+(self.id||self.internalId),numberOfVotes)}var expiry=new Date();expiry.setFullYear((expiry.getFullYear()+10));xRTML.Common.Cookie.setCookie("d734h89n_"+(self.id||self.internalId),numberOfVotes)}this.registerVote=function(index){if(checkVote()&&self.active){self.displayVote({data:{i:index}});for(var i=0,len=self.triggers.length;i<len;i++){var message=xRTML.createMessage(self.triggers[i].name,"displayVote",{i:index},self.internalId);xRTML.sendMessage(self.channelId,message)}incrementNumberOfVotes();checkVote();self.onVote(index)}else{xRTML.Console.warn("Poll tag not active or an error has ocurred.")}};function vote(message){var index=xRTML.Common.Converter.toNumber(message.data.i,true," Tag poll requires index to be a number.");xRTML.Console.debug("Voting on item: "+index);if(checkVote()&&self.active){if(self.saveVoteFunction){self.saveVoteFunction(index,self,userId)}else{var fingerPrint={navigator:navigator,scripting:custom.scripting,property:custom.property};var xhr=new xRTML.Common.xhr("post",self.voteUrl+(self.voteUrl.indexOf("?")!=-1?"&":"?")+"index="+(index)+"&userId="+userId+"&fingerPrint="+fingerPrint,function(result){if(this.readyState==4&&this.status==200){if(result.xhr.responseText=="OK"||result.xhr.responseText.result=="OK"){registerVote(index)}else{xRTML.ErrorHandler().tagError(new Error("There was an error while calling voteurl."))}}});xhr.send(null)}}else{xRTML.Console.warn("Poll tag not active or an error has ocurred.")}}this.displayVote=function(message){var index=message.data.i;self.votedItemPosition=xRTML.Common.Converter.toNumber(index);if(self.useChartTag){self.pollData.values[index]++;xRTML.getTag(self.chartTagId).updateDataItemValue({data:{i:index,d:0,v:self.pollData.values[index]}})}else{self.pollData.values[index]++;updateChart()}};function updateChart(){var dataTotalValue=0;var highestDataValue=0;var decimalPlaces=1;var dataValueElements=Sizzle(self.valuesTarget,self.target[0]);var dataItemPercentageElements=Sizzle(self.percentagesTarget,self.target[0]);var scaleListItems=Sizzle(self.scaleTarget,self.target[0]);for(var i=0,len=self.pollData.values.length;i<len;i++){var value=self.pollData.values[i];dataTotalValue+=value;if(highestDataValue<value){highestDataValue=value}}var highestDataValueNearestTenth=Math.ceil(highestDataValue/10)*10;for(var i=0,len=self.pollData.values.length;i<len;i++){var value=self.pollData.values[i];if(value&&dataTotalValue){var realPercentage=Math.round(((value/dataTotalValue)*100)*Math.pow(10,decimalPlaces))/Math.pow(10,decimalPlaces)}if(value&&highestDataValueNearestTenth){var percentageForBarHeight=Math.round((value/highestDataValueNearestTenth)*100)}if(self.valuesTarget){xRTML.Common.DOM.setText(dataValueElements[i],value)}if(!realPercentage){realPercentage=0}if(self.percentagesTarget){xRTML.Common.DOM.setText(dataItemPercentageElements[i],realPercentage+" %")}var increaseBy=100*(percentageForBarHeight/100);if(increaseBy){if(self.valuesTarget){dataValueElements[i].style.paddingTop=increaseBy+"px"}if(self.percentagesTarget){dataItemPercentageElements[i].style.paddingTop=increaseBy+"px"}}}if(typeof self.votedItemPosition!="undefined"){runJQueryEffects(self.votedItemPosition)}if(self.scaleTarget&&highestDataValueNearestTenth>=10){var firstScaleNumber=highestDataValueNearestTenth/(scaleListItems.length-1);for(var i=0;i<scaleListItems.length;i++){var scaleListItem=scaleListItems[i];var scaleNumber=firstScaleNumber*((scaleListItems.length-1)-i);xRTML.Common.DOM.setText(scaleListItem,Math.round(scaleNumber))}}}function runJQueryEffects(position){if(self.jQueryEffectsConfig){self.jQueryEffectManagerInstance.stopAllEffectsAndClearQueue();if((typeof position!="undefined")&&self.jQueryEffectsConfig){for(var effectId in self.jQueryEffectsConfig){self.jQueryEffectManagerInstance.addEffectToQueue({element:self.jQueryEffectsConfig[effectId][position],effectId:effectId})}}self.jQueryEffectManagerInstance.runAllEffects()}}if(self.active){self.activate(true)}};xRTML.Tags.Calendar=xRTML.Tag.makeSubclass();xRTML.registerTag("Calendar");xRTML.Tags.Calendar.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);var self=this;xRTML.Common.Validator.validateRequired(tagObject.channelid,true,"A channelid attribute is required for calendar tag.");this.receiveownmessages=true;this.target=Sizzle(tagObject.target)[0]?Sizzle(tagObject.target)[0]:document.body;this.langsCallback=tagObject.langscallback?eval(tagObject.langscallback+"()"):null;this.lang=tagObject.lang?this.getLangs()[tagObject.lang]:this.getLangs()["en"];this.tagSlots=tagObject.slots;this.userId=(tagObject.userid)?tagObject.userid:eval(tagObject.useridcallback+"()");this.adminId="";this.dayOnly=tagObject.dayonly=="true"?true:false;this.handlerUrl=tagObject.handlerurl;this.firstWeekDay=(tagObject.firstweekday&&tagObject.firstweekday=="sun")?0:1;this.startDate=tagObject.startdate?(tagObject.startdate=="today"?new Date(new Date().getFullYear(),new Date().getMonth(),new Date().getDate()):new Date(tagObject.startdate.split("-")[0],tagObject.startdate.split("-")[1]-1,tagObject.startdate.split("-")[2])):null;this.endDate=tagObject.enddate?new Date(tagObject.enddate.split("-")[0],tagObject.enddate.split("-")[1]-1,tagObject.enddate.split("-")[2]):null;this.showDate=tagObject.showdate?new Date(tagObject.showdate.split("-")[0],tagObject.showdate.split("-")[1]-1,15):new Date();this.appointments={};this.bookClickHandler=function(e){var element=(e.srcElement)?e.srcElement:e.originalTarget;element.className=element.className+" "+this.waitingClass;if(this.dayOnly){self.bookSlot.call(self,self.userId,self.selectedYear,self.selectedMonth,element.getAttribute("data-day"))}else{self.bookSlot.call(self,self.userId,self.selectedYear,self.selectedMonth,self.selectedDay,element.getAttribute("data-slot"))}};this.cancelClickHandler=function(e){var element=(e.srcElement)?e.srcElement:e.originalTarget;element.className=element.className+" "+this.waitingClass;if(this.dayOnly){self.cancelSlot.call(self,self.userId,self.selectedYear,self.selectedMonth,element.getAttribute("data-day"))}else{self.cancelSlot.call(self,self.userId,self.selectedYear,self.selectedMonth,self.selectedDay,element.getAttribute("data-slot"))}};this.navMonthClickHandler=function(e){var element=(e.srcElement)?e.srcElement:e.currentTarget;var monthAdd=element.getAttribute("title")==self.lang.navButtons.next?1:-1;self.navigateMonth.call(self,monthAdd)};this.dateClickHandler=function(e){var element=(e.srcElement)?e.srcElement:e.currentTarget;self.selectedDay=element.getAttribute("data-day");if(self.dayOnly){if(self.appointments[self.selectedYear]&&self.appointments[self.selectedYear][self.selectedMonth]&&self.appointments[self.selectedYear][self.selectedMonth][self.selectedDay]){if(self.appointments[self.selectedYear][self.selectedMonth][self.selectedDay]==self.userId||self.userId==self.adminId){self.cancelSlot.call(self,self.userId,self.selectedYear,self.selectedMonth,self.selectedDay)}}else{self.bookSlot.call(self,self.userId,self.selectedYear,self.selectedMonth,self.selectedDay)}}else{self.showDailyPanel.call(self,self.selectedYear,self.selectedMonth,element.getAttribute("data-day"))}};this.selectedMonth=this.showDate.getMonth();this.selectedYear=this.showDate.getFullYear();this.selectedDay=0;this.drawCalendar(this.showDate);this.fetchAppointments()};xRTML.Tags.Calendar.prototype.navigateMonth=function(monthsToAdd){var newMonth=this.selectedMonth+monthsToAdd;var newDate=new Date(this.selectedYear,newMonth,15);this.selectedMonth=newDate.getMonth();this.selectedYear=newDate.getFullYear();this.drawCalendar(newDate);var monthAppointments=this.getAppointments(newDate.getFullYear(),newDate.getMonth());if(this.propCount(monthAppointments)==0){this.fetchAppointments()}};xRTML.Tags.Calendar.prototype.getAppointments=function(year,month,day){var appointments=this.appointments;if(year){if(appointments[year]){appointments=appointments[year];if(typeof month!="undefined"){if(appointments[month]){appointments=appointments[month];if(day){if(appointments[day]){appointments=appointments[day]}else{appointments={}}}}else{appointments={}}}else{appointments={}}}else{appointments={}}}return appointments};xRTML.Tags.Calendar.prototype.fetchAppointments=function(){var self=this;var xhrData={action:"get",userid:this.userId,year:this.selectedYear,month:this.selectedMonth,dayonly:this.dayOnly};if(this.id){xhrData.calendarid=this.id}var xhr=new xRTML.Common.xhr("post",this.handlerUrl,function(ret){if(this.readyState==4&&this.status==200){var response=JSON.parse(ret.xhr.responseText);if(response.adminid){self.adminId=response.adminid}var slots=response.slots;var cont=0;for(var cont=0;cont<slots.length;cont++){if(!self.appointments[slots[cont].year]){self.appointments[slots[cont].year]={}}}for(var cont=0;cont<slots.length;cont++){if(!self.appointments[slots[cont].year][slots[cont].month]){self.appointments[slots[cont].year][slots[cont].month]={}}}for(var cont=0;cont<slots.length;cont++){if(!self.appointments[slots[cont].year][slots[cont].month][slots[cont].day]){self.appointments[slots[cont].year][slots[cont].month][slots[cont].day]=self.dayOnly?slots[cont].userid:{}}}if(!self.dayOnly){for(var cont=0;cont<slots.length;cont++){if(!self.appointments[slots[cont].year][slots[cont].month][slots[cont].day][slots[cont].slot]){self.appointments[slots[cont].year][slots[cont].month][slots[cont].day][slots[cont].slot]=slots[cont].userid}}}if(self.onDataLoad){self.onDataLoad(data)}self.markMonthAppointments(self.selectedYear,self.selectedMonth)}});xhr.send(JSON.stringify(xhrData))};xRTML.Tags.Calendar.prototype.drawCalendar=function(date){var self=this;var firstOfMonth=new Date(date);firstOfMonth.setDate(1);var daysInMonth=date.daysInMonth(date.getMonth(),date.getFullYear());this.calendarDiv=document.createElement("div");this.calendarDiv.setAttribute("class","calendarDiv");var headerDiv=document.createElement("div");var tbCal=document.createElement("table");tbCal.className="xrtmlCal_calendar";tbCal.setAttribute("width","100%");tbCal.setAttribute("cellspacing","0");tbCal.setAttribute("cellpadding","0");var thead=document.createElement("thead");var prevLink=document.createElement("a");Events.Manager.addEventListener(prevLink,"click",this.navMonthClickHandler);prevLink.href="javascript:void(0)";prevLink.setAttribute("title",this.lang.navButtons.prev);prevLink.innerHTML=this.lang.navButtons.prev;var nextLink=document.createElement("a");Events.Manager.addEventListener(nextLink,"click",this.navMonthClickHandler);nextLink.href="javascript:void(0)";nextLink.setAttribute("title",this.lang.navButtons.next);nextLink.innerHTML=this.lang.navButtons.next;var trTitle=document.createElement("tr");trTitle.className="xrtmlCal_titleRow";var tdPrev=document.createElement("td");tdPrev.className="xrtmlCal_previousMonth";tdPrev.setAttribute("colspan","1");tdPrev.appendChild(prevLink);var tdTitle=document.createElement("td");tdTitle.className="xrtmlCal_titleDate";tdTitle.setAttribute("colspan","5");tdTitle.innerHTML=this.lang.fullMonth[date.getMonth()]+" "+date.getFullYear();var tdNext=document.createElement("td");tdNext.className="xrtmlCal_nextMonth";tdNext.setAttribute("colspan","1");tdNext.appendChild(nextLink);trTitle.appendChild(tdPrev);trTitle.appendChild(tdTitle);trTitle.appendChild(tdNext);var headTr=document.createElement("tr");headTr.className="xrtmlCal_weekDays";for(var cont=this.firstWeekDay;cont<this.getLangs()["en"].shortDoW.length+this.firstWeekDay;cont++){var index=cont==this.getLangs()["en"].shortDoW.length?0:cont;var th=document.createElement("th");th.className="xrtmlCal_weekDays_"+this.getLangs()["en"].shortDoW[index];var sp=document.createElement("span");sp.setAttribute("title",this.lang.fullDoW[index]);sp.innerHTML=this.lang.shortDoW[index];th.appendChild(sp);headTr.appendChild(th)}thead.appendChild(trTitle);thead.appendChild(headTr);tbCal.appendChild(thead);var tBody=document.createElement("tbody");var trWeek=document.createElement("tr");if(this.firstWeekDay==0){var firstOfMonthDayOfWeek=firstOfMonth.getDay()}else{var firstOfMonthDayOfWeek=firstOfMonth.getDay()-1;if(firstOfMonthDayOfWeek<0){firstOfMonthDayOfWeek+=7}}var rounds=0;var today=new Date();for(var cont=1,tds=1;;cont++,tds++){var td=document.createElement("td");var dateLink=document.createElement("a");dateLink.href="javascript:void(0)";dateLink.setAttribute("data-day",cont);dateLink.innerHTML=cont;if(tds<=firstOfMonthDayOfWeek||cont>daysInMonth){if(!this.hasClass(td,"xrtmlCal_emptyDate")){td.className+="xrtmlCal_emptyDate "}td.innerHTML="&nbsp;";cont--}else{if(cont==today.getDate()&&this.selectedMonth==today.getMonth()&&this.selectedYear==today.getFullYear()){if(!this.hasClass(td,"xrtmlCal_today")){td.className+="xrtmlCal_today "}}else{if(!this.hasClass(td,"xrtmlCal_default")){td.className+="xrtmlCal_default "}}td.appendChild(dateLink)}trWeek.appendChild(td);if(tds%7==0){tBody.appendChild(trWeek);trWeek=document.createElement("tr");var rowNumber=tds/7;var rowClass=(rowNumber%2==0)?"even":"odd";trWeek.className="xrtmlCal_dateRow_"+rowClass;if(cont>=daysInMonth){while(tds<=36){var tr=document.createElement("tr");for(var cont=0;cont<7;cont++){var td=document.createElement("td");if(!this.hasClass(td,"xrtmlCal_emptyDate")){td.className+="xrtmlCal_emptyDate "}td.innerHTML="&nbsp;";tr.appendChild(td);tds++}tBody.appendChild(tr)}break}}}tbCal.appendChild(tBody);var calendar=this.calendarDiv.getElementsByClassName("xrtmlCal_calendar");if(calendar[0]){this.calendarDiv.replaceChild(tbCal,calendar[0])}else{this.calendarDiv.appendChild(tbCal)}var maisdiv=this.target.getElementsByClassName("calendarDiv");if(maisdiv[0]){this.target.replaceChild(this.calendarDiv,maisdiv[0])}else{this.target.appendChild(this.calendarDiv)}this.markMonthAppointments(this.selectedYear,this.selectedMonth)};xRTML.Tags.Calendar.prototype.bookSlot=function(userid,year,month,day,slot){var self=this;var data={action:"save",userid:userid,dayonly:this.dayOnly,year:year,month:month,day:day};if(this.id){data.calendarid=this.id}if(!this.dayOnly&&slot){data.slot=slot}var action="book";var xhr=new xRTML.Common.xhr("post",this.handlerUrl,function(ret){if(this.readyState==4&&this.status==200){var response=JSON.parse(ret.xhr.responseText);if(response.result=="saved"){var dataString=JSON.stringify(data);for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,action,dataString,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}}else{if(self.onBookingTaken){self.onBookingTaken({slot:element.getAttribute("data-slot")})}}}});xhr.send(JSON.stringify(data))};xRTML.Tags.Calendar.prototype.cancelSlot=function(userid,year,month,day,slot){var self=this;var data={action:"cancel",userid:userid,dayonly:this.dayOnly,year:year,month:month,day:day};if(this.id){data.calendarid=this.id}if(!this.dayOnly&&slot){data.slot=slot}var action="cancel";var xhr=new xRTML.Common.xhr("post",this.handlerUrl,function(ret){if(this.readyState==4&&this.status==200){var response=JSON.parse(ret.xhr.responseText);if(response.result=="canceled"){var dataString=JSON.stringify(data);for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,action,dataString,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}}}});xhr.send(JSON.stringify(data))};xRTML.Tags.Calendar.prototype.registerAppointmemt=function(slot){if(slot.year!=this.selectedYear||slot.month!=this.selectedMonth){return false}if(!this.appointments[slot.year]){this.appointments[slot.year]={}}if(!this.appointments[slot.year][slot.month]){this.appointments[slot.year][slot.month]={}}if(!this.appointments[slot.year][slot.month][slot.day]){this.appointments[slot.year][slot.month][slot.day]=this.dayOnly?slot.userid:{}}this.appointments[slot.year][slot.month][slot.day][slot.slot]=slot.userid};xRTML.Tags.Calendar.prototype.markBookedSlot=function(slot){this.registerAppointmemt(slot);var link,td,tr;var dayLink=Sizzle(".xrtmlCal_calendar td a[data-day="+slot.day+"]",this.target);if(dayLink[0]&&this.selectedYear==slot.year&&this.selectedMonth==slot.month){var doW=new Date(this.selectedYear,this.selectedMonth,slot.day).getDay();var dayAppointments=this.getAppointments(this.selectedYear,this.selectedMonth,slot.day);dayLink[0].parentNode.className=(this.propCount(dayAppointments)==this.propCount(this.getTimeSlots(this.selectedYear,this.selectedMonth)[slot.day]))||this.dayOnly?"xrtmlCal_fullDay":"xrtmlCal_partialDay";if(slot.userid==this.userId&&this.dayOnly){if(!this.hasClass(dayLink[0].parentNode,"xrtmlCal_own")){dayLink[0].parentNode.className+=" xrtmlCal_own"}}if(this.dayOnly){Events.Manager.addEventListener(dayLink[0],"click",this.dateClickHandler)}}var dayPanelElem=Sizzle(".xrtmlCal_dailyPanel a",this.target);if(dayPanelElem.length>0&&this.selectedYear==slot.year&&this.selectedMonth==slot.month&&this.selectedDay==slot.day){for(var cont=0;cont<dayPanelElem.length;cont++){if(dayPanelElem[cont].getAttribute("data-slot")==slot.slot){link=dayPanelElem[cont];td=link.parentNode;tr=td.parentNode;break}}Events.Manager.removeEventListener(link,"click",this.bookClickHandler);tr.className="xrtmlCal_schedule_slotInfo_booked";link.innerHTML=this.userId==this.adminId?slot.userid:this.lang.actions.booked;link.setAttribute("title",this.lang.actions.booked);if(this.userId==slot.userid||this.adminId==this.userId){if(this.userId==slot.userid){tr.className=tr.className+" xrtmlCal_own";link.innerHTML=this.lang.actions.cancel}link.setAttribute("title",this.lang.actions.cancel);Events.Manager.addEventListener(link,"click",this.cancelClickHandler)}}};xRTML.Tags.Calendar.prototype.book=function(message){this.markBookedSlot(message.data);if(this.onBookingSuccess){this.onBookingSuccess({slot:message.data.slot,user:message.data.userid==this.userId})}};xRTML.Tags.Calendar.prototype.cancel=function(message){var link,td,tr;var slot=message.data;if(this.dayOnly){delete this.appointments[slot.year][slot.month][slot.day]}else{delete this.appointments[slot.year][slot.month][slot.day][slot.slot]}var dayPanelElem=Sizzle(".xrtmlCal_dailyPanel a",this.target);if(dayPanelElem[0]&&this.selectedYear==slot.year&&this.selectedMonth==slot.month&&this.selectedDay==slot.day){for(var elem=0;elem<dayPanelElem.length;elem++){if(dayPanelElem[elem].getAttribute("data-slot")==slot.slot){link=dayPanelElem[elem];td=link.parentNode;tr=td.parentNode;break}}tr.className="xrtmlCal_schedule_slotInfo_free";link.innerHTML=this.lang.actions.book;link.setAttribute("title",this.lang.actions.book);Events.Manager.addEventListener(link,"click",this.bookClickHandler)}var dayLink=Sizzle(".xrtmlCal_calendar td a[data-day="+slot.day+"]",this.target);if(dayLink[0]&&this.selectedYear==slot.year&&this.selectedMonth==slot.month){var dayAppointments=this.getAppointments(this.selectedYear,this.selectedMonth,slot.day);var today=new Date();dayLink[0].parentNode.className=this.propCount(dayAppointments)==0||this.dayOnly?"xrtmlCal_default":"xrtmlCal_partialDay";if(slot.day==today.getDate()&&this.selectedMonth==today.getMonth()&&this.selectedYear==today.getFullYear()){if(!this.hasClass(dayLink[0],"xrtmlCal_today")){dayLink[0].className+=" xrtmlCal_today"}}}};xRTML.Tags.Calendar.prototype.showDailyPanel=function(year,month,day){var self=this;var dayTimeSlots=this.getTimeSlots(this.selectedYear,this.selectedMonth)[this.selectedDay];var doW=new Date(this.selectedYear,this.selectedMonth,this.selectedDay).getDay();var divPanel=document.createElement("div");divPanel.className="xrtmlCal_dailyPanel";var h3=document.createElement("h3");h3.innerHTML=this.selectedDay+", "+this.lang.fullMonth[this.selectedMonth]+", "+this.selectedYear;divPanel.appendChild(h3);var timeTable=document.createElement("table");timeTable.className="xrtmlCal_schedule";timeTable.setAttribute("width","100%");for(var slot in dayTimeSlots){var tr=document.createElement("tr");var tdTime=document.createElement("td");tdTime.className="xrtmlCal_schedule_timeslot";tdTime.innerHTML=dayTimeSlots[slot];tr.appendChild(tdTime);var tdController=document.createElement("td");tdController.className="xrtmlCal_schedule_slotInfo";var link=document.createElement("a");link.href="javascript:void(0)";link.setAttribute("data-slot",dayTimeSlots[slot]);if(this.getAppointments(this.selectedYear,this.selectedMonth,this.selectedDay).hasOwnProperty(dayTimeSlots[slot])){tr.className="xrtmlCal_schedule_slotInfo_booked";var owner=this.getAppointments(this.selectedYear,this.selectedMonth,this.selectedDay)[dayTimeSlots[slot]];if(this.userId==owner){tr.className=tr.className+" xrtmlCal_own";link.innerHTML=this.lang.actions.cancel;link.setAttribute("title",this.lang.actions.cancel);Events.Manager.addEventListener(link,"click",this.cancelClickHandler);tdController.appendChild(link)}else{if(this.userId==this.adminId){link.setAttribute("title",this.lang.actions.cancel);Events.Manager.addEventListener(link,"click",this.cancelClickHandler);link.innerHTML=owner;tdController.appendChild(link)}else{link.innerHTML=this.lang.actions.booked;tdController.appendChild(link)}}}else{link.innerHTML=this.lang.actions.book;link.setAttribute("title",this.lang.actions.book);Events.Manager.addEventListener(link,"click",this.bookClickHandler);tdController.appendChild(link);tr.className="xrtmlCal_schedule_slotInfo_free"}tr.appendChild(tdController);timeTable.appendChild(tr)}divPanel.appendChild(timeTable);divBack=document.createElement("div");divBack.className="xrtmlCal_dailyPanel_backLink";backLink=document.createElement("a");backLink.innerHTML=this.lang.actions.backToCalendar;backLink.href="javascript:void(0)";Events.Manager.addEventListener(backLink,"click",function(){self.target.removeChild(divPanel);self.drawCalendar(new Date(self.selectedYear,self.selectedMonth,15))});divBack.appendChild(backLink);divPanel.appendChild(divBack);this.target.replaceChild(divPanel,this.calendarDiv)};xRTML.Tags.Calendar.prototype.getLangs=function(){var langs={en:{navButtons:{prev:"<<",next:">>"},shortMonth:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],fullMonth:["January","February","March","April","May","June","July","August","September","October","November","December"],shortDoW:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],fullDoW:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],actions:{book:"Book",cancel:"Cancel",booked:"Booked",backToCalendar:"<< back to Calendar"}}};if(this.langsCallback){for(lang in this.langsCallback){langs[lang]=this.langsCallback[lang]}}return langs};xRTML.Tags.Calendar.prototype.markMonthAppointments=function(year,month){var monthTimeSlots=this.getTimeSlots(this.selectedYear,this.selectedMonth);var trs=Sizzle(".xrtmlCal_calendar tbody tr",this.target);for(var i=0;i<trs.length;i++){var tds=trs[i].childNodes;for(var j=0;j<tds.length;j++){var link=tds[j].getElementsByTagName("a");if(link.length>0){var day=link[0].getAttribute("data-day");var thisDay=new Date(year,month,day);if((this.startDate!=null&&thisDay<this.startDate)||(this.endDate!=null&&thisDay>this.endDate)||(!monthTimeSlots[day]||(!this.dayOnly&&this.isArray(monthTimeSlots[day])&&monthTimeSlots[day].length==0))){if(!this.hasClass(link[0].parentNode,"xrtmlCal_disabled")){link[0].parentNode.className+="xrtmlCal_disabled "}}else{Events.Manager.addEventListener(link[0],"click",this.dateClickHandler)}}}}var monthAppointments=this.getAppointments(this.selectedYear,this.selectedMonth);var today=new Date();for(var day in monthAppointments){var doW=new Date(this.selectedYear,this.selectedMonth,day).getDay();var dayLink=Sizzle("a[data-day="+day+"]",this.target)[0];var dayAppointments=this.getAppointments(this.selectedYear,this.selectedMonth,day);if(this.dayOnly){if(dayAppointments&&dayAppointments.length>0){if(!this.hasClass(dayLink.parentNode,"xrtmlCal_fullDay")){dayLink.parentNode.className+="xrtmlCal_fullDay"}}else{if(!this.hasClass(dayLink.parentNode,"xrtmlCal_default")){dayLink.parentNode.className+="xrtmlCal_default"}}}else{if(this.propCount(dayAppointments)==this.propCount(monthTimeSlots[day])){if(!this.hasClass(dayLink.parentNode,"xrtmlCal_fullDay")){dayLink.parentNode.className+="xrtmlCal_fullDay"}}else{if(this.propCount(dayAppointments)==0){if(!this.hasClass(dayLink.parentNode,"xrtmlCal_default")){dayLink.parentNode.className+="xrtmlCal_default"}}else{if(!this.hasClass(dayLink.parentNode,"xrtmlCal_partialDay")){dayLink.parentNode.className+="xrtmlCal_partialDay"}}}}if(monthAppointments[day]==this.userId&&this.dayOnly){if(!this.hasClass(dayLink.parentNode,"xrtmlCal_own")){dayLink.parentNode.className+="xrtmlCal_own"}}if(this.propCount(dayAppointments)==0&&day==today.getDate()&&this.selectedMonth==today.getMonth()&&this.selectedYear==today.getFullYear()){if(!this.hasClass(dayLink.parentNode,"xrtmlCal_today")){dayLink.parentNode.className+="xrtmlCal_today"}}}};xRTML.Tags.Calendar.prototype.getTimeSlots=function(year,month){var cont=0;var monthTimeSlots={};var daysInMonth=new Date(year,month,15).daysInMonth();for(var day=1;day<=daysInMonth;day++){if(this.dayOnly){monthTimeSlots[day]=true}else{monthTimeSlots[day]=[]}}for(var item in this.tagSlots){var slots=[];if(this.tagSlots[item].value){slots=this.tagSlots[item].value.split("|")}if(this.tagSlots[item].enabled){var enabled=this.tagSlots[item].enabled=="false"?false:true}if(!this.tagSlots[item].year&&!this.tagSlots[item].month&&!this.tagSlots[item].day&&!this.tagSlots[item].weekday){for(var day=1;day<=daysInMonth;day++){if(!this.dayOnly){monthTimeSlots[day]=slots}}}if(!this.tagSlots[item].year&&!this.tagSlots[item].month&&!this.tagSlots[item].day&&this.tagSlots[item].weekday){var weekday=this.getLangs()["en"].shortDoW.indexOf(this.tagSlots[item].weekday);for(var day=1;day<=daysInMonth;day++){var dateWeekDay=new Date(this.selectedYear,this.selectedMonth,day).getDay();if(dateWeekDay==weekday){if(this.dayOnly){monthTimeSlots[day]=enabled}else{monthTimeSlots[day]=slots}}}}if(this.tagSlots[item].year){if(this.tagSlots[item].month){if(this.tagSlots[item].day){if(this.selectedYear==this.tagSlots[item].year&&this.selectedMonth==this.tagSlots[item].month-1){if(this.dayOnly){monthTimeSlots[this.tagSlots[item].day]=enabled}else{monthTimeSlots[this.tagSlots[item].day]=slots}}}else{if(this.tagSlots[item].weekday){if(this.selectedYear==this.tagSlots[item].year&&this.selectedMonth==this.tagSlots[item].month-1){var slotWeekday=this.getLangs()["en"].shortDoW.indexOf(this.tagSlots[item].weekday);for(var day=1;day<=daysInMonth;day++){var dateWeekDay=new Date(this.selectedYear,this.selectedMonth,day).getDay();if(slotWeekday==dateWeekDay){if(this.dayOnly){monthTimeSlots[day]=enabled}else{monthTimeSlots[day]=slots}}}}}else{if(this.selectedYear==this.tagSlots[item].year&&this.selectedMonth==this.tagSlots[item].month-1){for(var day=1;day<=daysInMonth;day++){if(this.dayOnly){monthTimeSlots[day]=enabled}else{monthTimeSlots[day]=slots}}}}}}else{if(this.tagSlots[item].day){if(this.selectedYear==this.tagSlots[item].year){if(this.dayOnly){monthTimeSlots[day]=enabled}else{monthTimeSlots[day]=slots}}}else{if(this.tagSlots[item].weekday){if(this.selectedYear==this.tagSlots[item].year){var slotWeekday=this.getLangs()["en"].shortDoW.indexOf(this.tagSlots[item].weekday);for(var day=1;day<=daysInMonth;day++){var dateWeekDay=new Date(this.selectedYear,this.selectedMonth,day).getDay();if(slotWeekday==dateWeekDay){if(this.dayOnly){monthTimeSlots[day]=enabled}else{monthTimeSlots[day]=slots}}}}}else{if(this.selectedYear==this.tagSlots[item].year){for(var day=1;day<=daysInMonth;day++){if(this.dayOnly){monthTimeSlots[day]=enabled}else{monthTimeSlots[day]=slots}}}}}}}else{if(this.tagSlots[item].month){if(this.tagSlots[item].day){if(this.selectedMonth==this.tagSlots[item].month-1){if(this.dayOnly){monthTimeSlots[this.tagSlots[item].day]=enabled}else{monthTimeSlots[this.tagSlots[item].day]=slots}}}else{if(this.tagSlots[item].weekday){if(this.selectedMonth==this.tagSlots[item].month-1){var slotWeekday=this.getLangs()["en"].shortDoW.indexOf(this.tagSlots[item].weekday);for(var day=1;day<=daysInMonth;day++){var dateWeekDay=new Date(this.selectedYear,this.selectedMonth,day).getDay();if(slotWeekday==dateWeekDay){if(this.dayOnly){monthTimeSlots[day]=enabled}else{monthTimeSlots[day]=slots}}}}}else{if(this.selectedMonth==this.tagSlots[item].month-1){for(var day=1;day<=daysInMonth;day++){if(this.dayOnly){monthTimeSlots[day]=enabled}else{monthTimeSlots[day]=slots}}}}}}else{if(this.tagSlots[item].day){for(var day=1;day<=daysInMonth;day++){if(this.dayOnly){monthTimeSlots[day]=enabled}else{monthTimeSlots[day]=slots}}}else{if(this.tagSlots[item].weekday){var slotWeekday=this.getLangs()["en"].shortDoW.indexOf(this.tagSlots[item].weekday);for(var day=1;day<=daysInMonth;day++){var dateWeekDay=new Date(this.selectedYear,this.selectedMonth,day).getDay();if(slotWeekday==dateWeekDay){if(this.dayOnly){monthTimeSlots[day]=enabled}else{monthTimeSlots[day]=slots}}}}}}}}return monthTimeSlots};Date.prototype.daysInMonth=function(){return 32-new Date(this.getFullYear(),this.getMonth(),32).getDate()};xRTML.Tags.Calendar.prototype.propCount=function(obj){var count=0;for(k in obj){if(obj.hasOwnProperty(k)){count++}}return count};xRTML.Tags.Calendar.prototype.isArray=function(obj){if(obj.constructor.toString().indexOf("Array")==-1){return false}else{return true}};xRTML.Tags.Calendar.prototype.hasClass=function(element,cls){var r=new RegExp("\\b"+cls+"\\b");return r.test(element.className)};xRTML.Tags.Repeater=xRTML.Tag.makeSubclass();xRTML.registerTag("Repeater");xRTML.Tags.Repeater.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);if(tagObject.template){var templateTag=tagObject.template}else{xRTML.ErrorHandler().tagError(new Error("xrtml:repeater tag requires one and only one xrtml:template tag."))}this.template=templateTag.content.trim().replace("<!--","").replace("-->","").trim();this.jQueryEffectsOnNewElement=[];var effectElements=tagObject.jqueryeffects;if((typeof effectElements!="undefined")&&effectElements.length>0){for(var i=0;i<effectElements.length;i++){var effectId=effectElements[i].id;if(effectId){this.jQueryEffectsOnNewElement.push(effectId)}else{xRTML.ErrorHandler().tagError(new Error("xrtml:jqueryeffect required an id to be specified."))}}}this.jQueryEffectManagerInstance=xRTML.JQueryEffectManager.getInstance(this);if((typeof effectElements!="undefined")&&effectElements.length>0){this.jQueryEffectManagerInstance.init(effectElements)}var indexConverter=function(idx){if(typeof idx=="number"){return idx}var indexMapper={begin:0,end:-1};return !isNaN(idx)?parseInt(idx):(indexMapper.hasOwnProperty(idx)?indexMapper[idx]:-1)};this.index=indexConverter(tagObject.index);this.removeIndex=indexConverter(tagObject.removeindex);this.maxItens=parseInt(tagObject.maxitens);this.dataKeyName=tagObject.datakeyname||"id";var self=this;var getIndexByDataKey=function(elements,dataKey){var removeIndex=-1;if(!self.dataKeyName){xRTML.Console.error("DataKeyName attribute must be specified to be able to remove by DataKey.")}else{for(var i=0;i<elements.length;++i){if(elements[i].getAttribute(self.dataKeyName)==dataKey){removeIndex=i;break}}}return removeIndex};var getTemplateElement=function(data){var content=self.template;for(var key in data){var reTag=new RegExp("\\[xrtml:"+key+"\\]","gi");var text=data[key];content=xRTML.Common.Util.regexReplaceAll(content,reTag,text);var reProp=new RegExp("\\[xrtml:"+key+"\\]","gi");content=xRTML.Common.Util.regexReplaceAll(content,reProp,data[key])}var div=document.createElement("div");div.innerHTML=content;var templateElement=div.childNodes;return templateElement[0]};this.remove=function(data){var message=data.data;xRTML.Common.Array.forEach(this.target,function(innerTarget,index){var targetChildren=innerTarget.children,removeIndex=-1;if(message.dataKey){removeIndex=getIndexByDataKey(targetChildren,message.dataKey)}else{removeIndex=message.index?indexConverter(message.index):self.removeIndex;removeIndex=removeIndex==-1?targetChildren.length-1:removeIndex}if(removeIndex<0){xRTML.Console.debug("No item found to remove.");return}innerTarget.removeChild(targetChildren[removeIndex])})};this.update=function(data){var message=data.data,idx=typeof message.index=="undefined"?this.index:message.index,templateElement=getTemplateElement(message);this.jQueryEffectManagerInstance.stopAllEffectsAndClearQueue();xRTML.Common.Array.forEach(this.target,function(innerTarget,index){var targetChildren=innerTarget.children;if(idx>=targetChildren.length||idx<0){idx=targetChildren.length}innerTarget.replaceChild(templateElement,targetChildren[idx]);for(var it=0;it<self.jQueryEffectsOnNewElement.length;it++){self.jQueryEffectManagerInstance.addEffectToQueue({element:targetChildren[idx],effectId:self.jQueryEffectsOnNewElement[it]})}});this.jQueryEffectManagerInstance.runAllEffects()};this.insert=function(data){var message=data.data,idx=typeof message.index=="undefined"?this.index:message.index,templateElement=getTemplateElement(message);this.jQueryEffectManagerInstance.stopAllEffectsAndClearQueue();xRTML.Common.Array.forEach(this.target,function(innerTarget,index){var targetChildren=innerTarget.children;if(idx>=targetChildren.length||idx<0){innerTarget.appendChild(templateElement);idx=targetChildren.length-1}else{innerTarget.insertBefore(templateElement,targetChildren[idx])}for(var it=0;it<self.jQueryEffectsOnNewElement.length;it++){self.jQueryEffectManagerInstance.addEffectToQueue({element:targetChildren[idx],effectId:self.jQueryEffectsOnNewElement[it]})}if(targetChildren.length>(self.maxItens||targetChildren.length)){innerTarget.removeChild(targetChildren[self.removeIndex==-1?targetChildren.length-1:self.removeIndex])}});this.jQueryEffectManagerInstance.runAllEffects()}};xRTML.Tags.TextToSpeech=xRTML.Tag.makeSubclass();xRTML.registerTag("TextToSpeech");xRTML.Tags.TextToSpeech.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);var message=tagObject.message;xRTML.Common.Validator.validateRequired(tagObject.channelid,true,"A channelid attribute is required for Text To Speech.");this.amplitude=(tagObject.amplitude!="")?tagObject.amplitude:"100";this.wordgap=(tagObject.wordgap!="")?tagObject.wordgap:"0";this.pitch=(tagObject.pitch!="")?tagObject.pitch:"50";this.speed=(tagObject.speed!="")?tagObject.speed:"175";if(message){this.speak(message)}this.process=function(data){if(this.target){this.target[0].innerHTML=this.target[0].innerHTML+=data.data.message.toString()+"\n"}if(data.data.message&&data.data.message!=""){this.speak(data.data.message)}}};xRTML.Tags.TextToSpeech.prototype.speak=function(message){if(typeof(speak)=="function"){var els=Sizzle("#xrtmlAudio");if(els.length==0){var audio=document.createElement("audio");audio.id="xrtmlAudio";document.body.appendChild(audio)}else{audio=els[0]}var args={};args.amplitude=this.amplitude;args.wordgap=this.wordgap;args.pitch=this.pitch;args.speed=this.speed;speak(audio,message,args)}};xRTML.Tags.VideoChat=xRTML.Tag.makeSubclass();xRTML.registerTag("VideoChat");xRTML.Tags.VideoChat.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);var roles={subscriber:"SUBSCRIBER",publisher:"PUBLISHER",moderator:"MODERATOR"},elements=tagObject.elements,elementId={userCamera:"",participantCameras:"",status:"",joinChat:"",endChat:"",countHeader:"",participants:"",watchers:""};xRTML.Common.Validator.validateRequired(tagObject.id);var cameraElementId="xrtml_vc_myCamera";var streamsElementId="xrtml_vc_main";if(this.target){this.targetElements=this.target;if(this.targetElements.length>0){this.targetElement=this.targetElements[0]}xRTML.Common.Validator.validateRequired(this.targetElement,true,"The attribute target on a videoChat tag contains an invalid selector.")}else{this.targetElement=document.body}var self=this;if(!tagObject.hasOwnProperty("generatehtml")||xRTML.Common.Converter.toBoolean(tagObject.generatehtml)){(function(){var mainPlaceholder=document.createElement("div");mainPlaceholder.className="videochat";var localView=document.createElement("div");localView.id="localview";var cameraElement=document.createElement("div");cameraElement.id=cameraElementId;elementId.userCamera=cameraElement.id;localView.appendChild(cameraElement);mainPlaceholder.appendChild(localView);var streamsElement=document.createElement("div");streamsElement.id=streamsElementId;elementId.participantCameras=streamsElement.id;mainPlaceholder.appendChild(streamsElement);var rightBox=document.createElement("div");rightBox.className="rightbox";var controls=document.createElement("div");controls.className="controls";var status=document.createElement("div");status.id="status";status.innerHTML="You are connecting to the call";elementId.status=status.id;var action=document.createElement("div");action.id="action";elementId.joinChat=action.id;var endChat=document.createElement("div");endChat.id="endChat";elementId.endChat=endChat.id;var countHeader=document.createElement("div");countHeader.id="count-header";countHeader.innerHTML="Not yet connected";elementId.countHeader=countHeader.id;var participants=document.createElement("div");participants.id="participants";elementId.participants=participants.id;var watchers=document.createElement("div");watchers.id="watchers";elementId.watchers=watchers.id;controls.appendChild(status);controls.appendChild(action);controls.appendChild(endChat);controls.appendChild(countHeader);controls.appendChild(participants);controls.appendChild(watchers);rightBox.appendChild(controls);mainPlaceholder.appendChild(rightBox);self.targetElement.appendChild(mainPlaceholder)})()}else{for(var i=0;i<elements.length;++i){var element=elements[i];if(elementId.hasOwnProperty(element.key)){elementId[element.key]=element.value}}}var session=null,publisher=null,PUBLISHER_WIDTH=parseInt(tagObject.publisherWidth)||160,PUBLISHER_HEIGHT=parseInt(tagObject.publisherHeight)||120,SUBSCRIBER_WIDTH=parseInt(tagObject.subscriberWidth)||160,SUBSCRIBER_HEIGHT=parseInt(tagObject.subscriberHeight)||120,participants=0,watchers=0,connections=[],userTokens=[],xhrUrl="handler/VideoChatSession.ashx",globalTrigger="global_videoChat";var apiKey=xRTML.Common.Converter.toNumber(tagObject.apikey);var sessionId=tagObject.sessionid;var token=tagObject.token;this.role=roles[tagObject.role]||roles.publisher;this.maxUsers=tagObject.maxusers||10;this.tokenOnDemand=false;this.publishOnConnect=true;this.allowWatchers=false;this.onReady=tagObject.onready?new Function("event","return "+tagObject.onready+"(event);"):null;this.handlerUrl=tagObject.handlerurl||xhrUrl;this.persist=xRTML.Common.Converter.toBoolean(tagObject.persist);var storeCookie=function(data){if(self.persist){var cookieName="xRTMLVideoChatCookie",cookieData=xRTML.Common.Cookie.getCookie(cookieName);if(cookieData===null){xRTML.Common.Cookie.setCookie(cookieName,JSON.stringify(data));return true}}return false};var getCookie=function(){if(self.persist){var cookieData=xRTML.Common.Cookie.getCookie("xRTMLVideoChatCookie");if(cookieData!==null){cookieData=JSON.parse(cookieData);sessionId=cookieData.sId;token=cookieData.t;userTokens=cookieData.ut;return true}}return false};var deleteCookie=function(){if(self.persist&&xRTML.Common.Cookie.getCookie("xRTMLVideoChatCookie")!==null){xRTML.Common.Cookie.deleteCookie("xRTMLVideoChatCookie")}};var setElementValue=function(elementId,value){if(elementId){document.getElementById(elementId).innerHTML=value}};var startPublishing=function(){var parentDiv=document.getElementById(elementId.userCamera);var stubDiv=document.createElement("div");stubDiv.id="xrtmlOpentokPublisher";parentDiv.appendChild(stubDiv);publisher=session.publish(stubDiv.id,{width:PUBLISHER_WIDTH,height:PUBLISHER_HEIGHT});self.dispatchEvent("onStartPublishing")};var stopPublishing=function(){if(publisher!=null){session.unpublish(publisher);publisher=null}self.dispatchEvent("onStopPublishing")};var forceUnpublish=function(stream){session.forceUnpublish(stream);self.dispatchEvent("onForceUnpublish",{stream:stream})};var forceDisconnect=function(connection){session.forceDisconnect(connection.connectionId);self.dispatchEvent("onForceUnpublish",{connectionId:connection.connectionId})};var subscribeToStream=function(stream){var container=document.createElement("div");container.className="subscriberContainer";var containerId="container_"+stream.streamId;container.setAttribute("id",containerId);document.getElementById(elementId.participantCameras).appendChild(container);var div=document.createElement("div");var divId=stream.streamId;div.setAttribute("id",divId);div.style["float"]="top";container.appendChild(div);if(self.role===roles.moderator){var moderationControls=document.createElement("div");moderationControls.style["float"]="bottom";moderationControls.innerHTML='<a href="#" id="aForceDisconnect">Disconnect</a><a href="#" id="aForceUnpublish">Unpublish</a>';container.appendChild(moderationControls);var aForceDisconnect=document.getElementById("aForceDisconnect"),aForceUnpublish=document.getElementById("aForceUnpublish");Events.Manager.addEventListener(aForceDisconnect,"click",function(){forceDisconnect(stream.connection)},false);Events.Manager.addEventListener(aForceUnpublish,"click",function(){forceUnpublish(stream)},false)}session.subscribe(stream,divId,{width:SUBSCRIBER_WIDTH,height:SUBSCRIBER_HEIGHT});participants++};var unsubscribeFromStream=function(stream){if(self.role==roles.moderator){var actions=document.getElementById("container_"+stream.streamId);document.getElementById(elementId.participantCameras).removeChild(actions)}session.unsubscribe(stream);participants--};var exceptionHandler=function(event){alert("Exception: "+event.code+"::"+event.message);self.dispatchEvent("onException",{code:event.code,message:event.message})};var streamCreatedHandler=function(event){for(var i=0;i<event.streams.length;i++){if(event.streams[i].connection.connectionId!=event.target.connection.connectionId){subscribeToStream(event.streams[i]);watchers--}else{participants++;watchers--}}self.dispatchEvent("onStreamCreated",event)};var streamDestroyedHandler=function(event){for(var i=0;i<event.streams.length;i++){if(event.streams[i].connection.connectionId!=event.target.connection.connectionId){unsubscribeFromStream(event.streams[i]);watchers++}else{if(document.getElementById(elementId.status)){var publishBtn=document.getElementById("startPublishing");Events.Manager.addEventListener(publishBtn,"click",function(){startPublishing()},false)}participants--;watchers++}}self.dispatchEvent("onStreamDestroyed",event)};var sessionConnectedHandler=function(event){for(var i=0;i<event.connections.length;i++){connections.push(event.connections[i])}for(var i=0;i<event.streams.length;i++){subscribeToStream(event.streams[i])}if(!self.allowWatchers){startPublishing()}self.dispatchEvent("sessionConnected",event)};var connectionDestroyedHandler=function(event){var connection=event.connections[0],metadata=JSON.parse(connection.data);for(var i=connections.length-1;i>=0;i--){if(connections[i].connectionId==connection.connectionId){connections.splice(i,1);break}}};var connectionCreatedHandler=function(event){connections.push(event.connection);if(!self.allowWatchers){startPublishing()}self.dispatchEvent("connectionCreated",event)};var connectionCreatedHandler=function(event){for(var i=0;i<event.connections.length;i++){connections.push(event.connections[i])}};var createSessionHandler=function(result){if(this.readyState==4){if(this.status==200){var response=JSON.parse(this.responseText);sessionId=response.sId;token=response.t;userTokens=response.ut;isReady=true;var event={sessionId:sessionId};if(self.onReady&&typeof self.onReady==="function"){self.onReady(event)}self.dispatchEvent("onReady",event);storeCookie(response)}else{xRTML.Console.error("Error: "+this.responseText)}}};var sendSessionHandler=function(result){if(this.readyState==4){if(this.status==200){var response=JSON.parse(this.responseText);var message=xRTML.createMessage(globalTrigger,"getSession",{sessionId:response.sid,token:response.t},this.internalId);xRTML.sendMessage(channel,message)}else{xRTML.Console.error("Error: "+this.responseText)}}};var startSession=function(){if(TB.checkSystemRequirements()!=TB.HAS_REQUIREMENTS){xRTML.Console.error("Unable to run TokBox OpenTok in this browser.")}else{Events.Manager.addEventListener(TB,"exception",exceptionHandler);session=TB.initSession(sessionId);Events.Manager.addEventListener(session,"sessionConnected",sessionConnectedHandler);Events.Manager.addEventListener(session,"connectionCreated",connectionCreatedHandler);Events.Manager.addEventListener(session,"connectionDestroyed",connectionDestroyedHandler);Events.Manager.addEventListener(session,"streamCreated",streamCreatedHandler);Events.Manager.addEventListener(session,"streamDestroyed",streamDestroyedHandler);setElementValue(elementId.endChat,'<a id="endSession" href="#">Leave</a>');var endSessionBtn=document.getElementById("endSession");if(endSessionBtn){Events.Manager.addEventListener(endSessionBtn,"click",function(){endSession()},false)}}self.addEventListener("active",function(active){if(active){var connectionProperties={senderId:self.internalId,token:token,role:self.role};session.connect(apiKey,token)}else{if(session){endSession()}}});if(self.active){self.activate()}};var endSession=function(){if(self.role===roles.moderator){for(var i=1;i<connections.length;++i){forceDisconnect(connections[i])}}session.disconnect();session.cleanup();deleteCookie()};var isReady=false;this.sendSession=function(data){if(this.role==roles.moderator){if(this.tokenOnDemand){var xhrData={o:"GenerateToken",sId:sessionId,t:roles.publisher},xhr=new xRTML.Common.xhr("post",this.handlerUrl,sendSessionHandler);xhr.send(JSON.stringify(xhrData))}else{if(isReady){var userToken=userTokens.length==0?null:userTokens.pop(),message=xRTML.createMessage(globalTrigger,"getSession",{sId:sessionId,t:userToken},self.internalId);xRTML.sendMessage(self.channelId,message)}else{var onReadySend=function(e){self.sendSession(null);self.removeEventListener("onReady",onReadySend)};this.addEventListener("onReady",onReadySend)}}}};this.getSession=function(message){var data=message.data;sessionId=data.sId;token=data.t;if(token!==null){startSession()}storeCookie(data)};switch(this.role){case roles.moderator:if(!getCookie()){var onReadySession=function(e){startSession();self.removeEventListener("onReady",onReadySession)};this.addEventListener("onReady",onReadySession);var xhrData={o:"CreateSession",nu:!this.tokenOnDemand?this.maxUsers:{}},xhr=new xRTML.Common.xhr("post",this.handlerUrl,createSessionHandler,true);xhr.send(JSON.stringify(xhrData))}else{isReady=true;startSession()}break;case roles.publisher:if(!getCookie()){var message=xRTML.createMessage(globalTrigger,"sendSession",{},self.internalId);xRTML.sendMessage(self.channelId,message)}else{startSession()}break}};xRTML.Tags.ShoutBox=xRTML.Tag.makeSubclass();xRTML.registerTag("ShoutBox");xRTML.Tags.ShoutBox.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);var elements=tagObject.elements,elementId={shoutbox:"",shouts:"",loginArea:"",userArea:"",iUsername:"",bEnterChat:"",lbUsername:"",taUserInput:""};for(var i=0;i<elements.length;++i){var element=elements[i];if(elementId.hasOwnProperty(element.key)){elementId[element.key]=element.value}}var userInputArea=document.getElementById(elementId.taUserInput),shoutsArea=document.getElementById(elementId.shouts),username="",cookieName="xRTMLShoutBox",self=this;this.historyRepository=tagObject.historyrepository||null;this.onMessage=function(message){var e={target:self,message:message,id:self.internalId};tagObject.onmessage?new Function("e","return "+tagObject.onmessage+"(e);")(e):null;self.dispatchEvent("onMessage",e)};this.onMessagePost=function(message){var e={target:self,message:message,id:self.internalId};tagObject.onmessagepost?new Function("e","return "+tagObject.onmessagepost+"(e);")(e):null;self.dispatchEvent("onMessagePost",e)};this.onMessageHistory=function(message){var e={target:self,messages:messages,id:self.internalId};tagObject.onmessagehistory?new Function("e","return "+tagObject.onmessagehistory+"(e);")(e):null;self.dispatchEvent("onMessageHistory",e)};for(var i=0;i<this.triggers.length;++i){cookieName+="_"+this.triggers[i].name}var displayMessage=function(username,message){var paragraph=document.createElement("p"),userElement=document.createElement("em"),messageElement=document.createElement("span");userElement.innerHTML=username;messageElement.innerHTML=message;paragraph.appendChild(userElement);paragraph.appendChild(messageElement);shoutsArea.appendChild(paragraph);shoutsArea.scrollTop=shoutsArea.scrollHeight};var loginUser=function(){var loginArea=document.getElementById(elementId.loginArea),userArea=document.getElementById(elementId.userArea),lbUsername=document.getElementById(elementId.lbUsername),iUserName=document.getElementById(elementId.iUsername);lbUsername.innerHTML=iUserName.value;username=iUserName.value;loginArea.style.display="none";userArea.style.display="block";if(self.historyRepository!=null){var getShoutHistory=function(result){if(this.readyState==4){if(this.status==200){var messages=JSON.parse(this.responseText);onMessageHistory(messages);for(var i=0;i<messages.length;++i){var message=messages[i];displayMessage(message.u,message.m)}}else{xRTML.Console.error("Error in ShoutBox tag with id "+(self.id||self.internalId)+": "+this.responseText)}}};var xhrData={o:"GetShoutMessages",p:{t:cookieName}},xhr=new xRTML.Common.xhr("post",self.historyRepository,getShoutHistory);xhr.send(JSON.stringify(xhrData))}};var cookie=xRTML.Common.Cookie.getCookie(cookieName);if(cookie){var iUserName=document.getElementById(elementId.iUsername);iUserName.value=cookie;loginUser()}var onKeyPressed=function(e){var key=e.keyCode?e.keyCode:e.which?e.which:e.charCode;if(key==13){var message=userInputArea.value.replace(/[\n\r\t]/g,"");userInputArea.value="";self.post(message)}};Events.Manager.addEventListener(userInputArea,"keypress",onKeyPressed);var onEnterChat=function(e){loginUser();xRTML.Common.Cookie.setCookie(cookieName,username);self.dispatchEvent("onUserEnter",{username:username})};Events.Manager.addEventListener(document.getElementById(elementId.bEnterChat),"click",onEnterChat);this.get=function(xrtmlMessage){var data=xrtmlMessage.data;self.onMessage(data);displayMessage(data.u,data.m)};this.post=function(message){var action="get",data={t:cookieName,u:username,m:message},dataString=JSON.stringify(data);for(var iter=0;iter<this.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(this.triggers[iter].name,action,dataString,this.internalId);xRTML.sendMessage(this.channelId,xrtmlMessage.stringify())}if(self.historyRepository!=null){var saveShout=function(xhr){if(this.readyState==4&&this.status==200){}};var xhrData={o:"SaveShoutMessage",p:data},xhr=new xRTML.Common.xhr("post",this.historyRepository,saveShout);xhr.send(JSON.stringify(xhrData))}self.onMessagePost(data);displayMessage(username,message)}};xRTML.Tags.GeoLocation=xRTML.Tag.makeSubclass();xRTML.registerTag("GeoLocation");xRTML.Tags.GeoLocation.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);if(tagObject.errorhandler){this.errorHandler=tagObject.errorhandler?(typeof tagObject.errorhandler=="function"?tagObject.errorhandler:new Function("","return "+tagObject.errorhandler+"();")):null}else{this.errorHandler=function(err){xRTML.ErrorHandler().tagError(err)}}this.enableHighAccuracy=xRTML.Common.Converter.toBoolean(tagObject.enablehighaccuracy);this.message=tagObject.message;if((typeof this.enableHighAccuracy=="undefined")){this.enableHighAccuracy=false}if(tagObject.timeout&&tagObject.timeout>100){this.timeout=xRTML.Common.Converter.toNumber(tagObject.timeout)}else{this.timeout=2000}if(tagObject.maximumage){this.maximumAge=xRTML.Common.Converter.toNumber(tagObject.maximumage)}else{this.maximumAge=0}var self=this;this.addEventListener("active",function(active){if(active){self.activateGeoLocation()}},false);if(this.active){this.activate()}this.process=function(message){this.responseProcessed=true}};xRTML.Tags.GeoLocation.prototype.activateGeoLocation=function(){this.startSendingPosition()};xRTML.Tags.GeoLocation.prototype.startSendingPosition=function(){var self=this;function updatePosition(position){if(self.active){for(var iter=0;iter<self.triggers.length;iter++){var message=xRTML.createMessage(self.triggers[iter].name,"delegate",{latitude:position.coords.latitude,longitude:position.coords.longitude,message:self.message});xRTML.sendMessage(self.channelId,message)}}else{navigator.geolocation.clearWatch(self.watchPosition)}}self.watchPosition=navigator.geolocation.watchPosition(updatePosition,self.errorHandler,{enableHighAccuracy:self.enableHighAccuracy,timeout:self.timeout,maximumAge:self.maximumAge})};xRTML.Tags.Toast=xRTML.Tag.makeSubclass();xRTML.registerTag("Toast");xRTML.Tags.Toast.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);this.containerId=typeof tagObject.containerid!="undefined"?tagObject.containerid:"trayMessage";this.containerClass=typeof tagObject.containerclass!="undefined"?tagObject.containerclass:"";this.timeToLive=typeof tagObject.timetolive!="undefined"?xRTML.Common.Converter.toNumber(tagObject.timetolive):10000;this.title=tagObject.title;this.text=tagObject.text;this.destinationUrl=tagObject.destinationurl;this.bannerUrl=tagObject.bannerurl;this.bannerContent=tagObject.bannercontent;this.bannerType=tagObject.bannertype?tagObject.bannerType:"image";this.positionAt=tagObject.positionat;this.positionAtX=typeof tagObject.positionatx!="undefined"?xRTML.Common.Converter.toNumber(positionatx):0;this.positionAtY=typeof tagObject.positionaty!="undefined"?xRTML.Common.Converter.toNumber(positionaty):0;this.displayBanner=typeof tagObject.displaybanner!="undefined"?xRTML.Common.Converter.toBoolean(tagObject.displaybanner):false;this.changePageTitle=typeof tagObject.changepagetitle!="undefined"?xRTML.Common.Converter.toBoolean(tagObject.changePageTitle):true;this.videoHeight=typeof tagObject.videoheight!="undefined"?xRTML.Common.Converter.toNumber(tagObject.videoheight):null;this.videoWidth=typeof tagObject.videowidth!="undefined"?xRTML.Common.Converter.toNumber(tagObject.videowidth):null;this.mediaUrls=tagObject.mediaurls;if(tagObject.jqueryeffects&&tagObject.jqueryeffects.length>0){this.jQueryEffectsOnNewElement=[];for(var i=0,len=tagObject.jqueryeffects.length;i<len;i++){var effectId=tagObject.jqueryeffects[i].id;if(effectId){this.jQueryEffectsOnNewElement.push(effectId)}else{xRTML.ErrorHandler().tagError(new Error("xrtml:jqueryeffect required an id to be specified."))}}this.jQueryEffectManagerInstance=xRTML.JQueryEffectManager.getInstance(this);this.jQueryEffectManagerInstance.init(tagObject.jqueryeffects)}this.process=function(message){var sessionId;if((typeof _realtimeSessionId!="undefined")&&_realtimeSessionId){sessionId=_realtimeSessionId}else{sessionId=""}if(message.data.sendAll||(message.data.sessionId==sessionId)){var args={};args.title=typeof message.data.title!="undefined"?message.data.title:this.title;args.text=typeof message.data.text!="undefined"?message.data.text:this.text;args.destinationUrl=typeof message.data.destinationUrl!="undefined"?message.data.destinationUrl:this.destinationUrl;args.bannerUrl=typeof message.data.bannerUrl!="undefined"?message.data.bannerUrl:this.bannerUrl;args.bannerContent=typeof message.data.bannerContent!="undefined"?message.data.bannerContent:this.bannerContent;args.bannerType=typeof message.data.bannerType!="undefined"?message.data.bannerType:this.bannerType;args.positionAt=typeof message.data.positionAt!="undefined"?message.data.positionAt:this.positionAt;args.positionAtX=typeof message.data.positionAtX!="undefined"?message.data.positionAtX:this.positionAtX;args.positionAtY=typeof message.data.positionAtY!="undefined"?message.data.positionAtY:this.positionAtY;args.displayBanner=typeof message.data.displayBanner!="undefined"?xRTML.Common.Converter.toBoolean(message.data.displayBanner):this.displayBanner;args.videoHeight=typeof message.data.videoHeight!="undefined"?xRTML.Common.Converter.toBoolean(message.data.videoHeight):this.videoHeight;args.videoWidth=typeof message.data.videoWidth!="undefined"?xRTML.Common.Converter.toBoolean(message.data.videoWidth):this.videoWidth;this.showToast(args)}};this.onToastDisplayed=function(){var e={target:self};tagObject.ontoastdisplayed?new Function("e","return "+tagObject.ontoastdisplayed+"(e);")(e):null;this.dispatchEvent("onToastDisplayed")};this.onToastClosed=function(){var e={target:self};tagObject.ontoastclosed?new Function("e","return "+tagObject.ontoastclosed+"(e);")(e):null;this.dispatchEvent("onToastClosed")};this.onBannerDisplayed=function(){var e={target:self};tagObject.onbannerdisplayed?new Function("e","return "+tagObject.onbannerdisplayed+"(e);")(e):null;this.dispatchEvent("onBannerDisplayed")};this.onBannerClosed=function(){var e={target:self};tagObject.onbannerclosed?new Function("e","return "+tagObject.onbannerclosed+"(e);")(e):null;this.dispatchEvent("onBannerClosed")};this.onRedirect=function(){var e={target:self,url:self.destinationUrl};tagObject.onredirect?new Function("e","return "+tagObject.onredirect+"(e);")(e):null;this.dispatchEvent("onRedirect")};this.onLoad(this)};xRTML.Tags.Toast.prototype.closeToast=function(){var self=this;if((typeof jQuery!="undefined")){jQuery("#"+self.containerId).animate({opacity:0},{duration:500,complete:function(){jQuery("#"+self.containerId).remove()}})}else{if(document.getElementById(self.containerId)){document.body.removeChild(document.getElementById(self.containerId))}}if(self.changePageTitle&&self.currentPageTitle){document.title=self.currentPageTitle}self.onToastClosed()};xRTML.Tags.Toast.prototype.showToast=function(args){var self=this;var selfArgs=args;if(this.jQueryEffectManagerInstance){this.jQueryEffectManagerInstance.stopAllEffectsAndClearQueue()}if(document.getElementById(this.containerId)){this.closeToast()}var displayBanner=function(){self.showBanner(selfArgs)};var toastDiv=document.createElement("div");toastDiv.id=this.containerId;toastDiv.className=this.containerClass;var closeDiv=document.createElement("div");closeDiv.className="close";toastDiv.appendChild(closeDiv);var contentDiv=document.createElement("div");contentDiv.className="content";if(selfArgs.title){var titleElement=document.createElement("h3");contentDiv.appendChild(titleElement);titleElement.innerHTML=selfArgs.title;titleElement.innerText=selfArgs.title}var textDiv=document.createElement("p");contentDiv.appendChild(textDiv);textDiv.innerHTML=selfArgs.text;textDiv.innerText=selfArgs.text;toastDiv.appendChild(contentDiv);document.body.appendChild(toastDiv);var closeToastPriv=function(){self.closeToast()};var redirect=function(){if(selfArgs.destinationUrl){window.open(selfArgs.destinationUrl,"_blank");self.onRedirect()}else{self.closeToast()}};Events.Manager.addEventListener(closeDiv,"click",closeToastPriv);if(selfArgs.displayBanner){Events.Manager.addEventListener(contentDiv,"click",displayBanner)}else{Events.Manager.addEventListener(contentDiv,"click",redirect)}function showPageToast(){if((typeof jQuery!="undefined")){jQuery("#"+self.containerId).show()}else{toastDiv.style.display="block"}self.positionToast(args.positionAt,args.positionAtX,args.positionAtY);if(this.jQueryEffectManagerInstance){for(var it=0;it<self.jQueryEffectsOnNewElement.length;it++){self.jQueryEffectManagerInstance.addEffectToQueue({element:toastDiv,effectId:self.jQueryEffectsOnNewElement[it]})}}if(this.jQueryEffectManagerInstance){this.jQueryEffectManagerInstance.runAllEffects()}if(self.changePageTitle){self.currentPageTitle=document.title;document.title=args.title}setTimeout(function(){closeToastPriv()},self.timeToLive);if((typeof self.mediaUrls!="undefined")&&self.mediaUrls.length>0){var types={ogg:"audio/ogg",mp3:"audio/mpeg"};var audio=document.createElement("audio");audio.setAttribute("id","xrtmlAudio");document.body.appendChild(audio);for(var i=0;i<self.mediaUrls.length;i++){var url=self.mediaUrls[i];if(audio.canPlayType(types[url.ext])!=""){audio.src=url.file;audio.load();audio.play();break}}}self.onToastDisplayed()}showPageToast()};xRTML.Tags.Toast.prototype.showBanner=function(args){var selfDestinationUrl=args.destinationUrl,self=this;this.closeToast();var redirect=function(e){e.preventDefault();if(selfDestinationUrl){window.open(selfDestinationUrl,"_blank");self.onRedirect(e);self.closeBanner(e)}else{self.closeBanner(e)}};if((typeof jQuery!="undefined")&&jQuery.fancybox){var fancyboxAnchor=document.createElement("a");fancyboxAnchor.id="xRTMLAnchorContentContainer";var fancyboxObj={};fancyboxObj.overlayShow=true;fancyboxObj.onClosed=function(){var fancyBoxAnchorInDOM=document.getElementById("xRTMLAnchorContentContainer");if(fancyBoxAnchorInDOM){document.body.removeChild(fancyboxAnchor)}self.onBannerClosed()};fancyboxObj.onComplete=function(e){Events.Manager.addEventListener(document.getElementById("fancybox-inner"),"click",function(e){redirect(e)})};switch(args.bannerType){case ("html"):try{fancyboxAnchor.innerHTML=args.bannerContent;fancyboxObj.type="inline";jQuery(fancyboxAnchor).fancybox(fancyboxObj).click()}catch(err){xRTML.ErrorHandler().tagError("bannerContent does not contain valid html.")}break;case ("image"):fancyboxObj.type="image";fancyboxObj.href=args.bannerUrl;jQuery(fancyboxAnchor).fancybox(fancyboxObj).click();break;case ("video"):var content=document.createElement("video");if(self.videoHeight){content.height=self.videoHeight}if(self.videoWidth){content.width=self.videoWidth}content.id="xRTMLVideoContainer";content.src=args.bannerUrl;fancyboxAnchor.appendChild(content);fancyboxObj.type="inline";fancyboxObj.onComplete=function(){content.play()};Events.Manager.addEventListener(content,"loadedmetadata",function(){jQuery(fancyboxAnchor).fancybox(fancyboxObj).click()});break;case ("iframe"):fancyboxObj.type="iframe";fancyboxObj.href=args.bannerUrl;jQuery(fancyboxAnchor).fancybox(fancyboxObj).click();break;case ("flash"):fancyboxObj.type="swf";fancyboxObj.href=args.bannerUrl;jQuery(fancyboxAnchor).fancybox(fancyboxObj).click();break;default:fancyboxObj.type="image";fancyboxObj.href=args.bannerUrl;jQuery(fancyboxAnchor).fancybox(fancyboxObj).click();break}}else{var contentDiv=document.createElement("div");contentDiv.id="xRTMLBannerContainer";var anchorElement=document.createElement("a");anchorElement.setAttribute("href",selfDestinationUrl);anchorElement.setAttribute("target","_blank");anchorElement.addEventListener("click",function(e){redirect(e)});switch(args.bannerType){case ("html"):try{anchorElement.innerHTML=args.bannerContent}catch(err){xRTML.ErrorHandler().tagError("bannerContent does not contain valid html.")}break;case ("image"):var content=document.createElement("img");content.src=args.bannerUrl;anchorElement.appendChild(content);break;case ("video"):var content=document.createElement("video");if(self.videoHeight){content.height=self.videoHeight}if(self.videoWidth){content.width=self.videoWidth}content.src=args.bannerUrl;anchorElement.appendChild(content);content.play();break;case ("iframe"):var content=document.createElement("iframe");content.src=args.bannerUrl;content.style.height="40%";content.style.width="70%";anchorElement.appendChild(content);break;case ("flash"):var content=document.createElement("object");content.data=args.bannerUrl;content.type="application/x-shockwave-flash";content.style.height="40%";content.style.width="70%";anchorElement.appendChild(content);break;default:var content=document.createElement("img");content.src=args.bannerUrl;anchorElement.appendChild(content);break}contentDiv.appendChild(anchorElement);document.body.appendChild(contentDiv)}self.onBannerDisplayed()};xRTML.Tags.Toast.prototype.closeBanner=function(e){var self=this;if((typeof jQuery!="undefined")&&jQuery.fancybox){jQuery.fancybox.close(e)}else{var container=document.getElementById("xRTMLBannerContainer");if(container){document.body.removeChild(container)}}self.onBannerClosed()};xRTML.Tags.Toast.prototype.positionToast=function(positionAt,positionAtX,positionAtY){var windowHeight;var windowWidth;if(typeof(window.innerWidth)=="number"){windowHeight=window.innerHeight;windowWidth=window.innerWidth}else{windowHeight=document.documentElement.clientHeight;windowWidth=document.documentElement.clientWidth}var toastDiv=document.getElementById(this.containerId);toastDiv.style.position="absolute";var toastHeight=toastDiv.clientHeight;var toastWidth=toastDiv.clientWidth;switch(positionAt){case"coordinates":toastDiv.style.top=positionAtY+"px";toastDiv.style.left=positionAtX+"px";break;case"topleft":toastDiv.style.top=15+"px";toastDiv.style.left=15+"px";break;case"topcenter":toastDiv.style.top=15+"px";toastDiv.style.left=windowWidth/2-(toastWidth/2)+"px";break;case"topright":toastDiv.style.top=15+"px";toastDiv.style.left=windowWidth-toastWidth-15+"px";break;case"middleleft":toastDiv.style.top=windowHeight/2-(toastHeight/2)+"px";toastDiv.style.left=15+"px";break;case"middlecenter":toastDiv.style.top=windowHeight/2-(toastHeight/2)+"px";toastDiv.style.left=windowWidth/2-(toastWidth/2)+"px";break;case"middleright":toastDiv.style.top=windowHeight/2-(toastHeight/2)+"px";toastDiv.style.left=windowWidth-toastWidth-15+"px";break;case"bottomleft":toastDiv.style.top=windowHeight-toastHeight-30+"px";toastDiv.style.left=15+"px";break;case"bottomcenter":toastDiv.style.top=windowHeight-toastHeight-30+"px";toastDiv.style.left=windowWidth/2-(toastWidth/2)+"px";break;case"bottomright":toastDiv.style.top=windowHeight-toastHeight-30+"px";toastDiv.style.left=windowWidth-toastWidth-15+"px";break;default:toastDiv.style.top=windowHeight-toastHeight-30+"px";toastDiv.style.left=windowWidth-toastWidth-15+"px";break}};xRTML.Tags.Media=xRTML.Tag.makeSubclass();xRTML.registerTag("Media");xRTML.Tags.Media.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);xRTML.Common.Validator.validateRequired(this.channelId);this.target=this.target instanceof Array?this.target[0]:document.body;this.width=tagObject.width||null;this.height=tagObject.height||null;this.autoplay=typeof tagObject.autoplay!=="boolean"?(tagObject.autoplay==="true"||true):tagObject.autoplay;this.loop=typeof tagObject.loop!=="boolean"?(tagObject.loop==="true"||false):tagObject.loop;this.controls=typeof tagObject.controls!=="boolean"?(tagObject.controls==="true"||false):tagObject.controls;this.mute=typeof tagObject.mute!=="boolean"?(tagObject.mute==="true"||true):tagObject.mute;this.loadStatus=0;this.sources=(function(){var container=[],curr=-1;return{current:function(){return(container.length&&curr!=-1)!=0?container[curr]:null},currentIndex:function(){return curr},next:function(){curr=(++curr)<container.length?curr:0;return container.length!=0?container[curr]:null},previous:function(){curr=--curr<0?(container.length-1):curr;return container.length!=0?container[curr]:null},insert:function(sources,idx){if(sources&&idx>0&&idx<(container.length+1)){if(!(sources instanceof Array)){sources=[sources]}for(var i=sources.length-1;i>=0;--i){container.splice(idx,0,sources[i])}if(curr!=-1&&idx<curr){curr+=sources.length}}},push:function(sources){if(sources){if(!(sources instanceof Array)){sources=[sources]}container.push.apply(container,sources)}},removeAt:function(idx){var element=null;if(idx>=0&&idx<container.length){element=container.splice(idx,1);if(curr>container.length||idx<curr){--curr}}return element},remove:function(source){for(var i=0;i<container.length;++i){var _source=container[i],isEqual=true;for(var attr in source){if(source[attr]!=_source[attr]){isEqual=false;break}}if(isEqual){return this.removeAt(i)}}return null},pop:function(){return this.removeAt(container.length-1)},purge:function(){container=[];curr=-1},length:function(){return container.length}}})();var self=this;var FlashPlayer=function(config){xRTML.Common.DOM.loadScript("http://code.xrtml.org/plugins/swfobject.js",function(){});this.id=xRTML.Common.Util.idGenerator();this.target=config.target;this.width=config.width;this.height=config.height;this.formats={swf:this.canPlayType("swf")}};FlashPlayer.prototype={play:function(source){var filename=source.files.swf;if(filename){this.stop();var mediaContainer=document.createElement("span");mediaContainer.id=this.id;this.target.appendChild(mediaContainer);var flashvars={},params={allowScriptAccess:"always",play:"true",loop:"true"},attributes={id:"FLVplayer_"+this.id,name:"FLVplayer_"+this.id,align:"middle"},outputStatus=function(e){};swfobject.embedSWF(filename,this.id,this.width,this.height,"9.0.0",null,flashvars,params,attributes,outputStatus);this.restart=function(){this.stop();this.play(source)}}},stop:function(){swfobject.removeSWF("FLVplayer_"+this.id)},pause:function(){},restart:function(){},skip:function(){},mute:function(){},volume:function(){},canPlayExtension:function(ext){var type=this.supportedMedia[ext];if(typeof type==="undefined"){return false}return this.canPlayType(type)},canPlayType:function(type){return type==="swf"}};var MediaPlayer=function(config){this.id=xRTML.Common.Util.idGenerator();var player=document.createElement(config.type);player.id=this.id;player.width=config.width;player.height=config.height;player.poster=config.poster;player.autoplay=config.autoplay;player.loop=config.loop;player.muted=config.muted;player.controls=config.controls;config.target.appendChild(player);config.target=player;this.fallback=new FlashPlayer(config);this.supportedMedia={};for(var attr in config.formats){this.supportedMedia[attr]=this.canPlayType(config.formats[attr])}var parent=this;function progressHandler(e){var endBuf=e.target.buffered.end(0);parent.loadStatus=parseInt(((endBuf/e.target.duration)*100))}Events.Manager.addEventListener(player,"progress",progressHandler);if(config.keepRatio){function loadedMetadataHandler(e){e.target.height=e.target.videoHeight;e.target.width=e.target.videoWidth}Events.Manager.addEventListener(player,"loadedmetadata",loadedMetadataHandler)}function playHandler(e){}Events.Manager.addEventListener(player,"play",playHandler);function playingHandler(e){}Events.Manager.addEventListener(player,"playing",playingHandler);function pauseHandler(e){}Events.Manager.addEventListener(player,"pause",pauseHandler);function endedHandler(e){if(self.autoplay&&self.sources.next()){parent.play(self.sources.current())}}Events.Manager.addEventListener(player,"ended",endedHandler);function errorHandler(e){if(e.target.error!==null){var error="";switch(e.target.error.code){case e.target.error.MEDIA_ERR_ABORTED:error="You aborted the video playback.";break;case e.target.error.MEDIA_ERR_NETWORK:error="A network error caused the video download to fail part-way.";break;case e.target.error.MEDIA_ERR_DECODE:error="The video playback was aborted due to a corruption problem or because the video used features your browser did not support.";break;case e.target.error.MEDIA_ERR_SRC_NOT_SUPPORTED:error="The video could not be loaded, either because the server or network failed or because the format is not supported.";break;default:error="An unknown error occurred.";break}xRTML.Console.error(error)}}Events.Manager.addEventListener(player,"error",errorHandler)};MediaPlayer.prototype={loadStatus:0,play:function(source){for(var ext in source.files){if(this.supportedMedia[ext]===true){var player=document.getElementById(this.id);player.autoplay=source.autoplay===player.autoplay?player.autoplay:source.autoplay;player.loop=source.loop===player.loop?player.loop:source.loop;player.src=source.files[ext];return}}if(fallback&&source.files.swf){fallback.play(source)}else{document.getElementById(this.id).innerHTML="Your browser cannot play these movie types."}},stop:function(){var mediaPlayer=document.getElementById(this.id);mediaPlayer.currentTime=mediaPlayer.duration},pause:function(){var mediaPlayer=document.getElementById(this.id);mediaPlayer.paused?mediaPlayer.play():mediaPlayer.pause()},restart:function(){var mediaPlayer=document.getElementById(this.id);mediaPlayer.currentTime=0},skip:function(time){var player=document.getElementById(this.id);player.currentTime=time},mute:function(){var mediaPlayer=document.getElementById(this.id);mediaPlayer.muted=!mediaPlayer.muted},volume:function(measure){var mediaPlayer=document.getElementById(this.id);mediaPlayer.volume=measure/100},isPlaying:function(){return document.getElementById(this.id).currentTime!=0},canPlayExtension:function(ext){var type=this.supportedMedia[ext];if(typeof type==="undefined"){return false}return this.canPlayType(type)},canPlayType:function(type){var mediaPlayer=document.getElementById(this.id),canPlay=mediaPlayer.canPlayType(type);return((canPlay=="maybe")||(canPlay=="probably"))}};var config={type:tagObject.type,formats:tagObject.formats,target:this.target,width:this.width,height:this.height,poster:this.poster,autoplay:this.autoplay,loop:this.loop,controls:this.controls,muted:this.mute,keepRatio:this.keepRatio};this.player=document.createElement(config.type).canPlayType?new MediaPlayer(config):new FlashPlayer(config);this.play=function(message){if(message.data.source){if(message.data.source.playNow){this.player.play(message.data.source)}else{this.sources.insert(message.data.source,this.sources.currentIndex()+1)}}else{if(this.sources.current()==null&&this.sources.length()!=0){this.player.play(this.sources.next())}else{this.player.play(this.sources.current())}}};this.stop=function(){this.player.stop()};this.pause=function(){this.player.pause()};this.restart=function(){this.player.restart()};this.mute=function(){this.player.mute()};this.volume=function(message){if(message.data&&message.data.volume){var newVolume=typeof message.data.volume==="string"?parseInt(message.data.volume):message.data.volume;if(newVolume>100){newVolume=100}if(newVolume<0){newVolume=0}this.player.volume(newVolume)}};this.skip=function(message){if(message.data&&message.data.skip){this.player.skip(typeof message.data.skip==="string"?parseInt(message.data.skip):message.data.skip)}};this.queue=function(message){if(message.data&&message.data.sources){this.sources.push(message.data.sources);if(this.autoplay&&!this.player.isPlaying()){this.play({data:{}})}}};this.unqueue=function(message){if(message.data&&message.data.source){this.sources.remove(message.data.source)}};this.next=function(){play(this.sources.next())};this.previous=function(){play(this.sources.previous())}};xRTML.Tags.Video=xRTML.Tags.Media.makeSubclass();xRTML.registerTag("Video");xRTML.Tags.Video.prototype.init=function(tagObject){this.poster=tagObject.poster||null;this.keepRatio=typeof tagObject.keepratio!=="boolean"?(tagObject.keepratio==="true"||true):tagObject.keepratio;tagObject.type="video";tagObject.formats={mp4:"video/mp4",ogg:"video/ogg",webm:"video/webm",avi:"video/divx"};tagObject.keepRatio=this.keepRatio;tagObject.poster=this.poster;xRTML.Tags.Media.prototype.init.call(this,tagObject)};xRTML.Tags.Audio=xRTML.Tags.Media.makeSubclass();xRTML.registerTag("Audio");xRTML.Tags.Audio.prototype.init=function(tagObject){tagObject.type="audio";tagObject.formats={mp3:"audio/mpeg",ogg:"audio/ogg",aac:"audio/mp4",wav:"audio/wav",pcm:"audio/webm"};xRTML.Tags.Media.prototype.init.call(this,tagObject)};xRTML.Tags.Map=xRTML.Tag.makeSubclass();xRTML.registerTag("Map");xRTML.Tags.Map.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);this.polylineElements=[];for(var i in tagObject.polylines){this.polylineElements.push(new xRTML.Tags.Map.Polyline(tagObject.polylines[i],this))}var targetId=tagObject.target;if(targetId){var pattern=/\.|\#|\:|\>|\-|\+|\~| /;var isTargetId=targetId.match(pattern);if(isTargetId==null){targetId="#"+targetId}this.target=Sizzle(targetId)[0]}this.targetDirections=tagObject.targetdirections;this.zoom=tagObject.zoom||3;this.latitude=tagObject.latitude||40;this.longitude=tagObject.longitude||-5;this.type=tagObject.type;this.typesMap={googlemap:"googlemap",bingmap:"bingmap"};this.drawingMode=tagObject.drawingmode;this.role=tagObject.role||"both";this.roles={sender:"sender",receiver:"receiver",both:"both"};this.markerType=tagObject.markertype||"image";this.imageURL=tagObject.imageurl;this.imageWidth=tagObject.imagewidth;if(!tagObject.imageWidth){if(this.imageURL){var newImg=new Image();newImg.src=this.imageURL;this.imageWidth=newImg.width}}this.imageHeight=tagObject.imageheight;if(!tagObject.imageHeight){if(this.imageURL){var newImg=new Image();newImg.src=this.imageURL;this.imageHeight=newImg.height}}this.offsetImageWidth=tagObject.offsetimagewidth||0;this.offsetImageHeight=tagObject.offsetimageheight||0;this.shadowImage=tagObject.shadowimage;this.offsetShadowImageWidth=tagObject.offsetshadowimagewidth||0;this.offsetShadowImageHeight=tagObject.offsetshadowimageheight||0;var colorMarker={strokeColor:tagObject.strokecolor,strokeOpacity:tagObject.strokeopacity,strokeWeight:tagObject.strokeweight,fillColor:tagObject.fillcolor,fillOpacity:tagObject.fillopacity};var colorRoute={strokeColor:tagObject.strokecolorroute||"#000000",strokeOpacity:tagObject.strokeopacityroute||1,strokeWeight:tagObject.strokeweightroute||1};this.infoWindow=tagObject.infowindow;this.viewMode=tagObject.viewmode;this.routeMode=tagObject.routeMode;var options={targetDirections:this.targetDirections,zoom:parseInt(this.zoom),latitude:parseFloat(this.latitude),longitude:parseFloat(this.longitude),drawingMode:this.drawingMode,role:this.role,markerType:this.markerType,imageURL:this.imageURL,imageWidth:this.imageWidth,imageHeight:this.imageHeight,polylineElements:this.polylineElements,colorMarker:colorMarker,colorRoute:colorRoute,infoWindow:this.infoWindow,viewMode:this.viewMode,routeMode:this.routeMode,offsetImageWidth:this.offsetImageWidth,offsetImageHeight:this.offsetImageHeight,shadowImage:this.shadowImage,offsetShadowImageWidth:this.offsetShadowImageWidth,offsetShadowImageHeight:this.offsetShadowImageHeight};switch(this.type){case this.typesMap.googlemap:xRTML.Console.debug("Create Google Map");this.mapIntance=new GoogleMap(tagObject.target,options);break;case this.typesMap.bingmap:xRTML.Console.debug("Create Bing Map");this.mapIntance=new BingMap(tagObject.target,options);break;default:xRTML.Console.debug("Type is not difine - Create Google Map");this.mapIntance=new GoogleMap(tagObject.target,options);break}var self=this;this.mapIntance.addEventListener("newLocation",function(e){xRTML.Console.debug("New Location");var data=JSON.stringify({ViewMode:e.ViewMode,Points:e.Points,Markers:e.Markers,Mode:e.Mode,RouteMode:e.RouteMode,MarkerType:e.MarkerType,ImageURL:e.ImageURL,ImageHeight:e.ImageHeight,ImageWidth:e.ImageWidth,PolylineElements:e.PolylineElements,ColorMarker:e.ColorMarker,ColorRoute:e.ColorRoute,InfoWindow:e.InfoWindow,OffsetImageWidth:e.OffsetImageWidth,OffsetImageHeight:e.OffsetImageHeight,ShadowImage:e.ShadowImage,OffsetShadowImageWidth:e.OffsetShadowImageWidth,OffsetShadowImageHeight:e.OffsetShadowImageHeight});for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,"AddLocation",data,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}});this.mapIntance.addEventListener("changeViewMode",function(e){xRTML.Console.debug("Change View Mode");var data=JSON.stringify({ViewMode:e.ViewMode});for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,"ChangeViewMode",data,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}});this.mapIntance.addEventListener("clearShapes",function(e){xRTML.Console.debug("Clear Shapes");for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,"ClearMap",null,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}});this.mapIntance.addEventListener("changeMarkets",function(e){xRTML.Console.debug("Change Markets");var data=JSON.stringify({MarkerId:e.MarkerId,MarkerLat:e.MarkerLat,MarkerLng:e.MarkerLng});for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,"ChangeMarket",data,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}});this.mapIntance.addEventListener("zoomChanged",function(e){xRTML.Console.debug("Zoom Changed");var data=JSON.stringify({Zoom:e.Zoom});for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,"ZoomChanged",data,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}});this.mapIntance.addEventListener("boundsChanged",function(e){xRTML.Console.debug("Bounds Changed");var data=JSON.stringify({SwLat:e.SwLat,SwLng:e.SwLng,NeLat:e.NeLat,NeLng:e.NeLng});for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,"BoundsChanged",data,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}});this.mapIntance.addEventListener("mapTypeIdChanged",function(e){xRTML.Console.debug("MapTypeId Changed");var data=JSON.stringify({MapTypeId:e.MapTypeId,LabelOverlay:e.LabelOverlay||0});for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,"MapTypeIdChanged",data,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}});this.mapIntance.addEventListener("streetViewChanged",function(e){xRTML.Console.debug("Street View Changed");var data=JSON.stringify({Visible:e.Visible,Lat:e.Lat,Lng:e.Lng,Heading:e.Heading,Pitch:e.Pitch,Zoom:e.Zoom});for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,"StreetViewChanged",data,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}});this.mapIntance.addEventListener("streetViewClose",function(e){xRTML.Console.debug("Street View Changed");var data=JSON.stringify({Visible:e.Visible});for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,"StreetViewClose",data,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}});if(this.role!=this.roles.sender){this.AddLocation=function(message){this.mapIntance.AddLocation(message.data)};this.GetDirections=function(){this.mapIntance.GetDirections(GetDirections)};this.ChangeViewMode=function(message){this.mapIntance.ChangeViewMode(message.data)};this.ChangeMarket=function(message){this.mapIntance.ChangeMarket(message.data)};this.ClearMap=function(message){this.mapIntance.ClearMap(message.data)};this.ZoomChanged=function(message){this.mapIntance.ZoomChanged(message.data)};this.BoundsChanged=function(message){this.mapIntance.BoundsChanged(message.data)};this.MapTypeIdChanged=function(message){this.mapIntance.MapTypeIdChanged(message.data)};this.StreetViewChanged=function(message){this.mapIntance.StreetViewChanged(message.data)};this.StreetViewClose=function(message){this.mapIntance.StreetViewClose(message.data)}}};xRTML.Tags.Map.prototype.setProperties=function(object){this.mapIntance.setProperties(object)};xRTML.Tags.Map.prototype.clearShapes=function(){var options={zoom:parseInt(this.zoom),latitude:parseFloat(this.latitude),longitude:parseFloat(this.longitude),drawingMode:this.drawingMode,role:this.role,markerType:this.markerType,imageURL:this.imageURL,imageWidth:this.imageWidth,imageHeight:this.imageHeight,polylineElements:this.polylineElements,colorMarker:this.colorMarker,colorRoute:this.colorRoute};this.mapIntance.clearShapes(this.target,options)};xRTML.Tags.Map.Polyline=function(polylineElement,parent){this.offsetLat=polylineElement.offsetlat;this.offsetLng=polylineElement.offsetlng};xRTML.Tags.Map.Polyline.prototype={constructor:xRTML.Tags.Map.Polyline};function MapInfo(latitude,longitude){this.latitude=latitude;this.longitude=longitude}MapInfo.prototype={constructor:MapInfo};function GoogleMap(target,options){new Events.Provider(this);this.target=target;this.targetDirections=options.targetDirections;this.zoom=options.zoom;this.latitude=options.latitude;this.longitude=options.longitude;this.markers=new Array();this.myMarkersObj=new Array();this.viewModes={HYBRID:"HYBRID",ROADMAP:"ROADMAP",SATELLITE:"SATELLITE",TERRAIN:"TERRAIN"};this.viewMode=null;switch(options.viewMode){case this.viewModes.HYBRID:this.viewMode=google.maps.MapTypeId.HYBRID;break;case this.viewModes.ROADMAP:this.viewMode=google.maps.MapTypeId.ROADMAP;break;case this.viewModes.SATELLITE:this.viewMode=google.maps.MapTypeId.SATELLITE;break;case this.viewModes.TERRAIN:this.viewMode=google.maps.MapTypeId.TERRAIN;break;default:this.viewMode=google.maps.MapTypeId.ROADMAP;break}this.routeModes={DRIVING:"DRIVING",WALKING:"WALKING"};this.routeMode=null;switch(options.routeMode){case this.routeModes.DRIVING:this.routeMode=google.maps.DirectionsTravelMode.DRIVING;break;case this.routeModes.WALKING:this.routeMode=google.maps.DirectionsTravelMode.WALKING;break;default:this.routeMode=google.maps.DirectionsTravelMode.DRIVING;break}this.role=options.role;if(this.role=="receiver"){var disableDefaultUI=true}else{var disableDefaultUI=false}var googleMapsOptions={zoom:parseInt(this.zoom),latitude:parseFloat(this.latitude),longitude:parseFloat(this.longitude),center:new google.maps.LatLng(parseFloat(this.latitude),parseFloat(this.longitude)),mapTypeId:this.viewMode,disableDefaultUI:disableDefaultUI,draggable:true};this.map=new google.maps.Map(document.getElementById(this.target),googleMapsOptions);this.panorama=this.map.getStreetView();if(this.role=="receiver"){this.panorama.setOptions({enableCloseButton:false,linksControl:false,panControl:false,zoomControl:false,disableDoubleClickZoom:true})}this.markerTypes={image:"image",polyline:"polyline",polygon:"polygon"};this.markerType=options.markerType;this.polylineElements=options.polylineElements;this.imageURL=options.imageURL;this.imageWidth=options.imageWidth;this.imageHeight=options.imageHeight;this.offsetImageWidth=options.offsetImageWidth;this.offsetImageHeight=options.offsetImageHeight;this.offsetShadowImageWidth=options.offsetShadowImageWidth;this.offsetShadowImageHeight=options.offsetShadowImageHeight;this.shadowImage=options.shadowImage;this.drawingModeTypes={route:"route",polyline:"polyline",points:"points"};this.drawingMode=null;switch(options.drawingMode){case this.drawingModeTypes.route:xRTML.Console.debug("Set drawingMode = "+options.drawingMode);this.drawingMode=new GoogleMap.DrawingRoute();break;case this.drawingModeTypes.polyline:xRTML.Console.debug("Set drawingMode = "+options.drawingMode);this.drawingMode=new GoogleMap.DrawingPolyline();break;case this.drawingModeTypes.points:xRTML.Console.debug("Set drawingMode = "+options.drawingMode);this.drawingMode=null;break;default:xRTML.Console.debug("drawingMode is not defined.");this.drawingMode=null;break}this.colorMarker=options.colorMarker;this.colorRoute=options.colorRoute;this.infoWindow=options.infoWindow;var self=this;this.onclickMap=function(event){switch(self.markerType){case self.markerTypes.polyline:var points=[];for(var i in self.polylineElements){points.push(new MapInfo(event.latLng.lat()+parseFloat(self.polylineElements[i].offsetLat),event.latLng.lng()+parseFloat(self.polylineElements[i].offsetLng)))}var marker=new GoogleMap.DrawingPolyline().draw({map:self.map,points:points,color:self.colorMarker});break;case self.markerTypes.polygon:var points=[];for(var i in self.polylineElements){points.push(new MapInfo(event.latLng.lat()+parseFloat(self.polylineElements[i].offsetLat),event.latLng.lng()+parseFloat(self.polylineElements[i].offsetLng)))}points.push(new MapInfo(event.latLng.lat()+parseFloat(self.polylineElements[0].offsetLat),event.latLng.lng()+parseFloat(self.polylineElements[0].offsetLng)));var marker=new GoogleMap.DrawingPolygon().draw({map:self.map,points:points,color:self.colorMarker});break;default:var image=null;if(self.imageURL){image=new google.maps.MarkerImage(self.imageURL,null,null,new google.maps.Point(self.offsetImageWidth,self.offsetImageHeight),new google.maps.Size(self.imageWidth,self.imageHeight))}var marker=new google.maps.Marker({position:event.latLng,map:self.map,icon:image,draggable:true,id:self.markers.length});if(self.shadowImage){var imageShadow=new google.maps.MarkerImage(self.shadowImage,null,null,new google.maps.Point(self.offsetShadowImageWidth,self.offsetShadowImageHeight),null);marker.setShadow(imageShadow)}if(self.infoWindow){google.maps.event.addListener(marker,"click",function(){var infoWindow=new google.maps.InfoWindow();var content='<div id="info">'+self.infoWindow+"</div>";infoWindow.setContent(content);infoWindow.open(self.map,marker)});google.maps.event.trigger(marker,"click")}google.maps.event.addListener(marker,"dragend",function(eventDragend){onDragendMap(marker)});break}self.markers[self.markers.length]=new MapInfo(event.latLng.lat(),event.latLng.lng());var directionsDisplay=null;var _colorRoute={strokeColor:self.colorRoute.strokeColor,strokeOpacity:self.colorRoute.strokeOpacity,strokeWeight:self.colorRoute.strokeWeight};self.myMarkersObj.push({latLng:new MapInfo(event.latLng.lat(),event.latLng.lng()),directionsDisplay:directionsDisplay,drawingMode:(self.drawingMode)?self.drawingMode.type:null,routeMode:self.routeMode,colorRoute:_colorRoute,marker:marker});if(self.markers.length>1){var pointsToDraw=[self.markers[self.markers.length-2],self.markers[self.markers.length-1]];if(self.drawingMode){self.myMarkersObj[self.myMarkersObj.length-2].drawingMode=self.myMarkersObj[self.myMarkersObj.length-1].drawingMode;self.myMarkersObj[self.myMarkersObj.length-2].routeMode=self.myMarkersObj[self.myMarkersObj.length-1].routeMode;directionsDisplay=self.drawingMode.draw({map:self.map,points:pointsToDraw,color:self.colorRoute,routeMode:self.routeMode});self.myMarkersObj[self.myMarkersObj.length-1].directionsDisplay=directionsDisplay}else{self.myMarkersObj[self.myMarkersObj.length-2].drawingMode=null}if(self.drawingMode&&self.drawingMode.type=="route"){self.drawingMode.calcRoute({map:self.map,markers:self.myMarkersObj,targetDirections:self.targetDirections})}}else{self.myMarkersObj[0].drawingMode=null;var pointsToDraw=self.markers}var message={ViewMode:self.viewMode,Points:pointsToDraw,Markers:self.markers,Mode:(self.drawingMode)?self.drawingMode.type:null,RouteMode:self.routeMode,MarkerType:self.markerType,ImageURL:self.imageURL,ImageHeight:self.imageHeight,ImageWidth:self.imageWidth,PolylineElements:self.polylineElements,ColorMarker:self.colorMarker,ColorRoute:self.colorRoute,InfoWindow:self.infoWindow,OffsetImageWidth:self.offsetImageWidth,OffsetImageHeight:self.offsetImageHeight,ShadowImage:self.shadowImage,OffsetShadowImageWidth:self.offsetShadowImageWidth,OffsetShadowImageHeight:self.offsetShadowImageHeight};self.dispatchEvent("newLocation",message)};function onDragendMap(marker){for(var i in self.myMarkersObj){if(self.myMarkersObj[i].directionsDisplay){self.myMarkersObj[i].directionsDisplay.setMap(null)}}changeMarkets(marker)}function changeMarkets(marker){self.myMarkersObj[marker.get("id")].latLng=new MapInfo(marker.position.lat(),marker.position.lng());self.markers=new Array();for(var i in self.myMarkersObj){self.markers.push(new MapInfo(self.myMarkersObj[i].latLng.latitude,self.myMarkersObj[i].latLng.longitude));var directionsDisplay=null;if(self.markers.length>1&&self.myMarkersObj[i-1].drawingMode){var pointsToDraw=[new MapInfo(self.myMarkersObj[i-1].latLng.latitude,self.myMarkersObj[i-1].latLng.longitude),new MapInfo(self.myMarkersObj[i].latLng.latitude,self.myMarkersObj[i].latLng.longitude)];var drawingNewLocation=null;switch(self.myMarkersObj[i-1].drawingMode){case self.drawingModeTypes.route:drawingNewLocation=new GoogleMap.DrawingRoute();break;case self.drawingModeTypes.polyline:drawingNewLocation=new GoogleMap.DrawingPolyline();break}if(drawingNewLocation){directionsDisplay=drawingNewLocation.draw({map:self.map,points:pointsToDraw,color:self.myMarkersObj[i].colorRoute,routeMode:self.myMarkersObj[i].routeMode})}}self.myMarkersObj[i].directionsDisplay=directionsDisplay}if(self.myMarkersObj.length>1){new GoogleMap.DrawingRoute().calcRoute({map:self.map,markers:self.myMarkersObj,targetDirections:self.targetDirections})}var message={MarkerId:marker.get("id"),MarkerLat:marker.position.lat(),MarkerLng:marker.position.lng()};self.dispatchEvent("changeMarkets",message)}function zoomChanged(){self.zoom=self.map.getZoom();var message={Zoom:self.zoom};self.dispatchEvent("zoomChanged",message)}function boundsChanged(){var bounds=self.map.getBounds();var message={SwLat:bounds.getSouthWest().lat(),SwLng:bounds.getSouthWest().lng(),NeLat:bounds.getNorthEast().lat(),NeLng:bounds.getNorthEast().lng()};self.dispatchEvent("boundsChanged",message)}function mapTypeIdChanged(){var message={MapTypeId:self.map.mapTypeId};self.dispatchEvent("mapTypeIdChanged",message)}if(this.role!="receiver"){google.maps.event.addListener(this.map,"click",this.onclickMap);google.maps.event.addListener(this.map,"zoom_changed",zoomChanged);google.maps.event.addListener(this.map,"bounds_changed",boundsChanged);google.maps.event.addListener(this.map,"maptypeid_changed",mapTypeIdChanged);google.maps.event.addListener(this.panorama,"closeclick",function(e){var message={Visible:self.panorama.visible};self.dispatchEvent("streetViewClose",message)});google.maps.event.addListener(this.panorama,"position_changed",function(e){var message={Visible:!self.panorama.visible,Lat:self.panorama.getPosition().lat(),Lng:self.panorama.getPosition().lng(),Heading:self.panorama.getPov().heading,Pitch:self.panorama.getPov().pitch,Zoom:self.panorama.getPov().zoom};self.dispatchEvent("streetViewChanged",message)});google.maps.event.addListener(this.panorama,"pov_changed",function(e){var message={Visible:!self.panorama.visible,Lat:self.panorama.getPosition().lat(),Lng:self.panorama.getPosition().lng(),Heading:self.panorama.getPov().heading,Pitch:self.panorama.getPov().pitch,Zoom:self.panorama.getPov().zoom};self.dispatchEvent("streetViewChanged",message)})}}GoogleMap.prototype={constructor:GoogleMap};GoogleMap.prototype.AddLocation=function(options){var self=this;self.map.setMapTypeId(options.ViewMode);switch(options.MarkerType){case self.markerTypes.polyline:var points=[];for(var i in options.PolylineElements){points.push(new MapInfo(options.Points[options.Points.length-1].latitude+parseFloat(options.PolylineElements[i].offsetLat),options.Points[options.Points.length-1].longitude+parseFloat(options.PolylineElements[i].offsetLng)))}var marker=new GoogleMap.DrawingPolyline().draw({map:self.map,points:points,color:options.ColorMarker});break;case self.markerTypes.polygon:var points=[];for(var i in options.PolylineElements){points.push(new MapInfo(options.Points[options.Points.length-1].latitude+parseFloat(options.PolylineElements[i].offsetLat),options.Points[options.Points.length-1].longitude+parseFloat(options.PolylineElements[i].offsetLng)))}points.push(new MapInfo(options.Points[options.Points.length-1].latitude+parseFloat(options.PolylineElements[0].offsetLat),options.Points[options.Points.length-1].longitude+parseFloat(options.PolylineElements[0].offsetLng)));var marker=new GoogleMap.DrawingPolygon().draw({map:self.map,points:points,color:options.ColorMarker});break;default:var image=null;if(options.ImageURL){image=new google.maps.MarkerImage(options.ImageURL,null,null,new google.maps.Point(options.OffsetImageWidth,options.OffsetImageHeight),new google.maps.Size(options.ImageWidth,options.ImageHeight))}var marker=new google.maps.Marker({position:new google.maps.LatLng(options.Points[options.Points.length-1].latitude,options.Points[options.Points.length-1].longitude),map:self.map,animation:google.maps.Animation.DROP,icon:image});if(options.ShadowImage){var imageShadow=new google.maps.MarkerImage(options.ShadowImage,null,null,new google.maps.Point(options.OffsetShadowImageWidth,options.OffsetShadowImageHeight),null);marker.setShadow(imageShadow)}if(options.InfoWindow){google.maps.event.addListener(marker,"click",function(){var infoWindow=new google.maps.InfoWindow();var content='<div id="info">'+options.InfoWindow+"</div>";infoWindow.setContent(content);infoWindow.open(self.map,marker)});google.maps.event.trigger(marker,"click")}break}if(this.role=="both"){this.markers[this.markers.length]=new MapInfo(options.Points[options.Points.length-1].latitude,options.Points[options.Points.length-1].longitude)}if(this.role=="receiver"){this.myMarkersObj.push({latLng:new MapInfo(options.Points[options.Points.length-1].latitude,options.Points[options.Points.length-1].longitude),directionsDisplay:directionsDisplay,drawingMode:options.Mode,routeMode:options.RouteMode,colorRoute:options.ColorRoute,marker:marker})}var directionsDisplay=null;var drawingNewLocation=null;if(options.Points.length>1){if(options.Mode){this.myMarkersObj[this.myMarkersObj.length-2].drawingMode=this.myMarkersObj[this.myMarkersObj.length-1].drawingMode;this.myMarkersObj[this.myMarkersObj.length-2].routeMode=this.myMarkersObj[this.myMarkersObj.length-1].routeMode;switch(options.Mode){case this.drawingModeTypes.route:drawingNewLocation=new GoogleMap.DrawingRoute();break;case this.drawingModeTypes.polyline:drawingNewLocation=new GoogleMap.DrawingPolyline();break}directionsDisplay=drawingNewLocation.draw({map:this.map,points:options.Points,color:options.ColorRoute,routeMode:options.RouteMode});this.myMarkersObj[this.myMarkersObj.length-1].directionsDisplay=directionsDisplay}else{this.myMarkersObj[this.myMarkersObj.length-2].drawingMode=null}if(options.Mode&&options.Mode=="route"){drawingNewLocation.calcRoute({map:this.map,markers:this.myMarkersObj,targetDirections:this.targetDirections})}}else{this.myMarkersObj[0].drawingMode=null}};GoogleMap.prototype.ChangeViewMode=function(options){this.viewMode=options.ViewMode;this.map.setMapTypeId(this.viewMode)};GoogleMap.prototype.ChangeMarket=function(options){for(var i in this.myMarkersObj){if(this.myMarkersObj[i].directionsDisplay){this.myMarkersObj[i].directionsDisplay.setMap(null)}}this.myMarkersObj[options.MarkerId].latLng=new MapInfo(options.MarkerLat,options.MarkerLng);this.myMarkersObj[options.MarkerId].marker.setPosition(new google.maps.LatLng(options.MarkerLat,options.MarkerLng));for(var i in this.myMarkersObj){var directionsDisplay=null;if(i>0&&this.myMarkersObj[i-1].drawingMode){var pointsToDraw=[new MapInfo(this.myMarkersObj[i-1].latLng.latitude,this.myMarkersObj[i-1].latLng.longitude),new MapInfo(this.myMarkersObj[i].latLng.latitude,this.myMarkersObj[i].latLng.longitude)];var drawingNewLocation=null;switch(this.myMarkersObj[i-1].drawingMode){case this.drawingModeTypes.route:drawingNewLocation=new GoogleMap.DrawingRoute();break;case this.drawingModeTypes.polyline:drawingNewLocation=new GoogleMap.DrawingPolyline();break}if(drawingNewLocation){directionsDisplay=drawingNewLocation.draw({map:this.map,points:pointsToDraw,color:this.myMarkersObj[i].colorRoute,routeMode:this.myMarkersObj[i].routeMode})}}this.myMarkersObj[i].directionsDisplay=directionsDisplay}if(this.myMarkersObj.length>1){new GoogleMap.DrawingRoute().calcRoute({map:this.map,markers:this.myMarkersObj,targetDirections:this.targetDirections})}};GoogleMap.prototype.ClearMap=function(options){this.markers=[];var googleMapsOptions={zoom:parseInt(this.zoom),latitude:parseFloat(this.latitude),longitude:parseFloat(this.longitude),center:new google.maps.LatLng(parseFloat(this.latitude),parseFloat(this.longitude)),mapTypeId:this.viewMode,draggable:false};this.map=new google.maps.Map(document.getElementById(this.target),googleMapsOptions);if(this.role!="receiver"){google.maps.event.addListener(this.map,"click",this.onclickMap)}};GoogleMap.prototype.ZoomChanged=function(options){this.zoom=options.Zoom;this.map.setZoom(parseInt(this.zoom))};GoogleMap.prototype.BoundsChanged=function(options){var sw=new google.maps.LatLng(options.SwLat,options.SwLng);var ne=new google.maps.LatLng(options.NeLat,options.NeLng);var bounds=new google.maps.LatLngBounds(sw,ne);this.map.fitBounds(bounds);this.map.setZoom(parseInt(this.zoom))};GoogleMap.prototype.MapTypeIdChanged=function(options){this.viewMode=options.MapTypeId;this.map.setMapTypeId(this.viewMode)};GoogleMap.prototype.StreetViewChanged=function(options){var panorama=this.map.getStreetView();panorama.setPosition(new google.maps.LatLng(options.Lat,options.Lng));panorama.setPov({heading:options.Heading,pitch:options.Pitch,zoom:options.Zoom});panorama.setVisible(options.Visible)};GoogleMap.prototype.StreetViewClose=function(options){var panorama=this.map.getStreetView();panorama.setVisible(options.Visible)};GoogleMap.prototype.setProperties=function(object){for(var i in object){switch(object[i].name){case"viewMode":switch(object[i].value){case this.viewModes.HYBRID:this.viewMode=google.maps.MapTypeId.HYBRID;break;case this.viewModes.ROADMAP:this.viewMode=google.maps.MapTypeId.ROADMAP;break;case this.viewModes.SATELLITE:this.viewMode=google.maps.MapTypeId.SATELLITE;break;case this.viewModes.TERRAIN:this.viewMode=google.maps.MapTypeId.TERRAIN;break;default:this.viewMode=google.maps.MapTypeId.ROADMAP;break}this.map.setMapTypeId(this.viewMode);break;case"drawingMode":if(object[i].value=="route"){this.drawingMode=new GoogleMap.DrawingRoute()}else{if(object[i].value=="polyline"){this.drawingMode=new GoogleMap.DrawingPolyline()}else{this.drawingMode=null}}break;case"colorMarker":this.colorMarker.strokeColor=object[i].value.strokeColor;this.colorMarker.strokeOpacity=object[i].value.strokeOpacity;this.colorMarker.strokeWeight=object[i].value.strokeWeight;this.colorMarker.fillColor=object[i].value.fillColor;this.colorMarker.fillOpacity=object[i].value.fillOpacity;break;case"colorRoute":this.colorRoute.strokeColor=object[i].value.strokeColor||"#000000";this.colorRoute.strokeOpacity=object[i].value.strokeOpacity||1;this.colorRoute.strokeWeight=object[i].value.strokeWeight||1;break;case"routeMode":if(object[i].value=="WALKING"){this.routeMode=google.maps.DirectionsTravelMode.WALKING}else{this.routeMode=google.maps.DirectionsTravelMode.DRIVING}break;default:this[object[i].name]=object[i].value;break}}var message={ViewMode:this.viewMode};this.dispatchEvent("changeViewMode",message)};GoogleMap.prototype.clearShapes=function(target,options){this.markers=[];this.myMarkersObj=[];var googleMapsOptions={zoom:parseInt(options.zoom),latitude:parseFloat(options.latitude),longitude:parseFloat(options.longitude),center:new google.maps.LatLng(parseFloat(options.latitude),parseFloat(options.longitude)),mapTypeId:this.viewMode,draggable:false};this.map=new google.maps.Map(document.getElementById(target),googleMapsOptions);if(this.role!="receiver"){google.maps.event.addListener(this.map,"click",this.onclickMap)}this.dispatchEvent("clearShapes",null)};GoogleMap.DrawingPolyline=function(){};GoogleMap.DrawingPolyline.prototype={constructor:GoogleMap.DrawingPolyline};GoogleMap.DrawingPolyline.prototype.type="polyline";GoogleMap.DrawingPolyline.prototype.draw=function(options){if(!options.color.strokeWeight){return}var route=[];for(var i in options.points){route.push(new google.maps.LatLng(options.points[i].latitude,options.points[i].longitude))}var polyline=new google.maps.Polyline({path:route,map:options.map,strokeColor:options.color.strokeColor,strokeOpacity:options.color.strokeOpacity,strokeWeight:options.color.strokeWeight});return polyline};GoogleMap.DrawingPolyline.prototype.calcRoute=function(options){var waypts2=[];if(options.markers.length>2){for(var i=1;i<options.markers.length-1;++i){waypts2.push({location:new google.maps.LatLng(options.markers[i].latitude,options.markers[i].longitude),stopover:true})}}var polylineOptionsPlan2={strokeColor:"#FFFFFF",strokeOpacity:0,strokeWeight:0};var rendererOptions2={draggable:false,preserveViewport:true,polylineOptions:polylineOptionsPlan2,markerOptions:{visible:false}};var request2={origin:new google.maps.LatLng(options.markers[0].latitude,options.markers[0].longitude),destination:new google.maps.LatLng(options.markers[options.markers.length-1].latitude,options.markers[options.markers.length-1].longitude),waypoints:waypts2,optimizeWaypoints:true,travelMode:options.routeMode,unitSystem:google.maps.DirectionsUnitSystem.METRIC};var directionsService2=new google.maps.DirectionsService();var directionsDisplay2=new google.maps.DirectionsRenderer(rendererOptions2);directionsDisplay2.setMap(options.map);if(options.targetDirections){document.getElementById(options.targetDirections).innerHTML="";directionsDisplay2.setPanel(document.getElementById(options.targetDirections))}directionsService2.route(request2,function(response2,status){if(status==google.maps.DirectionsStatus.OK){directionsDisplay2.setDirections(response2)}})};GoogleMap.DrawingPolygon=function(){};GoogleMap.DrawingPolygon.prototype={constructor:GoogleMap.DrawingPolygon};GoogleMap.DrawingPolygon.prototype.type="polygon";GoogleMap.DrawingPolygon.prototype.draw=function(options){var route=[];for(var i in options.points){route.push(new google.maps.LatLng(options.points[i].latitude,options.points[i].longitude))}var polyline=new google.maps.Polygon({path:route,strokeColor:options.color.strokeColor,strokeOpacity:options.color.strokeOpacity,strokeWeight:options.color.strokeWeight,fillColor:options.color.fillColor,fillOpacity:options.color.fillOpacity});polyline.setMap(options.map);return polyline};GoogleMap.DrawingRoute=function(){};GoogleMap.DrawingRoute.prototype={constructor:GoogleMap.DrawingRoute};GoogleMap.DrawingRoute.prototype.type="route";GoogleMap.DrawingRoute.prototype.draw=function(options){var waypts=[];if(options.points.length>2){for(var i in options.points){waypts.push({location:new google.maps.LatLng(options.points[i].latitude,options.points[i].longitude),stopover:true})}}var request={origin:new google.maps.LatLng(options.points[options.points.length-2].latitude,options.points[options.points.length-2].longitude),destination:new google.maps.LatLng(options.points[options.points.length-1].latitude,options.points[options.points.length-1].longitude),waypoints:waypts,optimizeWaypoints:true,travelMode:options.routeMode,unitSystem:google.maps.DirectionsUnitSystem.METRIC};var polylineOptionsPlan={strokeColor:options.color.strokeColor,strokeOpacity:options.color.strokeOpacity,strokeWeight:options.color.strokeWeight};var rendererOptions={draggable:false,preserveViewport:true,polylineOptions:polylineOptionsPlan,markerOptions:{visible:false}};var directionsService=new google.maps.DirectionsService();var directionsDisplay=new google.maps.DirectionsRenderer(rendererOptions);directionsDisplay.setMap(options.map);directionsService.route(request,function(response,status){if(status==google.maps.DirectionsStatus.OK){directionsDisplay.setDirections(response)}});return directionsDisplay};GoogleMap.DrawingRoute.prototype.calcRoute=function(options){if(options.targetDirections){document.getElementById(options.targetDirections).innerHTML=""}for(var i=0;i<options.markers.length-1;){var route=[];if(options.markers[i].routeMode=="WALKING"){while(i<options.markers.length&&options.markers[i].drawingMode&&options.markers[i].drawingMode=="route"&&options.markers[i].routeMode=="WALKING"){route.push(options.markers[i].latLng);++i}}else{while(i<options.markers.length&&options.markers[i].drawingMode&&options.markers[i].drawingMode=="route"&&options.markers[i].routeMode=="DRIVING"){route.push(options.markers[i].latLng);++i}}if(route.length>0){if(i<options.markers.length-1){route.push(options.markers[i].latLng)}var waypts=[];if(route.length>2){for(var j=1;j<route.length-1;++j){waypts.push({location:new google.maps.LatLng(route[j].latitude,route[j].longitude),stopover:true})}}var polylineOptionsPlan={strokeColor:"#FFFFFF",strokeOpacity:0,strokeWeight:0};var rendererOptions={draggable:false,preserveViewport:true,polylineOptions:polylineOptionsPlan,markerOptions:{visible:false}};var request={origin:new google.maps.LatLng(route[0].latitude,route[0].longitude),destination:new google.maps.LatLng(route[route.length-1].latitude,route[route.length-1].longitude),waypoints:waypts,travelMode:options.markers[i-1].routeMode,unitSystem:google.maps.DirectionsUnitSystem.METRIC};var directionsService=new google.maps.DirectionsService();var directionsDisplay=new google.maps.DirectionsRenderer(rendererOptions);directionsDisplay.setMap(options.map);if(options.targetDirections){var divParent=document.getElementById(options.targetDirections);var divSteps=document.createElement("div");directionsDisplay.setPanel(divSteps);divParent.appendChild(divSteps)}showSteps(directionsService,request,directionsDisplay,i)}else{++i}}};function showSteps(directionsService,request,directionsDisplay){directionsService.route(request,function(response,status){if(status==google.maps.DirectionsStatus.OK){directionsDisplay.setDirections(response)}})}function BingMap(target,options){new Events.Provider(this);this.target=target;this.zoom=options.zoom;this.latitude=options.latitude;this.longitude=options.longitude;this.markers=new Array();this.myMarkersObj=new Array();this.viewModes={birdseye:"birdseye",aerial:"aerial",road:"road"};this.viewMode=null;switch(options.viewMode){case this.viewModes.birdseye:this.viewMode=Microsoft.Maps.MapTypeId.birdseye;break;case this.viewModes.aerial:this.viewMode=Microsoft.Maps.MapTypeId.aerial;break;case this.viewModes.road:this.viewMode=Microsoft.Maps.MapTypeId.road;break;default:this.viewMode=Microsoft.Maps.MapTypeId.road;break}this.role=options.role;if(this.role=="receiver"){var showDashboard=false;var showMapTypeSelector=false;var showScalebar=false}this.map=new Microsoft.Maps.Map(document.getElementById(this.target),{credentials:"ArGt4Koxb0aFG2OPawsKOeq3YTKtAKhCgLsp4LIVu5cLymSzGo8RWwhLATArfj9m",showDashboard:showDashboard,showMapTypeSelector:showMapTypeSelector,showScalebar:showScalebar});this.map.setView({zoom:this.zoom,center:new Microsoft.Maps.Location(parseFloat(this.latitude),parseFloat(this.longitude))});this.map.setView({mapTypeId:this.viewMode});this.markerTypes={image:"image",polyline:"polyline",polygon:"polygon"};this.markerType=options.markerType;this.polylineElements=options.polylineElements;this.imageURL=options.imageURL;this.imageWidth=options.imageWidth;this.imageHeight=options.imageHeight;this.offsetImageWidth=options.offsetImageWidth;this.offsetImageHeight=options.offsetImageHeight;this.drawingModeTypes={route:"route",polyline:"polyline"};this.drawingMode=null;switch(options.drawingMode){case this.drawingModeTypes.route:xRTML.Console.debug("Set drawingMode = "+options.drawingMode);this.drawingMode=new BingMap.DrawingRoute();break;case this.drawingModeTypes.polyline:xRTML.Console.debug("Set drawingMode = "+options.drawingMode);this.drawingMode=new BingMap.DrawingPolyline();break;case this.drawingModeTypes.points:xRTML.Console.debug("Set drawingMode = "+options.drawingMode);this.drawingMode=null;break;default:xRTML.Console.debug("drawingMode is not define - Default drawingMode = route");this.drawingMode=null;break}this.routeModes={DRIVING:"DRIVING",WALKING:"WALKING"};this.routeMode=options.routeMode;this.colorMarker=options.colorMarker;this.colorRoute=options.colorRoute;this.infoWindow=options.infoWindow;var self=this;function map_OnMouseDown(e){mouseDownLocation=new Microsoft.Maps.Point(e.pageX,e.pageY)}function map_OnMouseUp(e){var pixel=new Microsoft.Maps.Point(e.pageX,e.pageY);if(mouseDownLocation!=null&&mouseDownLocation.x==pixel.x&&mouseDownLocation.y==pixel.y){onclickMap(e)}}function onclickMap(event){if(event.targetType!="map"){return}var point=new Microsoft.Maps.Point(event.getX(),event.getY());var latLon=event.target.tryPixelToLocation(point);var lat=latLon.latitude;var lng=latLon.longitude;switch(self.markerType){case self.markerTypes.polyline:var points=[];for(var i in self.polylineElements){points.push(new MapInfo(lat+parseFloat(self.polylineElements[i].offsetLat),lng+parseFloat(self.polylineElements[i].offsetLng)))}new BingMap.DrawingPolyline().draw({map:self.map,points:points,color:self.colorMarker});break;case self.markerTypes.polygon:var points=[];for(var i in self.polylineElements){points.push(new MapInfo(lat+parseFloat(self.polylineElements[i].offsetLat),lng+parseFloat(self.polylineElements[i].offsetLng)))}points.push(new MapInfo(lat+parseFloat(self.polylineElements[0].offsetLat),lng+parseFloat(self.polylineElements[0].offsetLng)));new BingMap.DrawingPolygon().draw({map:self.map,points:points,color:self.colorMarker});break;default:var defaultInfobox=null;if(self.infoWindow){var infoboxOptions={showCloseButton:true,offset:new Microsoft.Maps.Point(0,15),visible:false};var defaultInfobox=new Microsoft.Maps.Infobox(new Microsoft.Maps.Location(lat,lng),infoboxOptions);defaultInfobox.setHtmlContent("<div style='border: solid 2px black; background-color: White; padding: 5px;'>"+self.infoWindow+"</div>");self.map.entities.push(defaultInfobox)}var markerNum=self.markers.length.toString();var offsetImageWidth=self.offsetImageWidth||"0";var offsetImageHeight=self.offsetImageHeight||"0";var pushpinOptions={icon:self.imageURL,width:self.imageWidth,height:self.imageHeight,anchor:new Microsoft.Maps.Point(offsetImageWidth,offsetImageHeight),draggable:true,visible:true,zIndex:5,text:markerNum};var pushpin=new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(lat,lng),pushpinOptions);Microsoft.Maps.Events.addHandler(pushpin,"mouseover",function(){if(infoboxOptions){defaultInfobox.setOptions({visible:true})}});Microsoft.Maps.Events.addHandler(pushpin,"mouseout",function(){if(infoboxOptions){defaultInfobox.setOptions({visible:false})}});Microsoft.Maps.Events.addHandler(pushpin,"dragend",function(){onDragendMap(pushpin)});self.map.entities.push(pushpin);break}self.markers[self.markers.length]=new MapInfo(lat,lng);var pointsToDraw=[];var directionsDisplay=null;var _colorRoute={strokeColor:self.colorRoute.strokeColor,strokeOpacity:self.colorRoute.strokeOpacity,strokeWeight:self.colorRoute.strokeWeight};self.myMarkersObj.push({latLng:new MapInfo(lat,lng),drawingMode:(self.drawingMode)?self.drawingMode.type:null,routeMode:self.routeMode,colorRoute:_colorRoute,marker:pushpin});if(self.markers.length>1){pointsToDraw=[self.markers[self.markers.length-2],self.markers[self.markers.length-1]];if(self.drawingMode){self.myMarkersObj[self.myMarkersObj.length-2].drawingMode=self.myMarkersObj[self.myMarkersObj.length-1].drawingMode;self.myMarkersObj[self.myMarkersObj.length-2].routeMode=self.myMarkersObj[self.myMarkersObj.length-1].routeMode;self.drawingMode.draw({map:self.map,points:pointsToDraw,color:self.colorRoute,routeMode:self.routeMode})}else{self.myMarkersObj[self.myMarkersObj.length-2].drawingMode=null}}else{self.myMarkersObj[0].drawingMode=null;pointsToDraw=self.markers}var message={ViewMode:self.viewMode,Points:pointsToDraw,Mode:(self.drawingMode)?self.drawingMode.type:null,RouteMode:self.routeMode,MarkerType:self.markerType,ImageURL:self.imageURL,ImageHeight:self.imageHeight,ImageWidth:self.imageWidth,PolylineElements:self.polylineElements,ColorMarker:self.colorMarker,ColorRoute:self.colorRoute,InfoWindow:self.infoWindow,OffsetImageWidth:self.offsetImageWidth,OffsetImageHeight:self.offsetImageHeight};self.dispatchEvent("newLocation",message)}function onDragendMap(marker){for(var i=self.map.entities.getLength()-1;i>=0;i--){var polyline=self.map.entities.get(i);if(polyline instanceof Microsoft.Maps.Polyline){self.map.entities.removeAt(i)}}changeMarkets(marker)}function boundsChanged(event){var bounds=self.map.getBounds();var swLat=bounds.getSoutheast().latitude;var swLng=bounds.getSoutheast().longitude;var neLat=bounds.getNorthwest().latitude;var neLng=bounds.getNorthwest().longitude;var message={SwLat:swLat,SwLng:swLng,NeLat:neLat,NeLng:neLng};self.dispatchEvent("boundsChanged",message)}function mapTypeIdChanged(){var message={MapTypeId:self.map.getMapTypeId(),LabelOverlay:self.map.getOptions().labelOverlay};self.dispatchEvent("mapTypeIdChanged",message)}var mouseDownLocation;function changeMarkets(marker){self.myMarkersObj[marker.getText()].latLng=new MapInfo(marker.getLocation().latitude,marker.getLocation().longitude);self.markers=new Array();for(var i in self.myMarkersObj){self.markers.push(new MapInfo(self.myMarkersObj[i].latLng.latitude,self.myMarkersObj[i].latLng.longitude));if(self.markers.length>1&&self.myMarkersObj[i-1].drawingMode){var pointsToDraw=[new MapInfo(self.myMarkersObj[i-1].latLng.latitude,self.myMarkersObj[i-1].latLng.longitude),new MapInfo(self.myMarkersObj[i].latLng.latitude,self.myMarkersObj[i].latLng.longitude)];var drawingNewLocation=null;switch(self.myMarkersObj[i-1].drawingMode){case self.drawingModeTypes.route:drawingNewLocation=new BingMap.DrawingRoute();break;case self.drawingModeTypes.polyline:drawingNewLocation=new BingMap.DrawingPolyline();break}if(drawingNewLocation){drawingNewLocation.draw({map:self.map,points:pointsToDraw,color:self.myMarkersObj[i].colorRoute,routeMode:self.myMarkersObj[i].routeMode})}}}var message={MarkerId:marker.getText(),MarkerLat:marker.getLocation().latitude,MarkerLng:marker.getLocation().longitude};self.dispatchEvent("changeMarkets",message)}if(this.role!="receiver"){Microsoft.Maps.Events.addHandler(this.map,"mousedown",map_OnMouseDown);Microsoft.Maps.Events.addHandler(this.map,"mouseup",map_OnMouseUp);Microsoft.Maps.Events.addHandler(this.map,"viewchangeend",boundsChanged);Microsoft.Maps.Events.addHandler(this.map,"maptypechanged",mapTypeIdChanged)}}BingMap.prototype={constructor:BingMap};BingMap.prototype.AddLocation=function(options){var self=this;var pushpin=null;switch(options.MarkerType){case self.markerTypes.polyline:var points=[];for(var i in options.PolylineElements){points.push(new MapInfo(options.Points[options.Points.length-1].latitude+parseFloat(options.PolylineElements[i].offsetLat),options.Points[options.Points.length-1].longitude+parseFloat(options.PolylineElements[i].offsetLng)))}new BingMap.DrawingPolyline().draw({map:self.map,points:points,color:options.ColorMarker});break;case self.markerTypes.polygon:var points=[];for(var i in options.PolylineElements){points.push(new MapInfo(options.Points[options.Points.length-1].latitude+parseFloat(options.PolylineElements[i].offsetLat),options.Points[options.Points.length-1].longitude+parseFloat(options.PolylineElements[i].offsetLng)))}points.push(new MapInfo(options.Points[options.Points.length-1].latitude+parseFloat(options.PolylineElements[0].offsetLat),options.Points[options.Points.length-1].longitude+parseFloat(options.PolylineElements[0].offsetLng)));new BingMap.DrawingPolygon().draw({map:self.map,points:points,color:options.ColorMarker});break;default:var defaultInfobox=null;var lat=options.Points[options.Points.length-1].latitude;var lng=options.Points[options.Points.length-1].longitude;var defaultInfobox=null;if(options.InfoWindow){var infoboxOptions={showCloseButton:true,offset:new Microsoft.Maps.Point(0,15),visible:false};var defaultInfobox=new Microsoft.Maps.Infobox(new Microsoft.Maps.Location(lat,lng),infoboxOptions);defaultInfobox.setHtmlContent("<div style='border: solid 2px black; background-color: White; padding: 5px;'>"+options.InfoWindow+"</div>");self.map.entities.push(defaultInfobox)}var offsetImageWidth=options.OffsetImageWidth||"0";var offsetImageHeight=options.OffsetImageHeight||"0";var pushpinOptions={icon:options.ImageURL,width:options.ImageWidth,height:options.ImageHeight,anchor:new Microsoft.Maps.Point(offsetImageWidth,offsetImageHeight),visible:true,zIndex:5};pushpin=new Microsoft.Maps.Pushpin(new Microsoft.Maps.Location(lat,lng),pushpinOptions);Microsoft.Maps.Events.addHandler(pushpin,"mouseover",function(){if(infoboxOptions){defaultInfobox.setOptions({visible:true})}});Microsoft.Maps.Events.addHandler(pushpin,"mouseout",function(){if(infoboxOptions){defaultInfobox.setOptions({visible:false})}});self.map.entities.push(pushpin);break}if(this.role=="both"){self.markers[self.markers.length]=new MapInfo(lat,lng)}if(this.role=="receiver"){this.myMarkersObj.push({latLng:new MapInfo(options.Points[options.Points.length-1].latitude,options.Points[options.Points.length-1].longitude),drawingMode:options.Mode,routeMode:options.RouteMode,colorRoute:options.ColorRoute,marker:pushpin})}var drawingNewLocation=null;if(options.Points.length>1){if(options.Mode){self.myMarkersObj[self.myMarkersObj.length-2].drawingMode=self.myMarkersObj[self.myMarkersObj.length-1].drawingMode;self.myMarkersObj[self.myMarkersObj.length-2].routeMode=self.myMarkersObj[self.myMarkersObj.length-1].routeMode;switch(options.Mode){case this.drawingModeTypes.route:drawingNewLocation=new BingMap.DrawingRoute();break;case this.drawingModeTypes.polyline:drawingNewLocation=new BingMap.DrawingPolyline();break}drawingNewLocation.draw({map:this.map,points:options.Points,color:options.ColorRoute,routeMode:options.RouteMode})}else{this.myMarkersObj[this.myMarkersObj.length-2].drawingMode=null}}else{this.myMarkersObj[0].drawingMode=null}};BingMap.prototype.ChangeViewMode=function(options){this.viewMode=options.ViewMode;this.map.setView({mapTypeId:this.viewMode})};BingMap.prototype.ChangeMarket=function(options){for(var i=this.map.entities.getLength()-1;i>=0;i--){var polyline=this.map.entities.get(i);if(polyline instanceof Microsoft.Maps.Polyline){this.map.entities.removeAt(i)}}this.myMarkersObj[options.MarkerId].latLng=new MapInfo(options.MarkerLat,options.MarkerLng);this.myMarkersObj[options.MarkerId].marker.setLocation(new Microsoft.Maps.Location(options.MarkerLat,options.MarkerLng));for(var i in this.myMarkersObj){if(i>0&&this.myMarkersObj[i-1].drawingMode){var pointsToDraw=[new MapInfo(this.myMarkersObj[i-1].latLng.latitude,this.myMarkersObj[i-1].latLng.longitude),new MapInfo(this.myMarkersObj[i].latLng.latitude,this.myMarkersObj[i].latLng.longitude)];var drawingNewLocation=null;switch(this.myMarkersObj[i-1].drawingMode){case this.drawingModeTypes.route:drawingNewLocation=new BingMap.DrawingRoute();break;case this.drawingModeTypes.polyline:drawingNewLocation=new BingMap.DrawingPolyline();break}if(drawingNewLocation){drawingNewLocation.draw({map:this.map,points:pointsToDraw,color:this.myMarkersObj[i].colorRoute,routeMode:this.myMarkersObj[i].routeMode})}}}};BingMap.prototype.ClearMap=function(options){for(var i=this.map.entities.getLength()-1;i>=0;i--){var polyline=this.map.entities.get(i);this.map.entities.removeAt(i)}};BingMap.prototype.GetDirections=function(options){var startpt=new VELatLong(this.markers[this.markers.length-2].Latitude,this.markers[this.markers.length-2].Longitude);var endpt=new VELatLong(this.markers[this.markers.length-1].Latitude,this.markers[this.markers.length-1].Longitude);this.map.GetRoute(startpt,endpt,VEDistanceUnit.Kilometers,VERouteType.Quickest)};BingMap.prototype.BoundsChanged=function(options){var viewRect=Microsoft.Maps.LocationRect.fromCorners(new Microsoft.Maps.Location(options.NeLat,options.NeLng),new Microsoft.Maps.Location(options.SwLat,options.SwLng));this.map.setView({bounds:viewRect,zoom:this.zoom})};BingMap.prototype.MapTypeIdChanged=function(options){this.viewMode=options.MapTypeId;this.map.setView({mapTypeId:this.viewMode});this.map.setOptions({labelOverlay:options.LabelOverlay})};BingMap.prototype.setProperties=function(object){for(var i in object){switch(object[i].name){case"viewMode":switch(object[i].value){case this.viewModes.birdseye:this.viewMode=Microsoft.Maps.MapTypeId.birdseye;break;case this.viewModes.aerial:this.viewMode=Microsoft.Maps.MapTypeId.aerial;break;case this.viewModes.road:this.viewMode=Microsoft.Maps.MapTypeId.road;break;default:this.viewMode=Microsoft.Maps.MapTypeId.road;break}this.map.setView({mapTypeId:this.viewMode});break;case"drawingMode":if(object[i].value=="route"){this.drawingMode=new BingMap.DrawingRoute()}else{if(object[i].value=="polyline"){this.drawingMode=new BingMap.DrawingPolyline()}else{this.drawingMode=null}}break;case"colorMarker":this.colorMarker.strokeColor=object[i].value.strokeColor;this.colorMarker.strokeOpacity=object[i].value.strokeOpacity;this.colorMarker.strokeWeight=object[i].value.strokeWeight;this.colorMarker.fillColor=object[i].value.fillColor;this.colorMarker.fillOpacity=object[i].value.fillOpacity;break;case"colorRoute":this.colorRoute.strokeColor=object[i].value.strokeColor;this.colorRoute.strokeOpacity=object[i].value.strokeOpacity;this.colorRoute.strokeWeight=object[i].value.strokeWeight;break;default:this[object[i].name]=object[i].value;break}}var message={ViewMode:this.viewMode};this.dispatchEvent("changeViewMode",message)};BingMap.prototype.clearShapes=function(target,options){for(var i=this.map.entities.getLength()-1;i>=0;i--){var polyline=this.map.entities.get(i);this.map.entities.removeAt(i)}this.dispatchEvent("clearShapes",options)};BingMap.DrawingPolyline=function(){};BingMap.DrawingPolyline.prototype={constructor:BingMap.DrawingPolyline};BingMap.DrawingPolyline.prototype.type="polyline";BingMap.DrawingPolyline.prototype.draw=function(options){var route=[];route=[new Microsoft.Maps.Location(options.points[options.points.length-2].latitude,options.points[options.points.length-2].longitude),new Microsoft.Maps.Location(options.points[options.points.length-1].latitude,options.points[options.points.length-1].longitude)];if(options.color.strokeColor){var opacity=options.color.strokeOpacity||1;var thickness=parseInt(options.color.strokeWeight)||1;var optionsPolyline={strokeColor:new Microsoft.Maps.Color.fromHex(options.color.strokeColor),strokeThickness:parseInt(thickness)};optionsPolyline.strokeColor.a=opacity*255;var polyline=new Microsoft.Maps.Polyline(route,optionsPolyline)}else{var polyline=new Microsoft.Maps.Polyline(route,null)}options.map.entities.push(polyline);return polyline};BingMap.DrawingPolygon=function(){};BingMap.DrawingPolygon.prototype={constructor:BingMap.DrawingPolygon};BingMap.DrawingPolygon.prototype.type="polyline";BingMap.DrawingPolygon.prototype.draw=function(options){var route=[];for(var i in options.points){route.push(new Microsoft.Maps.Location(options.points[i].latitude,options.points[i].longitude))}var opacityfillOpacity=options.color.fillOpacity||1;var opacity=options.color.strokeOpacity||1;var thickness=parseInt(options.color.strokeWeight)||1;var optionsPolygon={fillColor:new Microsoft.Maps.Color.fromHex(options.color.fillColor),strokeColor:new Microsoft.Maps.Color.fromHex(options.color.strokeColor),strokeThickness:parseInt(thickness)};optionsPolygon.fillColor.a=opacityfillOpacity*255;optionsPolygon.strokeColor.a=opacity*255;var polygon=new Microsoft.Maps.Polygon(route,optionsPolygon);options.map.entities.push(polygon);return polygon};BingMap.DrawingRoute=function(){};BingMap.DrawingRoute.prototype={constructor:BingMap.DrawingRoute};BingMap.DrawingRoute.prototype.type="route";BingMap.DrawingRoute.prototype.routeSteps=new Array();BingMap.DrawingRoute.prototype.directionsUpdated=false;BingMap.DrawingRoute.prototype.draw=function(options){var bingMap=options.map;var self=this;Microsoft.Maps.loadModule("Microsoft.Maps.Directions",{callback:function(){var directionsManager=new Microsoft.Maps.Directions.DirectionsManager(bingMap);var color=options.color;var r=parseInt((color.strokeColor).substring(1,3),16);var g=parseInt((color.strokeColor).substring(3,5),16);var b=parseInt((color.strokeColor).substring(5,7),16);var o=color.strokeOpacity||1;directionsManager.setRenderOptions({displayManeuverIcons:false,itineraryContainer:document.getElementById(options.targetDirections)||null,drivingPolylineOptions:{strokeColor:new Microsoft.Maps.Color(o,r,g,b),strokeThickness:color.strokeWeight},waypointPushpinOptions:{visible:false,icon:"",height:0,width:0,draggable:false,text:"",zIndex:-100},lastWaypointIcon:""});for(var i in options.points){console.log(i+": Lat: "+options.points[i].latitude+"Lng: "+options.points[i].longitude+" "+options.routeMode);directionsManager.addWaypoint(new Microsoft.Maps.Directions.Waypoint({location:new Microsoft.Maps.Location(options.points[i].latitude,options.points[i].longitude)}))}switch(options.routeMode){case"DRIVING":var routeMode=Microsoft.Maps.Directions.RouteMode.driving;break;case"WALKING":var routeMode=Microsoft.Maps.Directions.RouteMode.walking;break;default:var routeMode=Microsoft.Maps.Directions.RouteMode.driving;break}directionsManager.setRequestOptions({routeMode:routeMode,routeDraggable:false});directionsManager.calculateDirections()}})};xRTML.Tags.Cloud=xRTML.Tag.makeSubclass();xRTML.registerTag("Cloud");xRTML.Tags.Cloud.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);this.targetElement="";if(this.target&&this.target.length>0){this.targetElement=this.target[0]}if(tagObject.fontunit){this.fontunit=tagObject.fontunit}else{this.fontunit="px"}if(tagObject.fontsizemin){this.fontsizemin=xRTML.Common.Converter.toNumber(tagObject.fontsizemin)}else{this.fontsizemin=8}if(tagObject.fontsizemax){this.fontsizemax=xRTML.Common.Converter.toNumber(tagObject.fontsizemax)}else{this.fontsizemax=40}if(tagObject.numbertags){this.numbertags=xRTML.Common.Converter.toNumber(tagObject.numbertags)}else{this.numbertags=0}this.orderBy={descendingweight:"DES_WEIGHT",ascendingweight:"ASC_WEIGHT",descendingword:"DES_WORD",ascendingword:"ASC_WORD",random:"RANDOM",none:"NONE"};this.orderingMethods={DES_WEIGHT:function(a,b){return a.w-b.w},ASC_WEIGHT:function(a,b){return b.w-a.w},DES_WORD:function(a,b){return(a.wd==b.wd)?0:((a.wd>b.wd)?-1:1)},ASC_WORD:function(a,b){return(a.wd==b.wd)?0:((a.wd>b.wd)?1:-1)},RANDOM:function(a,b){return(Math.round(Math.random())-0.5)},NONE:""};if(tagObject.orderby){if(this.orderBy[tagObject.orderby]){this.orderCloudTagBy=this.numbertags==0?this.orderBy.none:this.orderBy[tagObject.orderby]}else{xRTML.ErrorHandler().tagError(new Error("Wrong ordering parameter."))}}else{this.orderCloudTagBy=this.orderBy.ascendingWord}var maxArray=function(myArray){var max=myArray[0].w;var len=myArray.length;for(var i=1;i<len;i++){max=myArray[i].w>max?myArray[i].w:max}return max};var minArray=function(myArray){var min=myArray[0].w;var len=myArray.length;for(var i=1;i<len;i++){min=myArray[i].w<min?myArray[i].w:min}return min};var self=this;this.insert=function(message){var cloudDiv=document.createElement("div");cloudDiv.setAttribute("class","cloudtag");var newarray=new Array();var tagslen=message.data.tags.length;newarray=message.data.tags.slice(0,tagslen);if(!this.numbertags==0&&tagslen>this.numbertags){newarray=message.data.tags.slice(0,this.numbertags)}var maxWeight=maxArray(newarray);var minWeight=minArray(newarray);if(!this.numbertags==0){if(this.orderCloudTagBy!=""&&this.orderCloudTagBy!="NONE"){newarray=newarray.sort(this.orderingMethods[this.orderCloudTagBy])}else{if(this.orderCloudTagBy==""){newarray=newarray.sort(this.orderingMethods.ASC_WORD)}}}var q=(maxWeight-minWeight)/(this.fontsizemax-this.fontsizemin);var adjust=minWeight/q+this.fontsizemin-this.fontsizemin;for(var i=0,len=newarray.length;i<len;i++){var child=document.createElement("a");child.href=newarray[i].l;xRTML.Common.DOM.setText(child,newarray[i].wd);var fontsize=newarray[i].w/q+this.fontsizemin-adjust;child.style.fontSize=fontsize+this.fontunit;cloudDiv.innerHTML+=" ";cloudDiv.appendChild(child)}this.targetElement.setAttribute("class","tag");this.targetElement.innerHTML=cloudDiv.innerHTML}};xRTML.Tags.Booking=xRTML.Tag.makeSubclass();xRTML.registerTag("Booking");xRTML.Tags.Booking.prototype.init=function(tagObject){var self=this;xRTML.Tag.prototype.init.call(this,tagObject);xRTML.Common.Validator.validateRequired(tagObject.channelid,true,"A channelid attribute is required for booking tag.");xRTML.Common.Validator.validateRequired(tagObject.bookingitem,true,"A bookingitem attribute is required for booking tag.");this.userId=(tagObject.userid)?tagObject.userid:eval(tagObject.useridcallback+"()");var bookingLimit=parseInt(tagObject.bookinglimit,10);this.bookingItem=tagObject.bookingitem;this.bookingSlots=Sizzle(this.bookingItem);this.handlerUrl=tagObject.handlerurl;this.cssDefault=this.bookingSlots[0].className;this.cssBooked="xrtmlBook_booked";this.cssWaiting="xrtmlBook_waiting";this.cssOwn="xrtmlBook_own";this.onDataPreLoad=function(){var e={target:self};tagObject.ondatapreload?new Function("e","return "+tagObject.ondatapreload+"(e);")(e):null;self.dispatchEvent("onDataPreLoad")};this.onDataLoad=function(data){var e={target:self,data:data};tagObject.ondataload?new Function("e","return "+tagObject.ondataload+"(e);")(e):null;self.dispatchEvent("onDataLoad",e)};this.onBookingSuccess=function(data){var e={target:self,data:data};tagObject.onbookingsuccess?new Function("e","return "+tagObject.onbookingsuccess+"(e);")(e):null;self.dispatchEvent("onBookingSuccess",e)};this.onBookingOverLimit=function(data){var e={target:self,data:data};tagObject.onbookingoverlimit?new Function("e","return "+tagObject.onbookingoverlimit+"(e);")(e):null;self.dispatchEvent("onBookingOverLimit",e)};this.onBookingTaken=function(data){var e={target:self,data:data};tagObject.onbookingtaken?new Function("e","return "+tagObject.onbookingtaken+"(e);")(e):null;self.dispatchEvent("onBookingTaken",e)};this.onBookingCancel=function(data){var e={target:self,data:data};tagObject.onbookingcancel?new Function("e","return "+tagObject.onbookingcancel+"(e);")(e):null;self.dispatchEvent("onBookingCancel",e)};var ownBookings=0;this.bookClickHandler=function(e){if(bookingLimit<=ownBookings){if(self.onBookingOverLimit){self.onBookingOverLimit({limit:bookingLimit,booked:ownBookings})}}else{ownBookings++;self.bookSlot.call(self,e)}};this.cancelClickHandler=function(e){self.cancelBook.call(self,e);ownBookings--};this.returnFalseClickHandler=function(){return false};for(var item in this.bookingSlots){Events.Manager.addEventListener(this.bookingSlots[item],"click",this.bookClickHandler)}var xhrData={action:"get",userid:this.userId};var xhr=new xRTML.Common.xhr("post",this.handlerUrl,function(ret){if(this.readyState==4&&this.status==200){var response=JSON.parse(ret.xhr.responseText);var data=[];for(var itr in response){self.markSlot(response[itr]);var slot={slot:response[itr].slot,user:response[itr].userid==self.userId};if(response[itr].userid==self.userId){ownBookings++}data.push(slot)}if(self.onDataLoad){self.onDataLoad(data)}}});if(self.onDataPreLoad){self.onDataPreLoad()}xhr.send(JSON.stringify(xhrData))};xRTML.Tags.Booking.prototype.bookSlot=function(e){var self=this;var element=(e.srcElement)?e.srcElement:e.currentTarget;element.className=this.cssDefault+" "+this.cssWaiting;var data={action:"save",userid:this.userId,slot:element.getAttribute("data-slot")};var action="book";var xhr=new xRTML.Common.xhr("post",this.handlerUrl,function(ret){if(this.readyState==4&&this.status==200){var response=JSON.parse(ret.xhr.responseText);if(response.result=="saved"){var dataString=JSON.stringify(data);for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,action,dataString,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}}else{if(self.onBookingTaken){self.onBookingTaken({slot:element.getAttribute("data-slot")})}}}});xhr.send(JSON.stringify(data))};xRTML.Tags.Booking.prototype.cancelBook=function(e){var self=this;var element=(e.srcElement)?e.srcElement:e.currentTarget;element.className=this.cssDefault+" "+this.cssWaiting;var data={action:"cancel",userid:self.userId,slot:element.getAttribute("data-slot")};var xhr=new xRTML.Common.xhr("post",this.handlerUrl,function(ret){if(this.readyState==4&&this.status==200){var response=JSON.parse(ret.xhr.responseText);var data={action:"cancel",slot:element.getAttribute("data-slot"),userid:self.userId};var dataString=JSON.stringify(data);var action="cancelSlot";for(var iter=0;iter<self.triggers.length;iter++){var xrtmlMessage=xRTML.createMessage(self.triggers[iter].name,action,dataString,self.internalId);xRTML.sendMessage(self.channelId,xrtmlMessage)}Events.Manager.removeEventListener(element,"click",this.cancelClickHandler)}});xhr.send(JSON.stringify(data))};xRTML.Tags.Booking.prototype.markSlot=function(slot){var elem=Sizzle("*[data-slot="+slot.slot+"]")[0];Events.Manager.removeEventListener(elem,"click",this.bookClickHandler);if(slot.userid!=this.userId){elem.className=this.cssDefault+" "+this.cssBooked}else{elem.className=this.cssDefault+" "+this.cssBooked+" "+this.cssOwn;Events.Manager.addEventListener(elem,"click",this.cancelClickHandler)}};xRTML.Tags.Booking.prototype.book=function(message){this.markSlot(message.data);if(this.onBookingSuccess){this.onBookingSuccess({slot:message.data.slot,user:message.data.userid==this.userId})}};xRTML.Tags.Booking.prototype.cancelSlot=function(message){var elem=Sizzle("*[data-slot="+message.data.slot+"]")[0];Events.Manager.addEventListener(elem,"click",this.bookClickHandler);elem.className=this.cssDefault;if(this.onBookingCancel){this.onBookingCancel({slot:message.data.slot,user:message.data.userid==this.userId})}};xRTML.Tags.BrowserControl=xRTML.Tag.makeSubclass();xRTML.registerTag("BrowserControl");xRTML.Tags.BrowserControl.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);if(!this.channelId){xRTML.ErrorHandler().tagError(new Error("A connectionid attribute is required for BrowserControl."))}var generateControls=xRTML.Common.Converter.toBoolean(tagObject.generatecontrols);if(generateControls){this.generateControls=generateControls}else{this.generateControls=false;this.elements={};for(var element in tagObject.elements){this.elements[tagObject.elements[element].key]=tagObject.elements[element].value}}if(this.generateControls){xRTML.Common.Validator.validateRequired(this.target,true,"A target is required when generate controls is set to 'true'.");if(tagObject.target){this.target=Sizzle(tagObject.target);if(this.target.length>0){this.targetElement=this.target[0]}}xRTML.Common.Validator.validateRequired(this.targetElement,true,"The attribute target on a browser control tag contains an invalid selector or the target attribute is not present.")}xRTML.Common.Validator.validateRequired(tagObject.role,true,"A role attribute is required for BrowserControl.");this.role=tagObject.role;if(this.role=="sender"){if(this.generateControls){this.generateSenderHTML();xRTML.Console.debug("Browser Controls generated")}var self=this;if(self.elements){if(self.elements.reloadbutton){this.reloadbutton=Sizzle(self.elements.reloadbutton)[0];Events.Manager.addEventListener(this.reloadbutton,"click",function(){self.refresh()})}if(self.elements.backbutton){this.backbutton=Sizzle(self.elements.backbutton)[0];Events.Manager.addEventListener(this.backbutton,"click",function(){self.goBack()})}if(self.elements.forwardbutton){this.forwardbutton=Sizzle(self.elements.forwardbutton)[0];Events.Manager.addEventListener(this.forwardbutton,"click",function(){self.goForward()})}if(self.elements.gotobutton){xRTML.Common.Validator.validateRequired(self.elements.urltextbox,true,"the attribute urltextbox must be defined");this.urlTextBox=Sizzle(self.elements.urltextbox)[0];this.gotobutton=Sizzle(self.elements.gotobutton)[0];Events.Manager.addEventListener(this.gotobutton,"click",function(){self.goTo(self.urlTextBox.value)})}}}};xRTML.Tags.BrowserControl.prototype.sendMessage=function(action,href){var httpwo=/^[a-z0-9-\.]+\.[a-z]{2,4}\/?([^\s<>\#%"\,\{\}\\|\\\^\[\]`]+)?$/;if(href&&href.match(httpwo)){href="http://"+href}var message=xRTML.createMessage("",action,'{ "href" :"'+href+'"}',this.internalId);for(var iter=0;iter<this.triggers.length;iter++){message.trigger=this.triggers[iter].name;xRTML.sendMessage(this.channelId,message)}};xRTML.Tags.BrowserControl.prototype.reload=function(message){if(this.role=="receiver"){history.go(0)}};xRTML.Tags.BrowserControl.prototype.navigateBack=function(message){if(this.role=="receiver"){history.go(-1)}};xRTML.Tags.BrowserControl.prototype.navigateForward=function(message){if(this.role=="receiver"){history.go(1)}};xRTML.Tags.BrowserControl.prototype.navigateTo=function(message){if(this.role=="receiver"){location.href=message.data.href}};xRTML.Tags.BrowserControl.prototype.generateSenderHTML=function(){var that=this;this.divController=document.createElement("div");this.divController.id="browserController_container";this.btnReload=document.createElement("input");this.btnReload.type="button";this.btnReload.id="browserController_btnReload";this.btnReload.value="Reload";this.btnReload.onclick=function(){that.refresh()};this.btnHistoryBack=document.createElement("input");this.btnHistoryBack.type="button";this.btnHistoryBack.id="browserController_btnHistoryBack";this.btnHistoryBack.value="Back";this.btnHistoryBack.onclick=function(){that.goBack()};this.btnHistoryForward=this.btnHistoryBack.cloneNode(true);this.btnHistoryForward.id="browserController_btnHistoryForward";this.btnHistoryForward.value="Forward";this.btnHistoryForward.onclick=function(){that.goForward()};this.txtUrl=document.createElement("input");this.txtUrl.type="text";this.txtUrl.id="browserController_urlTextBox";this.btnNavigate=document.createElement("input");this.btnNavigate.type="button";this.btnNavigate.id="browserController_navigateTo";this.btnNavigate.value="Navigate";this.btnNavigate.cssClass="browserController_button";this.btnNavigate.onclick=function(){var href=document.getElementById(that.txtUrl.id).value;that.goTo(href)};this.divController.appendChild(this.btnReload);this.divController.appendChild(this.btnHistoryBack);this.divController.appendChild(this.btnHistoryForward);this.divController.appendChild(this.txtUrl);this.divController.appendChild(this.btnNavigate);this.divController.setAttribute("id","browserController_container");this.targetElement.appendChild(this.divController)};xRTML.Tags.BrowserControl.prototype.goTo=function(href){this.sendMessage("navigateTo",href)};xRTML.Tags.BrowserControl.prototype.goBack=function(){this.sendMessage("navigateBack")};xRTML.Tags.BrowserControl.prototype.goForward=function(){this.sendMessage("navigateForward")};xRTML.Tags.BrowserControl.prototype.refresh=function(){this.sendMessage("reload")};xRTML.Tags.AsynchronousHandler=xRTML.Tags.Execute.makeSubclass();xRTML.registerTag("AsynchronousHandler");xRTML.Tags.AsynchronousHandler.prototype.init=function(tagObject){xRTML.Tags.Execute.prototype.init.call(this,tagObject);var handlers=new Array();if(tagObject.handlers&&tagObject.handlers.length){for(var i=0;i<tagObject.handlers.length;++i){handlers.push({target:tagObject.handlers[i].target,event:tagObject.handlers[i].event,callback:tagObject.handlers[i].callback})}}this.process=function(message){if(message&&message.action){if(this[message.action]&&typeof(this[message.action])==="function"){this[message.action].call(this,menssage)}else{return}}var self=this;var sendResponse=function(response){var ret={requestId:message.data.requestId,response:response};xRTML.sendMessage(self.channelId,xRTML.createMessage(message.trigger,"AsynchronousResponse",ret,self.internalId))};var callbackRet=(this.callback)?this.delegate(message.data.request):undefined;if(handlers.length>0){for(var i=0;i<handlers.length;++i){var callback=handlers[i].callback;var target=Sizzle(handlers[i].target)[0];var event=handlers[i].event;xRTML.Console.debug("Target: "+handlers[i].target+"; Event: "+handlers[i].event+"; Callback; "+callback);var fnHandler=function(e){var fn=new Function("e","return "+callback+"(e);");sendResponse(fn(e));Events.Manager.removeEventListener(target,event,fnHandler)};Events.Manager.addEventListener(target,event,fnHandler)}}else{sendResponse(callbackRet)}}};xRTML.Tags.AsynchronousRequest=xRTML.Tag.makeSubclass();xRTML.registerTag("AsynchronousRequest");xRTML.Tags.AsynchronousRequest.prototype.init=function(tagObject){xRTML.Tag.prototype.init.call(this,tagObject);var self=this;var requestInProcess=new Object();var dispatcherElements=tagObject.dispatchers;for(var i=0;i<dispatcherElements.length;++i){xRTML.Console.debug("Create dispatcher["+i+"]");var dispatcher=new xRTML.Tags.AsynchronousRequest.Dispatcher(dispatcherElements[i],this);var DispatchMessages=function(){var requestId=xRTML.Common.Util.guidGenerator();if(dispatcher.requestcallback){var fn=new Function("requestId","return "+dispatcher.requestcallback+"(requestId);");var request=fn(requestId);request={requestId:requestId,request:request};requestInProcess[requestId]={callback:dispatcher.responseCallback,expectedresponses:dispatcher.expectedresponses};for(var i=0;i<self.triggers.length;i++){var message=xRTML.createMessage(self.triggers[i].name,null,request,self.internalId);xRTML.sendMessage(self.channelId,message,self.internalId)}setTimeout(function(){if(requestInProcess[requestId]){delete requestInProcess[requestId]}},dispatcher.timeout)}};if(dispatcher.target&&dispatcher.event){var targetElement=Sizzle(dispatcher.target)[0];Events.Manager.addEventListener(targetElement,dispatcher.event,function(){DispatchMessages()})}else{DispatchMessages()}}this.AsynchronousResponse=function(message){if(requestInProcess[message.data.requestId]){var fn=new Function("data","return "+requestInProcess[message.data.requestId].callback+"(data);");fn(message.data.response);requestInProcess[message.data.requestId].expectedresponses=requestInProcess[message.data.requestId].expectedresponses-1;if(requestInProcess[message.data.requestId].expectedresponses==0){delete requestInProcess[message.data.requestId]}}}};xRTML.Tags.AsynchronousRequest.Dispatcher=function(dispatcherElement,parent){this.target=dispatcherElement.target;this.event=dispatcherElement.event;this.requestcallback=dispatcherElement.requestcallback;this.responseCallback=dispatcherElement.responsecallback;if(dispatcherElement.timeout){this.timeout=xRTML.Common.Converter.toNumber(dispatcherElement.timeout)}else{this.timeout=60000}if(dispatcherElement.expectedresponses){this.expectedresponses=xRTML.Common.Converter.toNumber(dispatcherElement.expectedresponses)}else{this.expectedresponses=-1}};xRTML.Tags.AsynchronousRequest.Dispatcher.prototype={constructor:xRTML.Tags.AsynchronousRequest.Dispatcher};